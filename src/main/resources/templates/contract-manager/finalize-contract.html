<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}">
<head>
    <meta charset="UTF-8">
    <title>å®šç¨¿åˆåŒ - <span th:text="${contract?.contractName ?: 'åˆåŒè¯¦æƒ…'}"></span></title>
    <style layout:fragment="inline-css">
        .contract-details-section {
            margin-bottom: 1.5rem;
        }
        .contract-content-display, .contract-content-edit textarea {
            background-color: #f8f9fa;
            border: 1px solid #e3e6ea;
            padding: 1rem 1.25rem;
            border-radius: 0.375rem;
            min-height: 150px;
            white-space: pre-wrap;
            font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            line-height: 1.6;
            overflow-x: auto;
        }
        .contract-content-edit textarea {
            width: 100%;
        }
        .attachment-link i {
            margin-right: 0.3rem;
        }
        .form-actions {
            border-top: 1px solid #e9ecef;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .sticky-lg-top {
            top: calc(56px + 1.5rem);
        }
        .dl-horizontal dt {
            font-weight: 500;
        }
        .countersign-opinions-card .card-body {
            max-height: 300px;
            overflow-y: auto;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }
        .file-info {
            flex-grow: 1;
            margin-right: 1rem;
            overflow: hidden;
        }
        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .file-size, .file-status {
            font-size: 0.8em;
            color: #6c757d;
        }
        .file-actions button {
            margin-left: 0.5rem;
        }
        .file-progress {
            height: 10px;
            margin-top: 0.25rem;
            background-color: #e9ecef;
            border-radius: .25rem;
            overflow: hidden;
        }
        .file-progress-bar {
            background-color: #0d6efd;
            height: 100%;
            transition: width 0.2s ease-in-out;
            color: white;
            font-size: 0.7em;
            line-height:10px;
            text-align: center;
        }
        .file-list-item.upload-error {
            border-left: 5px solid var(--bs-danger);
            background-color: #fbe9e7;
        }
        .file-list-item.upload-success {
            border-left: 5px solid var(--bs-success);
            background-color: #e8f5e9;
        }
        .file-list-item.upload-need_file {
            border-left: 5px solid var(--bs-warning);
            background-color: #fff3cd;
            animation: pulse-warning 2s infinite;
        }
        @keyframes pulse-warning {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }
        
        /* é¢„è§ˆåŠŸèƒ½çš„æ ·å¼å¢å¼º */
        .modal-dialog-centered {
            max-width: 90vw;
        }
        .modal-body img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .modal-body video, .modal-body audio {
            max-width: 100%;
            border-radius: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .preview-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6c757d;
        }
        .preview-error {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 0.25rem;
            padding: 2rem;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>

<section layout:fragment="content">
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-file-earmark-check-fill text-success me-2"></i>å®šç¨¿åˆåŒ:
                <span th:if="${contract != null}" th:text="${contract.contractName ?: 'æœªçŸ¥åˆåŒ'}" class="text-primary"></span>
                <span th:if="${contract == null}" class="text-muted">åŠ è½½ä¸­...</span>
            </h1>
            <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left-circle"></i> è¿”å›å¾…å®šç¨¿åˆ—è¡¨
            </a>
        </div>

        <div id="globalAlertContainer"></div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${contract == null}" class="alert alert-warning text-center py-4" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-octagon-fill me-2"></i>æ— æ³•åŠ è½½åˆåŒä¿¡æ¯</h5>
            <p class="mb-0">æœªèƒ½åŠ è½½åˆåŒè¯¦ç»†ä¿¡æ¯ï¼Œæˆ–æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åˆåŒè¿›è¡Œå®šç¨¿æ“ä½œã€‚</p>
            <hr>
            <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-primary btn-sm">è¿”å›åˆ—è¡¨</a>
        </div>

        <form th:if="${contract != null}" th:action="@{/contract-manager/finalize/{contractId}(contractId=${contract.id})}"
              method="post" id="finalizeForm" th:object="${contractDraftRequest}">

            <div id="hiddenAttachmentInputsContainerFinalize"></div>

            <div class="row g-4">
                <div class="col-lg-7 col-xl-8">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <i class="bi bi-info-circle-fill me-2"></i>åˆåŒåŸºæœ¬ä¿¡æ¯
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">åˆåŒç¼–å·</label>
                                <div class="form-control form-control-sm bg-light" th:text="${contract.contractNumber ?: '-'}"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">åˆåŒåç§°</label>
                                <div class="form-control form-control-sm bg-light" th:text="${contract.contractName ?: '-'}"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                    <div class="form-control form-control-sm bg-light" th:text="${contract.startDate != null ? #temporals.format(contract.startDate, 'yyyy-MM-dd') : '-'}"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                                    <div class="form-control form-control-sm bg-light" th:text="${contract.endDate != null ? #temporals.format(contract.endDate, 'yyyy-MM-dd') : '-'}"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">åˆåŒçŠ¶æ€</label>
                                    <div class="form-control form-control-sm bg-light">
                                        <span th:if="${contract.status}"
                                              th:text="${contract.status.description}"
                                              class="status-badge"
                                              th:classappend="'status-' + ${contract.status.name()}"></span>
                                        <span th:unless="${contract.status != null}" class="text-muted">æœªçŸ¥çŠ¶æ€</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">èµ·è‰äºº</label>
                                    <div class="form-control form-control-sm bg-light" th:text="${contract.drafter?.username ?: '-'}"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-light">
                            <i class="bi bi-person-badge-fill me-2"></i>å®¢æˆ·ä¿¡æ¯
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">ç­¾çº¦å®¢æˆ·</label>
                                <div class="form-control form-control-sm bg-light" th:text="${contract.customer?.customerName ?: '-'}"></div>
                            </div>
                            <div class="card mt-2" th:if="${contract.customer != null}">
                                <div class="card-body p-2">
                                    <h6 class="card-title mb-1 small"><strong th:text="${contract.customer?.customerName ?: '-'}"></strong></h6>
                                    <p class="card-text mb-0 small">
                                        <strong>ç¼–å·:</strong> <span th:text="${contract.customer?.customerNumber ?: '-'}"></span> <br>
                                        <strong>ç”µè¯:</strong> <span th:text="${contract.customer?.phoneNumber ?: '-'}"></span> <br>
                                        <strong>é‚®ç®±:</strong> <span th:text="${contract.customer?.email ?: '-'}"></span> <br>
                                        <strong>åœ°å€:</strong> <span th:text="${contract.customer?.address ?: '-'}"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm contract-details-section countersign-opinions-card" th:if="${countersignOpinions != null and not #lists.isEmpty(countersignOpinions)}">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-chat-left-text-fill me-2 text-info"></i>ä¼šç­¾æ„è§æ±‡æ€»</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" th:each="opinion : ${countersignOpinions}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: 'åŒ¿åç”¨æˆ·'}"></h6>
                                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : 'æœªå¤„ç†'}"></small>
                                    </div>
                                    <p class="mb-1" th:text="${opinion.comments ?: '(æ— å…·ä½“æ„è§)'}"></p>
                                    <small th:text="${opinion.state?.description ?: 'æœªçŸ¥çŠ¶æ€'}"
                                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                                    </small>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card shadow-sm contract-details-section countersign-opinions-card" th:if="${allFinalizeProcesses != null and not #lists.isEmpty(allFinalizeProcesses)}">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2 text-primary"></i>å®šç¨¿æ„è§æ±‡æ€»</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" th:each="opinion : ${allFinalizeProcesses}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: 'åŒ¿åç”¨æˆ·'}"></h6>
                                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : 'æœªå¤„ç†'}"></small>
                                    </div>
                                    <p class="mb-1" th:text="${opinion.comments != null and !opinion.comments.isEmpty() ? opinion.comments : '(æ— å…·ä½“æ„è§)'}"></p>
                                    <small th:text="${opinion.state?.description ?: 'æœªçŸ¥çŠ¶æ€'}"
                                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                                    </small>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card shadow-sm contract-details-section">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text-fill me-2"></i>åˆåŒå†…å®¹ä¸é™„ä»¶</h5>
                        </div>
                        <div class="card-body">
                            <h6>åˆåŒæ­£æ–‡å†…å®¹ (å¯ç¼–è¾‘):</h6>
                            <div class="contract-content-edit mb-3">
                                <textarea class="form-control form-control-sm" id="updatedContent"
                                          th:field="*{updatedContent}" rows="15"
                                          placeholder="è¯·åœ¨æ­¤å¤„å¡«å†™æˆ–ä¿®æ”¹åˆåŒçš„æ ¸å¿ƒæ¡æ¬¾å’Œå†…å®¹..."></textarea>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label for="newAttachment" class="form-label">æ›¿æ¢æˆ–ä¸Šä¼ æ–°é™„ä»¶:</label>
                                <input type="file" class="form-control form-control-sm" id="newAttachment" multiple>
                                <div class="form-text small text-muted">å¦‚æœä¸Šä¼ æ–°é™„ä»¶ï¼Œå®ƒä»¬å°†æ ¹æ®æ‚¨çš„é€‰æ‹©è¢«æ·»åŠ æˆ–æ›¿æ¢ç°æœ‰é™„ä»¶ã€‚æ”¯æŒPDFã€å›¾ç‰‡(JPEG, PNG, GIF, BMP)ã€Wordæ–‡æ¡£(doc, docx)ã€‚</div>

                                <div id="fileListContainerFinalize" class="mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 col-xl-4">
                    <div class="card shadow-sm sticky-lg-top">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>æ‰§è¡Œå®šç¨¿æ“ä½œ</h5>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">
                                è¯·ä»”ç»†å®¡é˜…åˆåŒä¿¡æ¯ã€‚ä¸€æ—¦ç¡®è®¤å®šç¨¿ï¼ŒåˆåŒå°†è¿›å…¥åç»­çš„å®¡æ‰¹æµç¨‹ï¼Œé€šå¸¸å®šç¨¿åçš„å†…å®¹å°†ä¸åº”å†åšå¤§çš„ä¿®æ”¹ã€‚
                            </p>
                            <div class="mb-3">
                                <label for="finalizationComments" class="form-label">å®šç¨¿æ„è§/å¤‡æ³¨:</label>
                                <textarea class="form-control form-control-sm" id="finalizationComments" name="finalizationComments" rows="5" placeholder="ï¼ˆå¯é€‰ï¼‰è¾“å…¥æ‚¨çš„å®šç¨¿æ„è§æˆ–é‡è¦å¤‡æ³¨..."></textarea>
                            </div>
                            <div class="form-actions text-end mt-4">
                                <button type="button" id="submitFinalizeBtn" class="btn btn-success btn-lg"
                                        sec:authorize="hasAuthority('CON_FINAL_SUBMIT')">
                                    <i class="bi bi-check-circle-fill"></i> ç¡®è®¤å®šç¨¿
                                </button>
                                <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-secondary ms-2">
                                    <i class="bi bi-x-circle"></i> å–æ¶ˆ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {

            // --- å…¨éƒ¨çš„JSé€»è¾‘ï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•çœç•¥ ---

            // ç­‰å¾…DOMå®Œå…¨åŠ è½½
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM å·²å®Œå…¨åŠ è½½');
            });

            const initialAttachmentsJsonString = /*[[${initialAttachmentsJson}]]*/ '[]';
            
            // å»¶è¿Ÿè·å–DOMå…ƒç´ ï¼Œç¡®ä¿é¡µé¢å·²åŠ è½½
            function getDOMElements() {
                return {
                    attachmentFilesInput: document.getElementById('newAttachment'),
                    fileListContainer: document.getElementById('fileListContainerFinalize'),
                    hiddenAttachmentInputsContainer: document.getElementById('hiddenAttachmentInputsContainerFinalize'),
                    mainForm: document.getElementById('finalizeForm'),
                    submitBtn: document.getElementById('submitFinalizeBtn')
                };
            }
            
            const elements = getDOMElements();
            const attachmentFilesInput = elements.attachmentFilesInput;
            const fileListContainer = elements.fileListContainer;
            const hiddenAttachmentInputsContainer = elements.hiddenAttachmentInputsContainer;
            const mainForm = elements.mainForm;
            const submitBtn = elements.submitBtn;
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('DOMå…ƒç´ æ£€æŸ¥:');
            console.log('attachmentFilesInput:', attachmentFilesInput);
            console.log('fileListContainer:', fileListContainer);
            console.log('hiddenAttachmentInputsContainer:', hiddenAttachmentInputsContainer);
            console.log('mainForm:', mainForm);
            console.log('submitBtn:', submitBtn);
            const CHUNK_SIZE = 1024 * 1024 * 2;
            let uploadedFilesData = [];

            function showAlert(message, type = 'info', containerId = 'globalAlertContainer') {
                const alertContainer = document.getElementById(containerId);
                if (alertContainer) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-top: 10px;">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                    alertContainer.prepend(wrapper.firstChild);
                } else {
                    alert(`${type.toUpperCase()}: ${message}`);
                }
            }

            // ===================================================================
            // ========= æäº¤æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨ (AJAXæ–¹å¼) =========
            // ===================================================================
            if (submitBtn) {
                submitBtn.addEventListener('click', async function(event) {
                    event.preventDefault();

                    prepareAttachmentsForSubmission();

                    if (!confirm("æ‚¨ç¡®å®šè¦å°†æ­¤åˆåŒå®šç¨¿å¹¶æäº¤è¿›å…¥ä¸‹ä¸€æµç¨‹å—ï¼Ÿ")) {
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æäº¤ä¸­...';

                    const finalizationComments = document.getElementById('finalizationComments').value;
                    const updatedContent = document.getElementById('updatedContent').value;
                    const attachmentServerFileNames = Array.from(hiddenAttachmentInputsContainer.querySelectorAll('input[name="attachmentServerFileNames"]')).map(input => input.value);

                    const payload = {
                        finalizationComments,
                        updatedContent,
                        attachmentServerFileNames
                    };

                    try {
                        const response = await fetch(mainForm.action, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showAlert('æ“ä½œæˆåŠŸï¼š' + (result.message || 'åˆåŒå·²å®šç¨¿'), 'success');
                            setTimeout(() => {
                                window.location.href = '/contract-manager/pending-finalization';
                            }, 1500);
                        } else {
                            throw new Error(result.message || 'æäº¤å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯ã€‚');
                        }
                    } catch (error) {
                        console.error('å®šç¨¿æäº¤å¤±è´¥:', error);
                        showAlert('æäº¤å¤±è´¥: ' + error.message, 'danger');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-check-circle-fill"></i> ç¡®è®¤å®šç¨¿';
                    }
                });
            }


            // ===================================================================
            // ===== é™„ä»¶åˆå§‹åŒ–ã€ä¸Šä¼ ã€é¢„è§ˆã€åˆ é™¤çš„æ‰€æœ‰JSå‡½æ•° =====
            // ===================================================================

            // ===== ä¸Šä¼ ç›¸å…³çš„å…¨å±€å˜é‡ =====
            let fileUploadQueue = [];
            let isUploading = false;
            const STORAGE_KEY = 'contractFinalize_uploadState';
            const STORAGE_EXPIRY_HOURS = 24;

            // --- å…³é”®çš„åˆå§‹åŒ–ä»£ç ï¼Œä¹‹å‰è¢«æˆ‘é—æ¼ ---
            let initialServerFileNames = [];
            if (initialAttachmentsJsonString && initialAttachmentsJsonString !== '[]' && initialAttachmentsJsonString !== 'null') {
                try {
                    initialServerFileNames = JSON.parse(initialAttachmentsJsonString);
                } catch (e) {
                    console.error("è§£æåˆå§‹é™„ä»¶JSONå¤±è´¥:", e);
                }
            }

            initialServerFileNames.forEach(serverFileName => {
                const existingFileEntry = {
                    id: `existing-${serverFileName.replace(/[^a-zA-Z0-9]/g, "_")}-${Date.now()}`,
                    file: null, // æ”¹ä¸ºfileå­—æ®µä»¥ä¸èµ·è‰åˆåŒä¿æŒä¸€è‡´
                    status: 'completed',
                    progress: 100, 
                    uploadId: null, 
                    serverFileName: serverFileName,
                    isExisting: true
                };
                uploadedFilesData.push(existingFileEntry);
                
                // æ£€æŸ¥fileListContaineræ˜¯å¦å­˜åœ¨åå†è°ƒç”¨addFileToUI
                if (fileListContainer) {
                    addFileToUI(existingFileEntry);
                } else {
                    console.error('fileListContainerä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ ç°æœ‰æ–‡ä»¶åˆ°UI:', serverFileName);
                }
            });
            prepareAttachmentsForSubmission();
            // --- åˆå§‹åŒ–ä»£ç ç»“æŸ ---


            if (attachmentFilesInput) {
                attachmentFilesInput.addEventListener('change', handleFileSelection);
            }

            function addFileToUI(fileEntry) {
                // æ£€æŸ¥fileListContaineræ˜¯å¦å­˜åœ¨
                if (!fileListContainer) {
                    console.error('fileListContaineræœªæ‰¾åˆ°ï¼Œæ— æ³•æ·»åŠ æ–‡ä»¶åˆ°UI');
                    return;
                }
                
                // ä½¿ç”¨æ›´å®‰å…¨çš„IDç”Ÿæˆæ–¹å¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦
                const safeFileEntryId = fileEntry.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                const fileName = fileEntry.file ? fileEntry.file.name : (fileEntry.serverFileName || 'Unknown File');
                const fileSize = fileEntry.file ? fileEntry.file.size : 0;
                const fileSizeFormatted = fileSize ? formatFileSize(fileSize) : ' (å·²å­˜åœ¨)';
                const initialProgress = fileEntry.status === 'completed' ? 100 : (fileEntry.progress || 0);
                const initialStatusMessage = fileEntry.status === 'completed' ? 'å·²ä¸Šä¼ ' : 'ç­‰å¾…ä¸Šä¼ ...';
                const progressBarDisplay = (fileEntry.status === 'completed' && fileEntry.isExisting) || fileEntry.status === 'completed' ? 'none' : 'block';
                const previewButtonDisplay = fileEntry.status === 'completed' ? 'inline-block' : 'none';

                const retryButtonDisplay = (fileEntry.status === 'error' || fileEntry.status === 'need_file') ? 'inline-block' : 'none';
                const retryButtonText = fileEntry.status === 'need_file' ? 'ğŸ”„ é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ ' : 'é‡è¯•';
                const retryButtonClass = fileEntry.status === 'need_file' ? 'btn-primary' : 'btn-warning';

                const fileItemHTML = `
                <div class="file-list-item ${fileEntry.status === 'completed' ? 'upload-success' : ''}" id="file-item-${safeFileEntryId}">
                    <div class="file-info">
                        <span class="file-name" title="${fileName}">${fileName}</span>
                        <span class="file-size">${fileSizeFormatted}</span>
                        <div class="file-progress mt-1" style="display: ${progressBarDisplay};">
                            <div class="file-progress-bar" style="width: ${initialProgress}%;">${initialProgress}%</div>
                        </div>
                        <small class="file-status d-block mt-1 ${fileEntry.status === 'completed' ? 'text-success' : 'text-muted'}">${initialStatusMessage}</small>
                    </div>
                    <div class="file-actions">
                        <button type="button" class="btn btn-sm btn-outline-info preview-btn" style="display: ${previewButtonDisplay};" title="é¢„è§ˆæ–‡ä»¶ - æ”¯æŒå›¾ç‰‡ã€PDFã€æ–‡æœ¬ã€éŸ³è§†é¢‘ç­‰æ ¼å¼">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm ${retryButtonClass} retry-btn" style="display: ${retryButtonDisplay};" title="é‡è¯•ä¸Šä¼ ">
                            ${retryButtonText}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-btn" title="åˆ é™¤">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>`;

                fileListContainer.insertAdjacentHTML('beforeend', fileItemHTML);
                fileEntry.uiElement = fileListContainer.querySelector(`#file-item-${safeFileEntryId}`);

                if (!fileEntry.uiElement) {
                    console.error(`æ— æ³•æ‰¾åˆ°æ–‡ä»¶UIå…ƒç´ : #file-item-${safeFileEntryId}`);
                    return;
                }

                fileEntry.uiElement.querySelector('.delete-btn').addEventListener('click', () => handleDeleteFile(fileEntry.id));
                fileEntry.uiElement.querySelector('.preview-btn').addEventListener('click', () => {
                    if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                        handlePreviewFile(fileEntry.serverFileName);
                    }
                });
                
                const retryBtn = fileEntry.uiElement.querySelector('.retry-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', () => retryUpload(fileEntry.id));
                }
            }

            function handlePreviewFile(serverFileName) {
                if (!serverFileName) return;
                
                const downloadUrl = `/api/attachments/download/${encodeURIComponent(serverFileName)}`;
                const fileExtension = serverFileName.toLowerCase().split('.').pop();
                
                // å®šä¹‰å„ç§æ–‡ä»¶ç±»å‹çš„é¢„è§ˆæ”¯æŒ
                const previewableInBrowser = {
                    // å›¾ç‰‡æ–‡ä»¶ - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
                    images: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'],
                    // PDFæ–‡ä»¶ - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
                    pdf: ['pdf'],
                    // æ–‡æœ¬æ–‡ä»¶ - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
                    text: ['txt', 'csv', 'log', 'md', 'json', 'xml', 'html', 'css', 'js'],
                    // éŸ³é¢‘æ–‡ä»¶ - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
                    audio: ['mp3', 'wav', 'ogg', 'aac', 'm4a'],
                    // è§†é¢‘æ–‡ä»¶ - æµè§ˆå™¨åŸç”Ÿæ”¯æŒ
                    video: ['mp4', 'webm', 'ogg', 'mov']
                };
                
                // éœ€è¦ä¸‹è½½çš„æ–‡ä»¶ç±»å‹
                const downloadOnly = {
                    office: ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'],
                    archives: ['zip', 'rar', '7z', 'tar', 'gz'],
                    others: ['exe', 'msi', 'dmg', 'deb', 'rpm']
                };
                
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                let canPreview = false;
                let fileCategory = '';
                
                for (const [category, extensions] of Object.entries(previewableInBrowser)) {
                    if (extensions.includes(fileExtension)) {
                        canPreview = true;
                        fileCategory = category;
                        break;
                    }
                }
                
                if (canPreview) {
                    // æµè§ˆå™¨æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ç›´æ¥æ‰“å¼€
                    if (fileCategory === 'images') {
                        // å›¾ç‰‡æ–‡ä»¶ - åˆ›å»ºæ›´å¥½çš„é¢„è§ˆä½“éªŒ
                        openImagePreview(downloadUrl, serverFileName);
                    } else if (fileCategory === 'pdf') {
                        // PDFæ–‡ä»¶ - æä¾›é€‰æ‹©ï¼šåœ¨çº¿é¢„è§ˆæˆ–ä¸‹è½½
                        const userChoice = confirm(
                            `PDFæ–‡ä»¶ "${serverFileName}" é¢„è§ˆé€‰é¡¹ï¼š\n\n` +
                            `ç‚¹å‡»"ç¡®å®š"åœ¨æ–°çª—å£é¢„è§ˆPDF\n` +
                            `ç‚¹å‡»"å–æ¶ˆ"ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹`
                        );
                        
                        if (userChoice) {
                            window.open(downloadUrl, '_blank');
                        } else {
                            downloadFile(downloadUrl, serverFileName);
                        }
                    } else if (fileCategory === 'text') {
                        // æ–‡æœ¬æ–‡ä»¶ - ç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€
                        window.open(downloadUrl, '_blank');
                    } else if (fileCategory === 'audio' || fileCategory === 'video') {
                        // éŸ³è§†é¢‘æ–‡ä»¶ - åˆ›å»ºåª’ä½“é¢„è§ˆ
                        openMediaPreview(downloadUrl, serverFileName, fileCategory);
                    }
                } else {
                    // ä¸æ”¯æŒé¢„è§ˆçš„æ–‡ä»¶ï¼Œæç¤ºç”¨æˆ·ä¸‹è½½
                    let downloadReason = '';
                    
                    if (downloadOnly.office.includes(fileExtension)) {
                        downloadReason = 'Officeæ–‡æ¡£éœ€è¦ä½¿ç”¨ç›¸åº”çš„åŠå…¬è½¯ä»¶æ‰“å¼€';
                    } else if (downloadOnly.archives.includes(fileExtension)) {
                        downloadReason = 'å‹ç¼©åŒ…æ–‡ä»¶éœ€è¦è§£å‹ç¼©è½¯ä»¶æ‰“å¼€';
                    } else {
                        downloadReason = 'æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒåœ¨æµè§ˆå™¨ä¸­ç›´æ¥é¢„è§ˆ';
                    }
                    
                    const userConfirmed = confirm(
                        `æ–‡ä»¶ "${serverFileName}" ${downloadReason}ã€‚\n\nç‚¹å‡»"ç¡®å®š"ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°æŸ¥çœ‹ï¼Œç‚¹å‡»"å–æ¶ˆ"å…³é—­æ­¤å¯¹è¯æ¡†ã€‚`
                    );

                    if (userConfirmed) {
                        downloadFile(downloadUrl, serverFileName);
                    }
                }
            }
            
            // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            function openImagePreview(imageUrl, fileName) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">å›¾ç‰‡é¢„è§ˆ: ${fileName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                                                         <div class="modal-body text-center">
                                 <div class="preview-loading" id="imageLoading">
                                     <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                     æ­£åœ¨åŠ è½½å›¾ç‰‡...
                                 </div>
                                 <img src="${imageUrl}" class="img-fluid" style="max-height: 70vh; display: none;" alt="${fileName}" 
                                      onload="this.style.display='block'; document.getElementById('imageLoading').style.display='none';"
                                      onerror="this.onerror=null; this.style.display='none'; document.getElementById('imageLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="alert alert-warning mt-3" style="display: none;">
                                     <i class="bi bi-exclamation-triangle"></i> å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½åæŸ¥çœ‹
                                 </div>
                             </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">å¿«æ·é”®: ESC-å…³é—­, D-ä¸‹è½½</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFile('${imageUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </button>
                                <button type="button" class="btn btn-info" onclick="window.open('${imageUrl}', '_blank')">
                                    <i class="bi bi-box-arrow-up-right"></i> æ–°çª—å£æ‰“å¼€
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // æ¨¡æ€æ¡†å…³é—­åç§»é™¤DOMå…ƒç´ 
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFile(imageUrl, fileName);
                    }
                });
            }
            
            // åª’ä½“æ–‡ä»¶ï¼ˆéŸ³é¢‘/è§†é¢‘ï¼‰é¢„è§ˆåŠŸèƒ½
            function openMediaPreview(mediaUrl, fileName, mediaType) {
                const isVideo = mediaType === 'video';
                const mediaTag = isVideo ? 'video' : 'audio';
                const mediaControls = isVideo ? 'controls width="100%" height="400"' : 'controls width="100%"';
                
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-${isVideo ? 'camera-video' : 'music-note'}"></i> 
                                    ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}é¢„è§ˆ: ${fileName}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                                                         <div class="modal-body text-center">
                                 <div class="preview-loading" id="mediaLoading">
                                     <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                     æ­£åœ¨åŠ è½½${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}...
                                 </div>
                                 <${mediaTag} ${mediaControls} preload="metadata" style="display: none;"
                                         onloadedmetadata="this.style.display='block'; document.getElementById('mediaLoading').style.display='none';"
                                         onerror="this.onerror=null; this.style.display='none'; document.getElementById('mediaLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                     <source src="${mediaUrl}" type="${mediaType}/${fileName.split('.').pop()}">
                                     æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}æ’­æ”¾ã€‚
                                 </${mediaTag}>
                                 <div class="alert alert-warning mt-3" style="display: none;">
                                     <i class="bi bi-exclamation-triangle"></i> ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½åæŸ¥çœ‹
                                 </div>
                             </div>
                                                         <div class="modal-footer">
                                <small class="text-muted me-auto">å¿«æ·é”®: ESC-å…³é—­, D-ä¸‹è½½, ç©ºæ ¼-æ’­æ”¾/æš‚åœ</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFile('${mediaUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </button>
                                <button type="button" class="btn btn-info" onclick="window.open('${mediaUrl}', '_blank')">
                                    <i class="bi bi-box-arrow-up-right"></i> æ–°çª—å£æ‰“å¼€
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // æ¨¡æ€æ¡†å…³é—­åç§»é™¤DOMå…ƒç´ 
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFile(mediaUrl, fileName);
                    } else if (e.key === ' ') {
                        // ç©ºæ ¼é”®æš‚åœ/æ’­æ”¾åª’ä½“
                        e.preventDefault();
                        const mediaElement = modal.querySelector('video, audio');
                        if (mediaElement) {
                            if (mediaElement.paused) {
                                mediaElement.play();
                            } else {
                                mediaElement.pause();
                            }
                        }
                    }
                });
            }
            
            // é€šç”¨ä¸‹è½½åŠŸèƒ½
            function downloadFile(fileUrl, fileName) {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // æ˜¾ç¤ºä¸‹è½½æç¤º
                showAlert(`æ–‡ä»¶ "${fileName}" å¼€å§‹ä¸‹è½½ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½è¿›åº¦ã€‚`, 'info', 3000);
            }

            function prepareAttachmentsForSubmission() {
                if (hiddenAttachmentInputsContainer) {
                    hiddenAttachmentInputsContainer.innerHTML = '';
                    uploadedFilesData.forEach(fileEntry => {
                        if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'attachmentServerFileNames';
                            hiddenInput.value = fileEntry.serverFileName;
                            hiddenAttachmentInputsContainer.appendChild(hiddenInput);
                        }
                    });
                }
            }

            async function handleDeleteFile(fileIdToDelete) {
                const fileIndex = uploadedFilesData.findIndex(f => f.id === fileIdToDelete);
                if (fileIndex === -1) return;
                const fileEntry = uploadedFilesData[fileIndex];

                if (fileEntry.uiElement) fileEntry.uiElement.remove();
                uploadedFilesData.splice(fileIndex, 1);

                if ((fileEntry.status === 'completed' || fileEntry.isExisting) && fileEntry.serverFileName) {
                    try {
                        const response = await fetch(`/api/attachments/file/${encodeURIComponent(fileEntry.serverFileName)}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            throw new Error(`æœåŠ¡å™¨åˆ é™¤å¤±è´¥`);
                        }
                        showAlert(`é™„ä»¶ "${fileEntry.file ? fileEntry.file.name : fileEntry.serverFileName}" å·²æˆåŠŸä»æœåŠ¡å™¨åˆ é™¤ã€‚`, 'info');
                    } catch (error) {
                        showAlert(`åˆ é™¤æœåŠ¡å™¨é™„ä»¶ "${fileEntry.file ? fileEntry.file.name : fileEntry.serverFileName}" å¤±è´¥: ${error.message}`, 'warning');
                    }
                }

                prepareAttachmentsForSubmission();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = 2;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function handleFileSelection(event) {
                const files = event.target.files;
                console.log(`ç”¨æˆ·é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`);
                if (files.length === 0) return;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = file.name.toLowerCase();
                    
                    // æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆä½¿ç”¨ä¸èµ·è‰åˆåŒç›¸åŒçš„é€»è¾‘ï¼‰
                    const allowedMimeTypes = [
                        // Office æ–‡æ¡£
                        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
                        'application/msword', // .doc
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                        'application/vnd.ms-excel', // .xls
                        'application/vnd.openxmlformats-officedocument.presentationml.presentation', // .pptx
                        'application/vnd.ms-powerpoint', // .ppt
                        // PDF
                        'application/pdf',
                        // å›¾ç‰‡
                        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp', 'image/webp',
                        // å‹ç¼©åŒ…å’Œå¤šåª’ä½“ï¼ˆå¤§æ–‡ä»¶ï¼‰
                        'application/zip', 'application/x-zip-compressed', 'application/x-rar-compressed', 'application/x-7z-compressed',
                        'video/mp4', 'video/avi', 'video/mkv', 'video/mov', 'video/wmv',
                        'audio/mp3', 'audio/wav', 'audio/flac', 'audio/aac',
                        // æ–‡æœ¬æ–‡ä»¶
                        'text/plain', 'text/csv',
                        // å…¶ä»–å¸¸è§ç±»å‹
                        'application/octet-stream' // é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
                    ];
                    
                    const allowedExtensions = [
                        'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'pdf',
                        'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp',
                        'zip', 'rar', '7z', 'tar', 'gz',
                        'mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv',
                        'mp3', 'wav', 'flac', 'aac', 'ogg',
                        'txt', 'csv'
                    ];

                    const isAllowedByMimeType = allowedMimeTypes.includes(file.type);
                    const fileExtension = fileName.split('.').pop();
                    const isAllowedByExtension = allowedExtensions.includes(fileExtension);

                    // æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šå¤§å°é™åˆ¶
                    let maxSize;
                    if (['zip', 'rar', '7z', 'tar', 'gz', 'mp4', 'avi', 'mkv', 'mov', 'wmv', 'flv', 'mp3', 'wav', 'flac', 'aac', 'ogg'].includes(fileExtension)) {
                        maxSize = 200 * 1024 * 1024; // 200MB for multimedia/compressed files
                    } else {
                        maxSize = 50 * 1024 * 1024; // 50MB for documents/images
                    }
                    
                    if (!isAllowedByMimeType && !isAllowedByExtension) {
                        console.warn(`æ–‡ä»¶ "${file.name}" ä¸è¢«æ”¯æŒ - MIMEç±»å‹: ${file.type}, æ‰©å±•å: ${fileName.split('.').pop()}`);
                        showAlert(`æ–‡ä»¶ "${file.name}" ç±»å‹ä¸è¢«æ”¯æŒã€‚å½“å‰æ”¯æŒï¼šOfficeæ–‡æ¡£ã€PDFã€å›¾ç‰‡ã€å‹ç¼©åŒ…ã€å¤šåª’ä½“æ–‡ä»¶ç­‰ã€‚<br><small>æ£€æµ‹åˆ°çš„ç±»å‹: ${file.type}</small>`, 'danger');
                        continue;
                    } else if (!isAllowedByMimeType && isAllowedByExtension) {
                        console.info(`æ–‡ä»¶ "${file.name}" é€šè¿‡æ‰©å±•åéªŒè¯ - MIMEç±»å‹æœªè¯†åˆ«: ${file.type}`);
                    }
                    if (file.size > maxSize) {
                        const sizeLimitMB = Math.round(maxSize / 1024 / 1024);
                        const fileName = file.name.toLowerCase();
                        const isLargeFile = maxSize > 10 * 1024 * 1024; // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†å¤§æ–‡ä»¶é™åˆ¶
                        const fileTypeName = isLargeFile ? 'å‹ç¼©åŒ…/å¤šåª’ä½“æ–‡ä»¶' : 'æ™®é€šæ–‡ä»¶';
                        showAlert(`æ–‡ä»¶ "${file.name}" å¤§å°è¶…è¿‡${fileTypeName}çš„${sizeLimitMB}MBé™åˆ¶ã€‚<br><small>å½“å‰æ–‡ä»¶å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB</small>`, 'danger');
                        continue;
                    }

                    const fileEntry = {
                        id: Date.now() + '-' + i,
                        file: file,
                        status: 'pending',
                        progress: 0,
                        serverFileName: null
                    };
                    uploadedFilesData.push(fileEntry);
                    addFileToUI(fileEntry);
                    fileUploadQueue.push(fileEntry);
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                }
                attachmentFilesInput.value = '';
                
                // å¼€å§‹å¤„ç†ä¸Šä¼ é˜Ÿåˆ—
                processFileUploadQueue();
            }

             // ===== æ ¸å¿ƒä¸Šä¼ é˜Ÿåˆ—å¤„ç† =====
             async function processFileUploadQueue() {
                 if (isUploading) return;
                 isUploading = true;

                 while (fileUploadQueue.length > 0) {
                     const fileEntry = fileUploadQueue.shift();
                     if (fileEntry.status === 'pending') {
                         await uploadFile(fileEntry);
                     }
                 }
                 isUploading = false;
             }

             // ===== ä¸»ä¸Šä¼ å‡½æ•° =====
             async function uploadFile(fileEntry) {
                 try {
                     updateFileStatusUI(fileEntry.id, 'uploading', 'åˆå§‹åŒ–ä¸Šä¼ ...');
                     
                     // 1. åˆå§‹åŒ–ä¸Šä¼ 
                     const initResponse = await fetch('/api/attachments/initiate', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             fileName: fileEntry.file.name,
                             totalSize: fileEntry.file.size
                         })
                     });

                     if (!initResponse.ok) {
                         throw new Error('åˆå§‹åŒ–ä¸Šä¼ å¤±è´¥');
                     }

                     const initResult = await initResponse.json();
                     const uploadId = initResult.uploadId;
                     const serverFileName = initResult.serverFileName;
                     
                     // ä¿å­˜ä¸Šä¼ IDä¾›æ–­ç‚¹ç»­ä¼ ä½¿ç”¨
                     fileEntry.uploadId = uploadId;
                     fileEntry.serverFileName = serverFileName;
                     saveUploadState(); // ä¿å­˜çŠ¶æ€

                     // 2. æ™ºèƒ½åˆ†å—ä¸Šä¼  (æ”¯æŒæ–­ç‚¹ç»­ä¼ )
                     await uploadFileWithResume(fileEntry, uploadId);

                     // 3. å®Œæˆä¸Šä¼ 
                     const finalizeResponse = await fetch(`/api/attachments/finalize/${uploadId}`, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/x-www-form-urlencoded'
                         },
                         body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                     });

                     if (!finalizeResponse.ok) {
                         throw new Error('å®Œæˆä¸Šä¼ å¤±è´¥');
                     }

                     const finalizeResult = await finalizeResponse.json();
                     
                     fileEntry.status = 'completed';
                     fileEntry.progress = 100;
                     fileEntry.serverFileName = finalizeResult.fileName;
                     updateFileProgress(fileEntry.id, 100);
                     updateFileStatusUI(fileEntry.id, 'completed');
                     saveUploadState(); // ä¿å­˜çŠ¶æ€
                     showAlert(`æ–‡ä»¶ "${fileEntry.file.name}" ä¸Šä¼ æˆåŠŸã€‚`, 'success', 3000);
                     
                 } catch (error) {
                     if (error.message === 'NEED_REAL_FILE') {
                         // éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶
                         console.log('ä¸Šä¼ è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œéœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶');
                         fileEntry.status = 'pending';
                         updateFileStatusUI(fileEntry.id, 'pending', 'éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶');
                         saveUploadState();
                         
                         const confirmed = confirm(`æ–‡ä»¶ "${fileEntry.file.name}" éœ€è¦é‡æ–°é€‰æ‹©æ‰èƒ½ç»§ç»­ä¸Šä¼ ã€‚\n\nç‚¹å‡»ç¡®å®šæ¥é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–å–æ¶ˆåˆ é™¤æ­¤é¡¹ã€‚`);
                         if (confirmed) {
                             showFileSelectionDialog(fileEntry);
                         } else {
                             removeFile(fileEntry.id);
                         }
                         return;
                     }
                     
                     console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                     fileEntry.status = 'error';
                     fileEntry.progress = 0;
                     updateFileProgress(fileEntry.id, 0);
                     updateFileStatusUI(fileEntry.id, 'error', error.message);
                     saveUploadState(); // ä¿å­˜çŠ¶æ€
                     showAlert(`æ–‡ä»¶ "${fileEntry.file.name}" ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                 }
             }

             // æ–­ç‚¹ç»­ä¼ æ ¸å¿ƒå‡½æ•°
             async function uploadFileWithResume(fileEntry, uploadId) {
                 const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
                 const totalChunks = Math.ceil(fileEntry.file.size / CHUNK_SIZE);
                 
                 console.log(`DEBUG: å¼€å§‹æ–­ç‚¹ç»­ä¼  - æ–‡ä»¶: ${fileEntry.file.name}, æ€»å¤§å°: ${fileEntry.file.size} bytes, æ€»åˆ†å—: ${totalChunks}`);
                 
                 // æ£€æŸ¥æ–‡ä»¶å¯¹è±¡æ˜¯å¦ä¸ºè™šæ‹Ÿæ–‡ä»¶ï¼ˆä»localStorageæ¢å¤çš„ï¼‰
                 if (typeof fileEntry.file.stream === 'undefined' || typeof fileEntry.file.slice !== 'function') {
                     console.warn('æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œæ— æ³•è¿›è¡Œåˆ‡ç‰‡æ“ä½œ');
                     throw new Error('NEED_REAL_FILE'); // ç‰¹æ®Šé”™è¯¯ç ï¼Œè¡¨ç¤ºéœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶
                 }
                 
                 // æµ‹è¯•æ–‡ä»¶åˆ‡ç‰‡åŠŸèƒ½
                 try {
                     const testChunk = fileEntry.file.slice(0, Math.min(1024, fileEntry.file.size));
                     if (testChunk.size === 0 && fileEntry.file.size > 0) {
                         console.warn('æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å¤±è´¥ï¼Œæ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                         throw new Error('NEED_REAL_FILE');
                     }
                     console.log(`æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•æˆåŠŸï¼Œæµ‹è¯•åˆ†å—å¤§å°: ${testChunk.size} bytes`);
                 } catch (sliceError) {
                     console.warn('æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å‡ºé”™:', sliceError);
                     throw new Error('NEED_REAL_FILE');
                 }
                 
                 // 1. æŸ¥è¯¢æœåŠ¡å™¨å·²ä¸Šä¼ çŠ¶æ€
                 let uploadedChunks = new Set();
                 let serverTotalChunks = 0;
                 let serverFileSize = 0;
                 
                 try {
                     const statusResponse = await fetch(`/api/attachments/status/${uploadId}`);
                     if (statusResponse.ok) {
                         const status = await statusResponse.json();
                         uploadedChunks = new Set(status.uploadedChunks || []);
                         serverTotalChunks = status.totalChunks || 0;
                         serverFileSize = status.totalSize || 0;
                         
                         console.log(`æœåŠ¡å™¨çŠ¶æ€: æ–‡ä»¶å¤§å°=${serverFileSize}, æ€»åˆ†å—=${serverTotalChunks}, å·²ä¸Šä¼ =${uploadedChunks.size}ä¸ªåˆ†å—`);
                         console.log(`å½“å‰æ–‡ä»¶: æ–‡ä»¶å¤§å°=${fileEntry.file.size}, è®¡ç®—åˆ†å—=${totalChunks}`);
                         
                         // éªŒè¯æ–‡ä»¶ä¸€è‡´æ€§
                         if (serverFileSize !== fileEntry.file.size) {
                             console.error(`æ–‡ä»¶å¤§å°ä¸ä¸€è‡´! æœåŠ¡å™¨: ${serverFileSize}, å½“å‰: ${fileEntry.file.size}`);
                             throw new Error(`æ–‡ä»¶ä¸ä¸€è‡´ï¼šæœåŠ¡å™¨è®°å½•å¤§å° ${serverFileSize} bytesï¼Œå½“å‰æ–‡ä»¶å¤§å° ${fileEntry.file.size} bytes`);
                         }
                         
                         console.log(`æ–‡ä»¶ "${fileEntry.file.name}" æ–­ç‚¹ç»­ä¼ : å·²ä¸Šä¼  ${uploadedChunks.size}/${totalChunks} åˆ†å—`);
                         
                         // æ›´æ–°UIæ˜¾ç¤ºå·²æœ‰è¿›åº¦
                         if (uploadedChunks.size > 0) {
                             const existingProgress = Math.round((uploadedChunks.size / totalChunks) * 90);
                             fileEntry.progress = existingProgress;
                             updateFileProgress(fileEntry.id, existingProgress);
                             updateFileStatusUI(fileEntry.id, 'uploading', `ç»§ç»­ä¸Šä¼  (${uploadedChunks.size}/${totalChunks} å·²å®Œæˆ)`);
                         }
                     }
                 } catch (error) {
                     console.warn(`æŸ¥è¯¢ä¸Šä¼ çŠ¶æ€å¤±è´¥ï¼Œå°†ä»å¤´å¼€å§‹: ${error.message}`);
                 }
                 
                 // 2. åªä¸Šä¼ ç¼ºå¤±çš„åˆ†å—
                 for (let chunkNumber = 0; chunkNumber < totalChunks; chunkNumber++) {
                     if (uploadedChunks.has(chunkNumber)) {
                         console.log(`è·³è¿‡å·²ä¸Šä¼ çš„åˆ†å—: ${chunkNumber + 1}/${totalChunks}`);
                         continue; // è·³è¿‡å·²ä¸Šä¼ çš„åˆ†å—
                     }
                     
                     const success = await uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, CHUNK_SIZE);
                     if (!success) {
                         throw new Error(`åˆ†å— ${chunkNumber + 1} å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥`);
                     }
                     
                     // æ›´æ–°è¿›åº¦å’Œåˆ†å—ä¿¡æ¯
                     const uploadedCount = chunkNumber + 1;
                     const progress = Math.round((uploadedCount / totalChunks) * 90);
                     fileEntry.progress = progress;
                     const chunkInfo = `åˆ†å— ${uploadedCount}/${totalChunks} å·²ä¸Šä¼ `;
                     updateFileProgress(fileEntry.id, progress, chunkInfo);
                     
                     // æ¯5ä¸ªåˆ†å—ä¿å­˜ä¸€æ¬¡çŠ¶æ€ï¼ˆå‡å°‘å­˜å‚¨é¢‘ç‡ï¼‰
                     if (uploadedCount % 5 === 0 || uploadedCount === totalChunks) {
                         saveUploadState();
                     }
                 }
             }

             // æ”¯æŒé‡è¯•çš„åˆ†å—ä¸Šä¼ å‡½æ•°
             async function uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, chunkSize, maxRetries = 3) {
                 const start = chunkNumber * chunkSize;
                 const end = Math.min(start + chunkSize, fileEntry.file.size);
                 const chunk = fileEntry.file.slice(start, end);

                 // éªŒè¯åˆ†å—å¤§å°
                 if (chunk.size === 0) {
                     console.error(`åˆ†å— ${chunkNumber + 1} åˆ‡ç‰‡ç»“æœä¸ºç©º! start=${start}, end=${end}, fileSize=${fileEntry.file.size}`);
                     throw new Error(`åˆ†å— ${chunkNumber + 1} åˆ‡ç‰‡å¤±è´¥ï¼šç»“æœä¸ºç©º`);
                 }

                 for (let attempt = 0; attempt < maxRetries; attempt++) {
                     try {
                         const chunkFormData = new FormData();
                         chunkFormData.append('file', chunk);
                         chunkFormData.append('chunkNumber', chunkNumber);
                         chunkFormData.append('totalChunks', totalChunks);

                         console.log(`DEBUG: å®é™…ä¸Šä¼ åˆ†å— ${chunkNumber + 1}/${totalChunks}, å¤§å°: ${chunk.size} bytes, èŒƒå›´: ${start}-${end}, uploadId: ${uploadId}`);

                         const chunkResponse = await fetch('/api/attachments/upload-chunk', {
                             method: 'POST',
                             headers: {
                                 'X-Upload-Id': uploadId
                             },
                             body: chunkFormData
                         });

                         if (chunkResponse.ok) {
                             console.log(`åˆ†å— ${chunkNumber + 1}/${totalChunks} ä¸Šä¼ æˆåŠŸ ${attempt > 0 ? `(é‡è¯• ${attempt} æ¬¡å)` : ''}`);
                             return true; // æˆåŠŸ
                         } else {
                             // è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                             let errorDetails = `HTTP ${chunkResponse.status}: ${chunkResponse.statusText}`;
                             try {
                                 const errorText = await chunkResponse.text();
                                 if (errorText) {
                                     errorDetails += ` - ${errorText}`;
                                 }
                             } catch (e) {
                                 console.warn('æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯:', e);
                             }
                             throw new Error(errorDetails);
                         }
                     } catch (error) {
                         console.warn(`åˆ†å— ${chunkNumber + 1} ä¸Šä¼ å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries}): ${error.message}`);
                         
                         if (attempt === maxRetries - 1) {
                             // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
                             updateFileStatusUI(fileEntry.id, 'error', `åˆ†å— ${chunkNumber + 1} é‡è¯• ${maxRetries} æ¬¡åå¤±è´¥`);
                             return false;
                         }
                         
                         // æŒ‡æ•°é€€é¿ç­–ç•¥
                         const delay = Math.min(1000 * Math.pow(2, attempt), 10000); // æœ€å¤§10ç§’
                         console.log(`${delay}ms åé‡è¯•åˆ†å— ${chunkNumber + 1}...`);
                         updateFileStatusUI(fileEntry.id, 'uploading', `åˆ†å— ${chunkNumber + 1} é‡è¯•ä¸­... (${attempt + 1}/${maxRetries})`);
                         await sleep(delay);
                     }
                 }
                 return false;
             }

             // è¾…åŠ©å‡½æ•°ï¼šå»¶æ—¶
             function sleep(ms) {
                 return new Promise(resolve => setTimeout(resolve, ms));
             }

            // UIæ›´æ–°å‡½æ•°
            function updateFileProgress(fileId, progress, info = '') {
                const safeFileId = fileId.replace(/[^a-zA-Z0-9-_]/g, '_');
                const listItem = document.getElementById(`file-item-${safeFileId}`);
                console.log(`DEBUG: æ›´æ–°è¿›åº¦ - fileId: ${fileId}, safeFileId: ${safeFileId}, å…ƒç´ : ${listItem ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}, è¿›åº¦: ${progress}%`);
                
                if (listItem) {
                    const progressBar = listItem.querySelector('.file-progress-bar');
                    console.log(`DEBUG: è¿›åº¦æ¡å…ƒç´ : ${progressBar ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`);
                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        console.log(`DEBUG: è¿›åº¦æ¡å·²æ›´æ–°ä¸º ${progress}%`);
                    }
                    
                    if (info) {
                        const statusElement = listItem.querySelector('.file-status');
                        if (statusElement) {
                            statusElement.textContent = info;
                        }
                    }
                } else {
                    console.error(`æ— æ³•æ‰¾åˆ°æ–‡ä»¶UIå…ƒç´ : #file-item-${safeFileId}`);
                }
            }

            function updateFileStatusUI(fileId, status, message = '') {
                const safeFileId = fileId.replace(/[^a-zA-Z0-9-_]/g, '_');
                const listItem = document.getElementById(`file-item-${safeFileId}`);
                if (listItem) {
                    // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
                    listItem.classList.remove('upload-pending', 'upload-uploading', 'upload-completed', 'upload-error');
                    listItem.classList.add(`upload-${status}`);
                    
                    const statusSpan = listItem.querySelector('.file-status');
                    const progressBarContainer = listItem.querySelector('.file-progress');
                    const previewBtn = listItem.querySelector('.preview-btn');
                    const retryBtn = listItem.querySelector('.retry-btn');
                    
                    if (statusSpan) {
                        if (status === 'completed') {
                            statusSpan.classList.remove('text-muted', 'text-info', 'text-danger', 'text-warning');
                            statusSpan.classList.add('text-success');
                            statusSpan.textContent = '(ä¸Šä¼ æˆåŠŸ)';
                            if (progressBarContainer) progressBarContainer.style.display = 'none';
                            if (previewBtn) previewBtn.style.display = 'inline-block';
                            if (retryBtn) retryBtn.style.display = 'none';
                        } else if (status === 'error') {
                            statusSpan.classList.remove('text-muted', 'text-info', 'text-success', 'text-warning');
                            statusSpan.classList.add('text-danger');
                            statusSpan.textContent = `(ä¸Šä¼ å¤±è´¥: ${message})`;
                            if (retryBtn) {
                                retryBtn.style.display = 'inline-block';
                                retryBtn.textContent = 'é‡è¯•';
                                retryBtn.classList.remove('btn-primary');
                                retryBtn.classList.add('btn-warning');
                                retryBtn.style.fontWeight = 'normal';
                            }
                        } else if (status === 'uploading') {
                            statusSpan.classList.remove('text-muted', 'text-success', 'text-danger', 'text-warning');
                            statusSpan.classList.add('text-info');
                            statusSpan.textContent = message || '(ä¸Šä¼ ä¸­...)';
                            if (progressBarContainer) progressBarContainer.style.display = 'block';
                            if (retryBtn) retryBtn.style.display = 'none';
                        } else if (status === 'pending') {
                            statusSpan.classList.remove('text-info', 'text-success', 'text-danger', 'text-warning');
                            statusSpan.classList.add('text-muted');
                            statusSpan.textContent = message || '(éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶)';
                            if (retryBtn) {
                                retryBtn.style.display = 'inline-block';
                                retryBtn.textContent = 'ğŸ”„ é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ ';
                                retryBtn.classList.remove('btn-warning');
                                retryBtn.classList.add('btn-primary');
                                retryBtn.style.fontWeight = 'bold';
                            }
                        } else {
                            statusSpan.classList.add('text-muted');
                            statusSpan.textContent = '(ç­‰å¾…ä¸Šä¼ )';
                            if (retryBtn) {
                                retryBtn.style.display = 'none';
                                // é‡ç½®æŒ‰é’®æ ·å¼ï¼ˆé¿å…need_fileçŠ¶æ€çš„æ ·å¼æ®‹ç•™ï¼‰
                                retryBtn.textContent = 'é‡è¯•';
                                retryBtn.classList.remove('btn-primary');
                                retryBtn.classList.add('btn-warning');
                                retryBtn.style.fontWeight = 'normal';
                            }
                        }
                        
                        
                    }
                    
                    // éšè—è¿›åº¦æ¡ï¼ˆå¦‚æœä¸Šä¼ å®Œæˆï¼‰
                    if (status === 'completed') {
                        const progressBarContainer = listItem.querySelector('.file-progress');
                        if (progressBarContainer) progressBarContainer.style.display = 'none';
                    }
                }
            }

            // æŒä¹…åŒ–ä¸Šä¼ çŠ¶æ€åˆ°localStorage
            function saveUploadState() {
                try {
                    const uploadState = {
                        timestamp: Date.now(),
                        files: uploadedFilesData.filter(file => !file.isExisting).map(file => ({
                            id: file.id,
                            name: file.file.name,
                            size: file.file.size,
                            type: file.file.type,
                            status: file.status,
                            progress: file.progress,
                            uploadId: file.uploadId,
                            serverFileName: file.serverFileName,
                            lastModified: file.file.lastModified // ç”¨äºéªŒè¯æ–‡ä»¶ä¸€è‡´æ€§
                        }))
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(uploadState));
                    console.log('å®šç¨¿é¡µé¢ä¸Šä¼ çŠ¶æ€å·²ä¿å­˜');
                } catch (error) {
                    console.warn('ä¿å­˜ä¸Šä¼ çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // ä»localStorageæ¢å¤ä¸Šä¼ çŠ¶æ€
            function restoreUploadState() {
                try {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (!savedState) return;

                    const uploadState = JSON.parse(savedState);
                    const now = Date.now();
                    const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;

                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    if (now - uploadState.timestamp > expiryTime) {
                        console.log('ä¿å­˜çš„ä¸Šä¼ çŠ¶æ€å·²è¿‡æœŸï¼Œæ¸…é™¤');
                        localStorage.removeItem(STORAGE_KEY);
                        return;
                    }

                    const filesToRestore = uploadState.files.filter(file => file.status !== 'completed');

                    if (filesToRestore.length > 0) {
                        console.log(`å‘ç° ${filesToRestore.length} ä¸ªæœªå®Œæˆçš„ä¸Šä¼ ï¼Œå‡†å¤‡æ¢å¤`);
                        const fileList = filesToRestore.map(f => `â€¢ ${f.name} (${(f.size/1024/1024).toFixed(2)}MB)`).join('\n');
                        showAlert(
                            `æ£€æµ‹åˆ° ${filesToRestore.length} ä¸ªæœªå®Œæˆçš„å®šç¨¿é™„ä»¶ä¸Šä¼ ï¼š\n${fileList}\n\næ–‡ä»¶å·²æ¢å¤åˆ°ç•Œé¢ï¼Œè¯·ç‚¹å‡»ç›¸åº”çš„é‡è¯•æŒ‰é’®é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ ã€‚`, 
                            'warning', 
                            15000
                        );

                        filesToRestore.forEach(savedFile => {
                            const virtualFile = createVirtualFile(savedFile);
                            if (virtualFile) {
                                const fileEntry = {
                                    id: savedFile.id,
                                    file: virtualFile,
                                    status: savedFile.status,
                                    progress: savedFile.progress || 0,
                                    uploadId: savedFile.uploadId,
                                    serverFileName: savedFile.serverFileName
                                };

                                uploadedFilesData.push(fileEntry);
                                addFileToUI(fileEntry);
                                updateFileStatusUI(fileEntry.id, 'pending', 'éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ ');
                            }
                        });

                        prepareAttachmentsForSubmission();
                    }
                } catch (error) {
                    console.error('æ¢å¤ä¸Šä¼ çŠ¶æ€å¤±è´¥:', error);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }



            // é‡è¯•ä¸Šä¼ åŠŸèƒ½
            async function retryUpload(fileId) {
                const fileEntry = uploadedFilesData.find(file => file.id === fileId);
                if (!fileEntry) {
                    console.error(`æœªæ‰¾åˆ°æ–‡ä»¶ID: ${fileId}`);
                    return;
                }

                // å¦‚æœæ˜¯è™šæ‹Ÿæ–‡ä»¶ï¼ˆä»localStorageæ¢å¤çš„ï¼‰ï¼Œç›´æ¥å¼¹å‡ºæ–‡ä»¶é€‰æ‹©
                if (fileEntry.file.size === 0 || (fileEntry.file.size > 0 && typeof fileEntry.file.stream === 'undefined')) {
                    console.log(`æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶ "${fileEntry.file.name}"ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹`);
                    showFileSelectionDialog(fileEntry, true); // ä½¿ç”¨è‡ªåŠ¨ç»­ä¼ æ¨¡å¼
                    return;
                }

                // é‡ç½®çŠ¶æ€
                fileEntry.status = 'pending';
                fileEntry.progress = 0;
                updateFileProgress(fileEntry.id, 0);
                updateFileStatusUI(fileEntry.id, 'uploading', 'é‡æ–°å¼€å§‹ä¸Šä¼ ...');

                // æ˜¾ç¤ºè¿›åº¦æ¡
                const safeFileId = fileId.replace(/[^a-zA-Z0-9-_]/g, '_');
                const listItem = document.getElementById(`file-item-${safeFileId}`);
                if (listItem) {
                    const progressBarContainer = listItem.querySelector('.file-progress');
                    if (progressBarContainer) progressBarContainer.style.display = 'block';
                }

                try {
                    if (fileEntry.uploadId) {
                        // å¦‚æœæœ‰ä¸Šä¼ IDï¼Œå°è¯•æ–­ç‚¹ç»­ä¼ 
                        try {
                            await uploadFileWithResume(fileEntry, fileEntry.uploadId);
                        } catch (error) {
                            if (error.message === 'RESTART_UPLOAD') {
                                // éœ€è¦é‡æ–°å¼€å§‹ä¸Šä¼ 
                                console.log('é‡æ–°å¼€å§‹ä¸Šä¼ æµç¨‹...');
                                await uploadFile(fileEntry);
                                return;
                            } else if (error.message === 'NEED_REAL_FILE') {
                                // éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹
                                console.log('æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹');
                                showFileSelectionDialog(fileEntry, true); // ä½¿ç”¨è‡ªåŠ¨ç»­ä¼ æ¨¡å¼
                                return;
                            } else {
                                throw error; // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                            }
                        }
                    } else {
                        // å¦åˆ™é‡æ–°å¼€å§‹ä¸Šä¼ 
                        await uploadFile(fileEntry);
                        return; // uploadFile ä¼šå¤„ç†å®Œæ•´æµç¨‹
                    }

                    // 3. å®Œæˆä¸Šä¼ 
                    const finalizeResponse = await fetch(`/api/attachments/finalize/${fileEntry.uploadId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                    });

                    if (!finalizeResponse.ok) {
                        throw new Error('å®Œæˆä¸Šä¼ å¤±è´¥');
                    }

                    const finalizeResult = await finalizeResponse.json();
                    
                    fileEntry.status = 'completed';
                    fileEntry.progress = 100;
                    fileEntry.serverFileName = finalizeResult.fileName;
                    updateFileProgress(fileEntry.id, 100);
                    updateFileStatusUI(fileEntry.id, 'completed');
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlert(`æ–‡ä»¶ "${fileEntry.file.name}" é‡è¯•ä¸Šä¼ æˆåŠŸã€‚`, 'success', 3000);
                    
                } catch (error) {
                    console.error('é‡è¯•ä¸Šä¼ å¤±è´¥:', error);
                    fileEntry.status = 'error';
                    updateFileStatusUI(fileEntry.id, 'error', `é‡è¯•å¤±è´¥: ${error.message}`);
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlert(`æ–‡ä»¶ "${fileEntry.file.name}" é‡è¯•ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            function showFileSelectionDialog(fileEntry, isAutoResume = false) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';
                
                if (isAutoResume) {
                    // è‡ªåŠ¨ç»­ä¼ æ¨¡å¼ä¸‹ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·æç¤º
                    showAlert(`è¯·é€‰æ‹©æ–‡ä»¶ "${fileEntry.file.name}" ä»¥ç»§ç»­æ–­ç‚¹ç»­ä¼ `, 'warning', 8000);
                }
                
                input.onchange = function(e) {
                    const selectedFile = e.target.files[0];
                    if (selectedFile) {
                        // éªŒè¯æ–‡ä»¶åå’Œå¤§å°æ˜¯å¦åŒ¹é…
                        if (selectedFile.name === fileEntry.file.name && selectedFile.size === fileEntry.file.size) {
                            // æ›¿æ¢æ–‡ä»¶å¯¹è±¡
                            console.log(`æ–‡ä»¶é‡æ–°é€‰æ‹©æˆåŠŸ: ${selectedFile.name}, å¤§å°: ${selectedFile.size} bytes`);
                            fileEntry.file = selectedFile;
                            
                            // éªŒè¯æ–°æ–‡ä»¶å¯¹è±¡çš„åˆ‡ç‰‡åŠŸèƒ½
                            try {
                                const testChunk = selectedFile.slice(0, Math.min(1024, selectedFile.size));
                                console.log(`æ–°æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•æˆåŠŸï¼Œæµ‹è¯•åˆ†å—å¤§å°: ${testChunk.size} bytes`);
                            } catch (sliceError) {
                                console.error('æ–°æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å¤±è´¥:', sliceError);
                                alert('é€‰æ‹©çš„æ–‡ä»¶æ— æ³•æ­£å¸¸è¯»å–ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚');
                                return;
                            }
                            
                            updateFileStatusUI(fileEntry.id, 'uploading', 'æ–‡ä»¶å·²é€‰æ‹©ï¼Œå¼€å§‹æ–­ç‚¹ç»­ä¼ ...');
                            
                            // ç«‹å³å¼€å§‹ä¸Šä¼ 
                            setTimeout(() => {
                                retryUpload(fileEntry.id);
                            }, 300);
                        } else {
                            const proceed = confirm(`é€‰æ‹©çš„æ–‡ä»¶ä¸åŸæ–‡ä»¶ä¸åŒ¹é…ï¼š\nåŸæ–‡ä»¶: ${fileEntry.file.name} (${(fileEntry.file.size/1024/1024).toFixed(2)}MB)\næ–°æ–‡ä»¶: ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(2)}MB)\n\næ˜¯å¦ä»è¦ä½¿ç”¨æ–°æ–‡ä»¶ï¼Ÿ`);
                            if (proceed) {
                                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                                fileEntry.file = selectedFile;
                                fileEntry.uploadId = null; // æ¸…é™¤æ—§çš„uploadId
                                fileEntry.progress = 0;
                                
                                // æ›´æ–°UIæ˜¾ç¤º
                                const safeEntryId = fileEntry.id.replace(/[^a-zA-Z0-9-_]/g, '_');
                                const fileInfo = document.querySelector(`#file-item-${safeEntryId} .file-info`);
                                if (fileInfo) {
                                    fileInfo.innerHTML = `
                                        <span class="file-name" title="${selectedFile.name}">${selectedFile.name}</span>
                                        <span class="file-size">${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</span>
                                    `;
                                }
                                
                                updateFileStatusUI(fileEntry.id, 'pending', 'æ–°æ–‡ä»¶å·²é€‰æ‹©ï¼Œå‡†å¤‡ä¸Šä¼ ');
                                
                                // ç«‹å³å¼€å§‹ä¸Šä¼ 
                                setTimeout(() => {
                                    retryUpload(fileEntry.id);
                                }, 500);
                            }
                        }
                    }
                };
                input.click();
            }

            function removeFile(fileId) {
                uploadedFilesData = uploadedFilesData.filter(file => file.id !== fileId);
                const safeFileId = fileId.replace(/[^a-zA-Z0-9-_]/g, '_');
                const listItem = document.getElementById(`file-item-${safeFileId}`);
                if (listItem) {
                    listItem.remove();
                }
                prepareAttachmentsForSubmission();
                saveUploadState(); // ä¿å­˜çŠ¶æ€
            }

             // åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼ˆç”¨äºæ¢å¤ï¼‰
            function createVirtualFile(savedFile) {
                try {
                    // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„Fileå¯¹è±¡ç”¨äºæ˜¾ç¤º
                    const blob = new Blob([''], { type: savedFile.type });
                    const file = new File([blob], savedFile.name, {
                        type: savedFile.type,
                        lastModified: savedFile.lastModified
                    });
                    
                    // ç”±äºæ— æ³•æ¢å¤å®é™…æ–‡ä»¶å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é‡è¯•æ—¶æç¤ºç”¨æˆ·é‡æ–°é€‰æ‹©æ–‡ä»¶
                    Object.defineProperty(file, 'size', {
                        value: savedFile.size,
                        writable: false
                    });
                    
                    return file;
                } catch (error) {
                    console.error('åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¤±è´¥:', error);
                    return null;
                }
            }

            // æ¸…é™¤è¿‡æœŸçš„ä¸Šä¼ çŠ¶æ€
            function clearExpiredUploads() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    try {
                        const uploadState = JSON.parse(savedState);
                        const now = Date.now();
                        const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;
                        
                        if (now - uploadState.timestamp > expiryTime) {
                            localStorage.removeItem(STORAGE_KEY);
                            console.log('å·²æ¸…é™¤è¿‡æœŸçš„ä¸Šä¼ çŠ¶æ€');
                        }
                    } catch (error) {
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            }

            // ç½‘ç»œçŠ¶æ€ç›‘æµ‹
            function setupNetworkStatusMonitoring() {
                window.addEventListener('online', () => {
                    console.log('ç½‘ç»œå·²æ¢å¤');
                    showAlert('ç½‘ç»œè¿æ¥å·²æ¢å¤ï¼Œæ‚¨å¯ä»¥ç»§ç»­ä¸Šä¼ æ–‡ä»¶ã€‚', 'info', 5000);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ä¸Šä¼ ï¼Œæç¤ºç”¨æˆ·é‡è¯•
                    const failedUploads = uploadedFilesData.filter(file => file.status === 'error');
                    if (failedUploads.length > 0) {
                        showAlert(`å‘ç° ${failedUploads.length} ä¸ªå¤±è´¥çš„ä¸Šä¼ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡è¯•"æŒ‰é’®ç»§ç»­ä¸Šä¼ ã€‚`, 'warning', 8000);
                    }
                });

                window.addEventListener('offline', () => {
                    console.log('ç½‘ç»œå·²æ–­å¼€');
                    showAlert('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä¸Šä¼ å¯èƒ½ä¼šå¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'warning', 8000);
                });
            }

            // å¯åŠ¨ç½‘ç»œçŠ¶æ€ç›‘æµ‹
            setupNetworkStatusMonitoring();
            
            // é¡µé¢åŠ è½½æ—¶æ¢å¤æœªå®Œæˆçš„ä¸Šä¼ 
            restoreUploadState();
            
            // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿‡æœŸçŠ¶æ€
            window.addEventListener('beforeunload', clearExpiredUploads);

             // è¡¨å•æäº¤æˆåŠŸåæ¸…é™¤ä¸Šä¼ çŠ¶æ€
             window.clearFinalizeUploadStateOnSuccess = function() {
                 localStorage.removeItem(STORAGE_KEY);
                 console.log('å®šç¨¿é¡µé¢è¡¨å•æäº¤æˆåŠŸï¼Œå·²æ¸…é™¤ä¸Šä¼ çŠ¶æ€');
             };
             
             // è°ƒè¯•ç”¨ï¼šæ¸…é™¤ä¸Šä¼ çŠ¶æ€
             window.debugClearUploadState = function() {
                 localStorage.removeItem(STORAGE_KEY);
                 console.log('æ‰‹åŠ¨æ¸…é™¤ä¸Šä¼ çŠ¶æ€å®Œæˆ');
                 location.reload();
             };

        });
        /*]]>*/
    </script>
</th:block>
</html>