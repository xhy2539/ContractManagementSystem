<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}">
<head>
    <meta charset="UTF-8">
    <title>定稿合同 - <span th:text="${contract?.contractName ?: '合同详情'}"></span></title>
    <style layout:fragment="inline-css">
        .contract-details-section {
            margin-bottom: 1.5rem;
        }
        .contract-content-display, .contract-content-edit textarea {
            background-color: #f8f9fa;
            border: 1px solid #e3e6ea;
            padding: 1rem 1.25rem;
            border-radius: 0.375rem;
            min-height: 150px;
            white-space: pre-wrap;
            font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            line-height: 1.6;
            overflow-x: auto;
        }
        .contract-content-edit textarea {
            width: 100%;
        }
        .attachment-link i {
            margin-right: 0.3rem;
        }
        .form-actions {
            border-top: 1px solid #e9ecef;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .sticky-lg-top {
            top: calc(56px + 1.5rem);
        }
        .dl-horizontal dt {
            font-weight: 500;
        }
        .countersign-opinions-card .card-body {
            max-height: 300px;
            overflow-y: auto;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }
        .file-info {
            flex-grow: 1;
            margin-right: 1rem;
            overflow: hidden;
        }
        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .file-size, .file-status {
            font-size: 0.8em;
            color: #6c757d;
        }
        .file-actions button {
            margin-left: 0.5rem;
        }
        .file-progress {
            height: 10px;
            margin-top: 0.25rem;
            background-color: #e9ecef;
            border-radius: .25rem;
            overflow: hidden;
        }
        .file-progress-bar {
            background-color: #0d6efd;
            height: 100%;
            transition: width 0.2s ease-in-out;
            color: white;
            font-size: 0.7em;
            line-height:10px;
            text-align: center;
        }
        .file-list-item.upload-error {
            border-left: 5px solid var(--bs-danger);
            background-color: #fbe9e7;
        }
        .file-list-item.upload-success {
            border-left: 5px solid var(--bs-success);
            background-color: #e8f5e9;
        }
    </style>
</head>

<section layout:fragment="content">
    <div class="container-fluid mt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="bi bi-file-earmark-check-fill text-success me-2"></i>定稿合同:
                <span th:if="${contract != null}" th:text="${contract.contractName ?: '未知合同'}" class="text-primary"></span>
                <span th:if="${contract == null}" class="text-muted">加载中...</span>
            </h1>
            <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left-circle"></i> 返回待定稿列表
            </a>
        </div>

        <div id="globalAlertContainer"></div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${contract == null}" class="alert alert-warning text-center py-4" role="alert">
            <h5 class="alert-heading"><i class="bi bi-exclamation-octagon-fill me-2"></i>无法加载合同信息</h5>
            <p class="mb-0">未能加载合同详细信息，或您没有权限访问此合同进行定稿操作。</p>
            <hr>
            <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-primary btn-sm">返回列表</a>
        </div>

        <form th:if="${contract != null}" th:action="@{/contract-manager/finalize/{contractId}(contractId=${contract.id})}"
              method="post" id="finalizeForm" th:object="${contractDraftRequest}">

            <div id="hiddenAttachmentInputsContainerFinalize"></div>

            <div class="row g-4">
                <div class="col-lg-7 col-xl-8">
                    <div class="card shadow-sm contract-details-section">

                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-info-circle-fill me-2"></i>合同基本信息</h5>
                        </div>
                        <div class="card-body">
                            <dl class="row dl-horizontal mb-0">
                                <dt class="col-sm-4 col-md-3 text-muted">合同编号:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.contractNumber ?: '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">合同名称:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.contractName ?: '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">客户名称:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.customer?.customerName ?: '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">起草人:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.drafter?.username ?: '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">开始日期:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.startDate != null ? #temporals.format(contract.startDate, 'yyyy-MM-dd') : '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">结束日期:</dt>
                                <dd class="col-sm-8 col-md-9" th:text="${contract.endDate != null ? #temporals.format(contract.endDate, 'yyyy-MM-dd') : '-'}"></dd>

                                <dt class="col-sm-4 col-md-3 text-muted">当前状态:</dt>
                                <dd class="col-sm-8 col-md-9">
                                    <span th:if="${contract.status}"
                                          th:text="${contract.status.description}"
                                          class="status-badge"
                                          th:classappend="'status-' + ${contract.status.name()}">待定稿</span>
                                    <span th:unless="${contract.status != null}" class="text-muted">未知状态</span>
                                </dd>
                            </dl>
                        </div>
                    </div>

                    <div class="card shadow-sm contract-details-section countersign-opinions-card" th:if="${countersignOpinions != null and not #lists.isEmpty(countersignOpinions)}">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-chat-left-text-fill me-2 text-info"></i>会签意见汇总</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" th:each="opinion : ${countersignOpinions}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: '匿名用户'}"></h6>
                                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : '未处理'}"></small>
                                    </div>
                                    <p class="mb-1" th:text="${opinion.comments ?: '(无具体意见)'}"></p>
                                    <small th:text="${opinion.state?.description ?: '未知状态'}"
                                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                                    </small>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card shadow-sm contract-details-section countersign-opinions-card" th:if="${allFinalizeProcesses != null and not #lists.isEmpty(allFinalizeProcesses)}">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2 text-primary"></i>定稿意见汇总</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" th:each="opinion : ${allFinalizeProcesses}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: '匿名用户'}"></h6>
                                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : '未处理'}"></small>
                                    </div>
                                    <p class="mb-1" th:text="${opinion.comments != null and !opinion.comments.isEmpty() ? opinion.comments : '(无具体意见)'}"></p>
                                    <small th:text="${opinion.state?.description ?: '未知状态'}"
                                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                                    </small>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card shadow-sm contract-details-section">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text-fill me-2"></i>合同内容与附件</h5>
                        </div>
                        <div class="card-body">
                            <h6>合同正文内容 (可编辑):</h6>
                            <div class="contract-content-edit mb-3">
                                <textarea class="form-control form-control-sm" id="updatedContent"
                                          th:field="*{updatedContent}" rows="15"
                                          placeholder="请在此处填写或修改合同的核心条款和内容..."></textarea>
                            </div>
                            <hr>
                            <div class="mb-3">
                                <label for="newAttachment" class="form-label">替换或上传新附件:</label>
                                <input type="file" class="form-control form-control-sm" id="newAttachment" multiple>
                                <div class="form-text small text-muted">如果上传新附件，它们将根据您的选择被添加或替换现有附件。支持PDF、图片(JPEG, PNG, GIF, BMP)、Word文档(doc, docx)。</div>

                                <div id="fileListContainerFinalize" class="mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 col-xl-4">
                    <div class="card shadow-sm sticky-lg-top">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-check2-square me-2"></i>执行定稿操作</h5>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">
                                请仔细审阅合同信息。一旦确认定稿，合同将进入后续的审批流程，通常定稿后的内容将不应再做大的修改。
                            </p>
                            <div class="mb-3">
                                <label for="finalizationComments" class="form-label">定稿意见/备注:</label>
                                <textarea class="form-control form-control-sm" id="finalizationComments" name="finalizationComments" rows="5" placeholder="（可选）输入您的定稿意见或重要备注..."></textarea>
                            </div>
                            <div class="form-actions text-end mt-4">
                                <button type="button" id="submitFinalizeBtn" class="btn btn-success btn-lg"
                                        sec:authorize="hasAuthority('CON_FINAL_SUBMIT')">
                                    <i class="bi bi-check-circle-fill"></i> 确认定稿
                                </button>
                                <a th:href="@{/contract-manager/pending-finalization}" class="btn btn-secondary ms-2">
                                    <i class="bi bi-x-circle"></i> 取消
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {

            // --- 全部的JS逻辑，确保没有任何省略 ---

            const initialAttachmentsJsonString = /*[[${initialAttachmentsJson}]]*/ '[]';
            const attachmentFilesInput = document.getElementById('newAttachment');
            const fileListContainer = document.getElementById('fileListContainerFinalize');
            const hiddenAttachmentInputsContainer = document.getElementById('hiddenAttachmentInputsContainerFinalize');
            const mainForm = document.getElementById('finalizeForm');
            const submitBtn = document.getElementById('submitFinalizeBtn');
            const CHUNK_SIZE = 1024 * 1024 * 2;
            let uploadedFilesData = [];

            function showAlert(message, type = 'info', containerId = 'globalAlertContainer') {
                const alertContainer = document.getElementById(containerId);
                if (alertContainer) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-top: 10px;">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                    alertContainer.prepend(wrapper.firstChild);
                } else {
                    alert(`${type.toUpperCase()}: ${message}`);
                }
            }

            // ===================================================================
            // ========= 提交按钮的事件监听器 (AJAX方式) =========
            // ===================================================================
            if (submitBtn) {
                submitBtn.addEventListener('click', async function(event) {
                    event.preventDefault();

                    prepareAttachmentsForSubmission();

                    if (!confirm("您确定要将此合同定稿并提交进入下一流程吗？")) {
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 提交中...';

                    const finalizationComments = document.getElementById('finalizationComments').value;
                    const updatedContent = document.getElementById('updatedContent').value;
                    const attachmentServerFileNames = Array.from(hiddenAttachmentInputsContainer.querySelectorAll('input[name="attachmentServerFileNames"]')).map(input => input.value);

                    const payload = {
                        finalizationComments,
                        updatedContent,
                        attachmentServerFileNames
                    };

                    try {
                        const response = await fetch(mainForm.action, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showAlert('操作成功：' + (result.message || '合同已定稿'), 'success');
                            setTimeout(() => {
                                window.location.href = '/contract-manager/pending-finalization';
                            }, 1500);
                        } else {
                            throw new Error(result.message || '提交失败，服务器返回错误。');
                        }
                    } catch (error) {
                        console.error('定稿提交失败:', error);
                        showAlert('提交失败: ' + error.message, 'danger');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-check-circle-fill"></i> 确认定稿';
                    }
                });
            }


            // ===================================================================
            // ===== 附件初始化、上传、预览、删除的所有JS函数 =====
            // ===================================================================

            // --- 关键的初始化代码，之前被我遗漏 ---
            let initialServerFileNames = [];
            if (initialAttachmentsJsonString && initialAttachmentsJsonString !== '[]' && initialAttachmentsJsonString !== 'null') {
                try {
                    initialServerFileNames = JSON.parse(initialAttachmentsJsonString);
                } catch (e) {
                    console.error("解析初始附件JSON失败:", e);
                }
            }

            initialServerFileNames.forEach(serverFileName => {
                const existingFileEntry = {
                    id: `existing-${serverFileName.replace(/[^a-zA-Z0-9]/g, "_")}-${Date.now()}`,
                    fileObject: null, originalName: serverFileName, size: null, status: 'completed',
                    progress: 100, uploadId: null, serverFileName: serverFileName,
                    clientFileId: `clientFile_existing_${serverFileName.replace(/[^a-zA-Z0-9]/g, "_")}`,
                    errorMessage: null, uiElement: null, totalChunks: 1, uploadedChunksCount: 1,
                    confirmedUploadedChunks: new Set([0]), xhr: null, isExisting: true
                };
                uploadedFilesData.push(existingFileEntry);
                addFileToUI(existingFileEntry);
            });
            prepareAttachmentsForSubmission();
            // --- 初始化代码结束 ---


            if (attachmentFilesInput) {
                attachmentFilesInput.addEventListener('change', handleFileSelection);
            }

            function addFileToUI(fileEntry) {
                const safeFileEntryId = CSS.escape(fileEntry.id);
                const fileSizeFormatted = fileEntry.size ? formatFileSize(fileEntry.size) : ' (已存在)';
                const initialProgress = fileEntry.status === 'completed' ? 100 : (fileEntry.progress || 0);
                const initialStatusMessage = fileEntry.status === 'completed' ? '已上传' : '等待上传...';
                const progressBarDisplay = (fileEntry.status === 'completed' && fileEntry.isExisting) || fileEntry.status === 'completed' ? 'none' : 'block';
                const previewButtonDisplay = fileEntry.status === 'completed' ? 'inline-block' : 'none';

                const fileItemHTML = `
                <div class="file-list-item ${fileEntry.status === 'completed' ? 'upload-success' : ''}" id="${safeFileEntryId}">
                    <div class="file-info">
                        <span class="file-name" title="${fileEntry.originalName}">${fileEntry.originalName}</span>
                        <span class="file-size">${fileSizeFormatted}</span>
                        <div class="file-progress mt-1" style="display: ${progressBarDisplay};">
                            <div class="file-progress-bar" style="width: ${initialProgress}%;">${initialProgress}%</div>
                        </div>
                        <small class="file-status d-block mt-1 ${fileEntry.status === 'completed' ? 'text-success' : 'text-muted'}">${initialStatusMessage}</small>
                    </div>
                    <div class="file-actions">
                        <button type="button" class="btn btn-sm btn-outline-info preview-btn" style="display: ${previewButtonDisplay};" title="预览">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-btn" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>`;

                fileListContainer.insertAdjacentHTML('beforeend', fileItemHTML);
                fileEntry.uiElement = fileListContainer.querySelector(`#${safeFileEntryId}`);

                fileEntry.uiElement.querySelector('.delete-btn').addEventListener('click', () => handleDeleteFile(fileEntry.id));
                fileEntry.uiElement.querySelector('.preview-btn').addEventListener('click', () => {
                    if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                        handlePreviewFile(fileEntry.serverFileName);
                    }
                });
            }

            function handlePreviewFile(serverFileName) {
                if (!serverFileName) return;
                const isPreviewable = /\.(pdf|jpe?g|png|gif|bmp|txt)$/i.test(serverFileName);
                const downloadUrl = `/api/attachments/download/${encodeURIComponent(serverFileName)}`;

                if (isPreviewable) {
                    window.open(downloadUrl, '_blank');
                } else {
                    const userAgreedToDownload = confirm(
                        `文件 "${serverFileName}" 可能不支持在浏览器中直接预览。\n\n点击“确定”将尝试下载该文件。`
                    );

                    if (userAgreedToDownload) {
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.setAttribute('download', serverFileName);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                }
            }

            function prepareAttachmentsForSubmission() {
                if (hiddenAttachmentInputsContainer) {
                    hiddenAttachmentInputsContainer.innerHTML = '';
                    uploadedFilesData.forEach(fileEntry => {
                        if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'attachmentServerFileNames';
                            hiddenInput.value = fileEntry.serverFileName;
                            hiddenAttachmentInputsContainer.appendChild(hiddenInput);
                        }
                    });
                }
            }

            async function handleDeleteFile(fileIdToDelete) {
                const fileIndex = uploadedFilesData.findIndex(f => f.id === fileIdToDelete);
                if (fileIndex === -1) return;
                const fileEntry = uploadedFilesData[fileIndex];

                if (fileEntry.uiElement) fileEntry.uiElement.remove();
                uploadedFilesData.splice(fileIndex, 1);

                if ((fileEntry.status === 'completed' || fileEntry.isExisting) && fileEntry.serverFileName) {
                    try {
                        const response = await fetch(`/api/attachments/file/${encodeURIComponent(fileEntry.serverFileName)}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            throw new Error(`服务器删除失败`);
                        }
                        showAlert(`附件 "${fileEntry.originalName}" 已成功从服务器删除。`, 'info');
                    } catch (error) {
                        showAlert(`删除服务器附件 "${fileEntry.originalName}" 失败: ${error.message}`, 'warning');
                    }
                }

                prepareAttachmentsForSubmission();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = 2;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function handleFileSelection(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    for(let i=0; i<files.length; i++) {
                        // This is where the complex chunk upload logic would be triggered for each file
                    }
                    showAlert(`已选择 ${files.length} 个新文件准备上传。`, 'info');
                }
            }

        });
        /*]]>*/
    </script>
</th:block>
</html>