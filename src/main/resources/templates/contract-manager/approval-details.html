<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}" lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>审批合同</title>
    <th:block layout:fragment="css-links">
        <link rel="stylesheet" type="text/css" th:href="@{/js/css/style.css}"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        <!-- 导航栏样式现在统一由 layout.html 管理 -->
    </th:block>
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #343a40; line-height: 1.6; }
        .container { padding: 30px; max-width: 900px; margin: 30px auto; background-color: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #212529; text-align: center; margin-bottom: 30px; font-size: 2rem; }
        .card { margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-header { background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; font-weight: 600; font-size: 1.1rem; color: #495057; border-top-left-radius: 8px; border-top-right-radius: 8px; display: flex; align-items: center; }
        .card-header i { margin-right: 10px; color: #007bff; }
        .card-body { padding: 20px; }
        .contract-info p { margin: 10px 0; font-size: 0.95rem; display: flex; align-items: baseline; }
        .contract-info strong { color: #495057; min-width: 100px; display: inline-block; }
        .contract-info span { flex-grow: 1; padding-left: 10px; }
        .contract-content { min-height: 180px; font-size: 0.95rem; color: #555; white-space: pre-wrap; word-wrap: break-word; }
        .approval-form h3 { margin-bottom: 20px; font-size: 1.25rem; color: #343a40; }
        .radio-group { margin: 10px 0; display: flex; align-items: center; }
        .radio-group input[type="radio"] { margin-right: 8px; transform: scale(1.1); }
        .radio-group label { font-size: 1rem; color: #343a40; cursor: pointer; }
        textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; margin: 10px 0 20px 0; min-height: 120px; font-size: 1rem; box-sizing: border-box; resize: vertical; }
        textarea:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.05rem; transition: background-color 0.2s ease, transform 0.1s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { transform: translateY(-2px); }
        .btn-approve { background-color: #28a745; color: white; }
        .btn-approve:hover { background-color: #218838; }
        .btn-reject { background-color: #dc3545; color: white; }
        .btn-reject:hover { background-color: #c82333; }
        .btn-cancel { background-color: #6c757d; color: white; }
        .btn-cancel:hover { background-color: #5a6268; }
        /* Attachment List Styles */
        .file-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; border: 1px solid #dee2e6; border-radius: 0.25rem; background-color: #f8f9fa; }
        .file-info { flex-grow: 1; margin-right: 1rem; overflow: hidden; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .file-status { font-size: 0.8em; color: #6c757d; }
        .file-actions button { margin-left: 0.5rem; }
    </style>
</head>
<body>

<section layout:fragment="content">
<div class="container">


    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <i class="bi bi-info-circle-fill me-2"></i>合同基本信息
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">合同编号</label>
                <div class="form-control form-control-sm bg-light" th:text="${contract.contractNumber ?: '-'}"></div>
            </div>
            <div class="mb-3">
                <label class="form-label">合同名称</label>
                <div class="form-control form-control-sm bg-light" th:text="${contract.contractName ?: '-'}"></div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">开始日期</label>
                    <div class="form-control form-control-sm bg-light" th:text="${contract.startDate != null ? #temporals.format(contract.startDate, 'yyyy-MM-dd') : '-'}"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">结束日期</label>
                    <div class="form-control form-control-sm bg-light" th:text="${contract.endDate != null ? #temporals.format(contract.endDate, 'yyyy-MM-dd') : '-'}"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">起草人</label>
                    <div class="form-control form-control-sm bg-light" th:text="${contract.drafter?.username ?: '-'}"></div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">起草日期</label>
                    <div class="form-control form-control-sm bg-light" th:text="${contract.createdAt != null ? #temporals.format(contract.createdAt, 'yyyy-MM-dd HH:mm') : '-'}"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <i class="bi bi-person-badge-fill me-2"></i>客户信息
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">签约客户</label>
                <div class="form-control form-control-sm bg-light" th:text="${contract.customer?.customerName ?: '-'}"></div>
            </div>
            <div class="card mt-2" th:if="${contract.customer != null}">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1 small"><strong th:text="${contract.customer?.customerName ?: '-'}"></strong></h6>
                    <p class="card-text mb-0 small">
                        <strong>编号:</strong> <span th:text="${contract.customer?.customerNumber ?: '-'}"></span> <br>
                                                                <strong>电话:</strong> <span th:text="${contract.customer?.phoneNumber ?: '-'}"></span> <br>
                                        <strong>邮箱:</strong> <span th:text="${contract.customer?.email ?: '-'}"></span> <br>
                        <strong>地址:</strong> <span th:text="${contract.customer?.address ?: '-'}"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <i class="bi bi-file-text-fill me-2"></i>合同条款与附件
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">合同主要内容</label>
                <div class="form-control form-control-sm bg-light" style="min-height: 150px; white-space: pre-wrap;" th:text="${contract.content ?: '暂无内容'}"></div>
            </div>
            <div class="mb-3">
                <label class="form-label">上传合同附件</label>
                <div id="attachmentListContainer"></div>
            </div>
        </div>
    </div>
    <div class="card" th:if="${allFinalizeProcesses != null and not #lists.isEmpty(allFinalizeProcesses)}">
        <div class="card-header"><i class="bi bi-person-lines-fill"></i>定稿意见汇总</div>
        <div class="card-body">
            <ul class="list-group list-group-flush">
                <li class="list-group-item" th:each="opinion : ${allFinalizeProcesses}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: '匿名用户'}"></h6>
                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : '未处理'}"></small>
                    </div>
                    <p class="mb-1" th:text="${opinion.comments != null and !opinion.comments.isEmpty() ? opinion.comments : '(无具体意见)'}"></p>
                    <small th:text="${opinion.state?.description ?: '未知状态'}"
                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                    </small>
                </li>
            </ul>
        </div>
    </div>

    <div class="card" th:if="${allApprovalProcesses != null and not #lists.isEmpty(allApprovalProcesses)}">
        <div class="card-header"><i class="bi bi-clipboard-check"></i>审批意见汇总</div>
        <div class="card-body">
            <ul class="list-group list-group-flush">
                <li class="list-group-item" th:each="opinion : ${allApprovalProcesses}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" th:text="${opinion.operatorUsername ?: '匿名用户'}"></h6>
                        <small class="text-muted" th:text="${opinion.processedAt != null ? #temporals.format(opinion.processedAt, 'yyyy-MM-dd HH:mm') : '未处理'}"></small>
                    </div>
                    <p class="mb-1" th:text="${opinion.comments != null and !opinion.comments.isEmpty() ? opinion.comments : '(无具体意见)'}"></p>
                    <small th:text="${opinion.state?.description ?: '未知状态'}"
                           th:classappend="${(opinion.state?.name() == 'APPROVED' or opinion.state?.name() == 'COMPLETED') ? 'text-success fw-bold' : (opinion.state?.name() == 'REJECTED' ? 'text-danger fw-bold' : 'text-muted')}">
                    </small>
                </li>
            </ul>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><i class="bi bi-ui-checks"></i>审批决定</div>
        <div class="card-body">
            <form th:action="@{/contract-manager/approve/{id}(id=${contract.id})}" method="post" class="approval-form">
                <div class="approval-options">
                    <div class="radio-group">
                        <input type="radio" id="approve" name="decision" value="APPROVED" required>
                        <label for="approve">通过</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="reject" name="decision" value="REJECTED">
                        <label for="reject">拒绝</label>
                    </div>
                </div>

                <div class="comments-section">
                    <label for="comments" style="font-weight: 600; margin-bottom: 5px; display: block;">审批意见：</label>
                    <textarea id="comments" name="comments" rows="5" required></textarea>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-approve"><i class="bi bi-check-circle me-2"></i>提交审批</button>
                    <a href="javascript:history.back()" class="btn btn-cancel"><i class="bi bi-x-circle me-2"></i>返回</a>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        // Alert dismissal logic
        var successMessage = /*[[${successMessage} ?: '']]*/ '';
        var errorMessage = /*[[${errorMessage} ?: '']]*/ '';
        window.onload = function() {
            if (successMessage && successMessage !== '') {
                alert(successMessage);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (errorMessage && errorMessage !== '') {
                alert(errorMessage);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        };

        // --- 完整的附件预览逻辑 ---
        document.addEventListener('DOMContentLoaded', function () {
            const attachmentContainer = document.getElementById('attachmentListContainer');
            const attachmentsJson = /*[[${contract?.attachmentPath}]]*/ null;

            function addExistingFileToUI(serverFileName) {
                if (!attachmentContainer) return;
                const safeId = `existing-${serverFileName.replace(/[^a-zA-Z0-9]/g, "_")}`;
                const fileItemHTML = `
                    <div class="file-list-item" id="${safeId}">
                        <div class="file-info">
                            <span class="file-name" title="${serverFileName}">${serverFileName}</span>
                        </div>
                        <div class="file-actions">
                            <button type="button" class="btn btn-sm btn-outline-info preview-btn" title="预览文件">
                                <i class="bi bi-eye"></i> 预览
                            </button>
                        </div>
                    </div>`;
                attachmentContainer.insertAdjacentHTML('beforeend', fileItemHTML);

                const newElement = document.getElementById(safeId);
                if (newElement) {
                    const previewBtn = newElement.querySelector('.preview-btn');
                    previewBtn.addEventListener('click', () => {
                        console.log('预览按钮被点击，文件名:', serverFileName);
                        handlePreviewFile(serverFileName);
                    });
                }
            }

            // --- 完整预览功能实现（支持21种格式）---
            function handlePreviewFile(serverFileName) {
                if (!serverFileName) {
                    console.error('预览失败：文件名为空');
                    alert('预览失败：文件名为空');
                    return;
                }
                
                console.log('开始预览文件:', serverFileName);
                const downloadUrl = `/api/attachments/download/${encodeURIComponent(serverFileName)}`;
                const fileExtension = serverFileName.toLowerCase().split('.').pop();
                
                // 定义各种文件类型的预览支持
                const previewableInBrowser = {
                    // 图片文件 - 浏览器原生支持
                    images: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'],
                    // PDF文件 - 浏览器原生支持
                    pdf: ['pdf'],
                    // 文本文件 - 浏览器原生支持
                    text: ['txt', 'csv', 'log', 'md', 'json', 'xml', 'html', 'css', 'js'],
                    // 音频文件 - 浏览器原生支持
                    audio: ['mp3', 'wav', 'ogg', 'aac', 'm4a'],
                    // 视频文件 - 浏览器原生支持
                    video: ['mp4', 'webm', 'ogg', 'mov']
                };
                
                // 需要下载的文件类型
                const downloadOnly = {
                    office: ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'],
                    archives: ['zip', 'rar', '7z', 'tar', 'gz'],
                    others: ['exe', 'msi', 'dmg', 'deb', 'rpm']
                };
                
                // 检查文件类型
                let canPreview = false;
                let fileCategory = '';
                
                for (const [category, extensions] of Object.entries(previewableInBrowser)) {
                    if (extensions.includes(fileExtension)) {
                        canPreview = true;
                        fileCategory = category;
                        break;
                    }
                }
                
                console.log(`文件 ${serverFileName} 类型检测: ${fileCategory}, 可预览: ${canPreview}`);
                
                if (canPreview) {
                    // 浏览器支持预览的文件直接打开
                    if (fileCategory === 'images') {
                        // 图片文件 - 创建更好的预览体验
                        openImagePreview(downloadUrl, serverFileName);
                    } else if (fileCategory === 'pdf') {
                        // PDF文件 - 提供选择：在线预览或下载
                        const userChoice = confirm(
                            `PDF文件 "${serverFileName}" 预览选项：\n\n` +
                            `点击"确定"在新窗口预览PDF\n` +
                            `点击"取消"下载到本地查看`
                        );
                        
                        if (userChoice) {
                            window.open(downloadUrl, '_blank');
                        } else {
                            downloadFile(downloadUrl, serverFileName);
                        }
                    } else if (fileCategory === 'text') {
                        // 文本文件 - 直接在新窗口打开
                        window.open(downloadUrl, '_blank');
                    } else if (fileCategory === 'audio' || fileCategory === 'video') {
                        // 音视频文件 - 创建媒体预览
                        openMediaPreview(downloadUrl, serverFileName, fileCategory);
                    }
                } else {
                    // 不支持预览的文件，提示用户下载
                    let downloadReason = '';
                    
                    if (downloadOnly.office.includes(fileExtension)) {
                        downloadReason = 'Office文档需要使用相应的办公软件打开';
                    } else if (downloadOnly.archives.includes(fileExtension)) {
                        downloadReason = '压缩包文件需要解压缩软件打开';
                    } else {
                        downloadReason = '此文件类型不支持在浏览器中直接预览';
                    }
                    
                    const userConfirmed = confirm(
                        `文件 "${serverFileName}" ${downloadReason}。\n\n点击"确定"下载文件到本地查看，点击"取消"关闭此对话框。`
                    );

                    if (userConfirmed) {
                        downloadFile(downloadUrl, serverFileName);
                    }
                }
            }
            
            // 图片预览功能
            function openImagePreview(imageUrl, fileName) {
                const uniqueId = Date.now();
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">图片预览: ${fileName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="preview-loading" id="imageLoading_${uniqueId}">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    正在加载图片...
                                </div>
                                <img src="${imageUrl}" class="img-fluid" style="max-height: 70vh; display: none;" alt="${fileName}" 
                                     onload="this.style.display='block'; document.getElementById('imageLoading_${uniqueId}').style.display='none';"
                                     onerror="this.onerror=null; this.style.display='none'; document.getElementById('imageLoading_${uniqueId}').style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="alert alert-warning mt-3" style="display: none;">
                                    <i class="bi bi-exclamation-triangle"></i> 图片加载失败，请尝试下载后查看
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">快捷键: ESC-关闭, D-下载</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFile('${imageUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> 下载
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // 模态框关闭后移除DOM元素
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                // 添加键盘快捷键支持
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFile(imageUrl, fileName);
                    }
                });
            }
            
            // 媒体文件（音频/视频）预览功能
            function openMediaPreview(mediaUrl, fileName, mediaType) {
                const isVideo = mediaType === 'video';
                const mediaTag = isVideo ? 'video' : 'audio';
                const mediaControls = isVideo ? 'controls width="100%" height="400"' : 'controls width="100%"';
                const uniqueId = Date.now();
                
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-${isVideo ? 'camera-video' : 'music-note'}"></i> 
                                    ${isVideo ? '视频' : '音频'}预览: ${fileName}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="preview-loading" id="mediaLoading_${uniqueId}">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    正在加载${isVideo ? '视频' : '音频'}...
                                </div>
                                <${mediaTag} ${mediaControls} preload="metadata" style="display: none;"
                                        onloadedmetadata="this.style.display='block'; document.getElementById('mediaLoading_${uniqueId}').style.display='none';"
                                        onerror="this.onerror=null; this.style.display='none'; document.getElementById('mediaLoading_${uniqueId}').style.display='none'; this.nextElementSibling.style.display='block';">
                                    <source src="${mediaUrl}" type="${mediaType}/${fileName.split('.').pop()}">
                                    您的浏览器不支持${isVideo ? '视频' : '音频'}播放。
                                </${mediaTag}>
                                <div class="alert alert-warning mt-3" style="display: none;">
                                    <i class="bi bi-exclamation-triangle"></i> ${isVideo ? '视频' : '音频'}加载失败，请尝试下载后查看
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">快捷键: ESC-关闭, D-下载, 空格-播放/暂停</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFile('${mediaUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> 下载
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // 模态框关闭后移除DOM元素
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                // 添加键盘快捷键支持
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFile(mediaUrl, fileName);
                    } else if (e.key === ' ') {
                        // 空格键暂停/播放媒体
                        e.preventDefault();
                        const mediaElement = modal.querySelector('video, audio');
                        if (mediaElement) {
                            if (mediaElement.paused) {
                                mediaElement.play();
                            } else {
                                mediaElement.pause();
                            }
                        }
                    }
                });
            }
            
            // 通用下载功能
            function downloadFile(fileUrl, fileName) {
                try {
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.setAttribute('download', fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`文件 "${fileName}" 开始下载`);
                } catch (error) {
                    console.error('下载失败:', error);
                    alert('下载失败，请稍后重试');
                }
            }

            // 初始化附件列表
            try {
                if (attachmentsJson && attachmentsJson !== '[]') {
                    const attachmentFiles = JSON.parse(attachmentsJson);
                    if (Array.isArray(attachmentFiles) && attachmentFiles.length > 0) {
                        attachmentContainer.innerHTML = '';
                        attachmentFiles.forEach(fileName => {
                            console.log('添加附件到UI:', fileName);
                            addExistingFileToUI(fileName);
                        });
                    } else {
                        attachmentContainer.innerHTML = '<p class="text-muted small">无附件。</p>';
                    }
                } else {
                    attachmentContainer.innerHTML = '<p class="text-muted small">无附件。</p>';
                }
            } catch (e) {
                console.error('解析附件JSON失败:', e, "JSON string was:", attachmentsJson);
                attachmentContainer.innerHTML = '<p class="text-danger small">加载附件列表失败。</p>';
            }
        });
    </script>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</div>

</section>
</body>
</html>