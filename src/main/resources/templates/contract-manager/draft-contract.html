    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{fragments/layout}" lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>起草新合同 - 合同管理系统</title>
        <th:block layout:fragment="css-links">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
        </th:block>
        <style layout:fragment="inline-css">
            .card-header { font-weight: 500; }
            #selectedCustomerInfoPlaceholder {
                padding: 0.575rem .75rem;
                border: 1px solid #dee2e6;
                border-left: 0;
                border-top-right-radius: .25rem;
                border-bottom-right-radius: .25rem;
                background-color: #e9ecef;
                line-height: 1.5;
                min-height: calc(1.5em + .5rem + 2px);
                display: flex;
                align-items: center;
                flex-grow: 1;
            }
            #customerTableModal tbody tr { cursor: pointer; }
            #customerTableModal tbody tr:hover { background-color: #f8f9fa; }
            .modal-xl { max-width: 900px; }
            .form-label { font-weight: 500; }
            .required-asterisk { color: var(--bs-danger); }
            #alertPlaceholder { min-height: 60px; transition: opacity 0.15s linear; }
            #alertPlaceholder:empty { min-height: 0; opacity: 0; }
            .form-text { font-size: .875em; }
            .is-invalid-placeholder {
                border-color: var(--bs-danger) !important;
            }

            /* Styles for multi-file upload list */
            .file-list-item {
                display: flex;
                flex-direction: column; /* 改为垂直布局，为进度条腾出空间 */
                padding: 1rem; /* 增加内边距 */
                margin-bottom: 0.75rem; /* 增加间距 */
                border: 1px solid #dee2e6;
                border-radius: 0.5rem; /* 更圆的边角 */
                background-color: #ffffff; /* 白色背景 */
                box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* 轻微阴影 */
                transition: all 0.3s ease; /* 平滑过渡 */
            }

            .file-list-item:hover {
                box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* 悬浮时更明显的阴影 */
                transform: translateY(-1px); /* 轻微上浮 */
            }

            .file-list-item-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                width: 100%;
            }
            .file-info {
                flex-grow: 1;
                margin-right: 1rem;
                overflow: hidden;
            }
            .file-name {
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: block;
            }
            .file-size, .file-status {
                font-size: 0.8em;
                color: #6c757d;
            }
            .file-actions button {
                margin-left: 0.5rem;
            }
            .file-progress {
                height: 24px; /* 增加高度，更明显 */
                margin: 8px 0; /* 增加上下边距 */
                background-color: #e9ecef;
                border-radius: .375rem; /* 更圆的边角 */
                overflow: hidden;
                border: 1px solid #ddd; /* 添加边框 */
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* 添加内阴影 */
                position: relative;
            }
            .file-progress-bar {
                background: linear-gradient(90deg, #0d6efd 0%, #198754 100%); /* 渐变色 */
                height: 100%;
                transition: width 0.3s ease-in-out; /* 更流畅的动画 */
                color: white;
                font-size: 0.8em; /* 稍大的字体 */
                font-weight: bold; /* 加粗文字 */
                line-height: 24px; /* 与高度匹配 */
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                min-width: 30px; /* 确保小百分比时也能看到文字 */
            }

            /* 上传中的动画效果 */
            .file-progress-bar.uploading {
                background: linear-gradient(90deg,
                    #0d6efd 0%,
                    #6610f2 25%,
                    #0d6efd 50%,
                    #6610f2 75%,
                    #0d6efd 100%);
                background-size: 200% 100%;
                animation: progress-shimmer 2s ease-in-out infinite;
            }

            /* 完成状态的绿色 */
            .file-progress-bar.completed {
                background: linear-gradient(90deg, #198754 0%, #20c997 100%);
            }

            /* 错误状态的红色 */
            .file-progress-bar.error {
                background: linear-gradient(90deg, #dc3545 0%, #fd7e14 100%);
            }

            @keyframes progress-shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            .file-list-item.upload-error {
                border-left: 5px solid var(--bs-danger);
                background-color: #fbe9e7;
            }
            .file-list-item.upload-success {
                border-left: 5px solid var(--bs-success);
                background-color: #e8f5e9;
            }
            .file-list-item.upload-need_file {
                border-left: 5px solid var(--bs-warning);
                background-color: #fff3cd;
                animation: pulse-warning 2s infinite;
            }
            @keyframes pulse-warning {
                0% { background-color: #fff3cd; }
                50% { background-color: #ffeaa7; }
                100% { background-color: #fff3cd; }
            }

            /* TinyMCE 内容中占位符的高亮样式 */
            .mce-content-body .contract-placeholder {
                background-color: #fff3cd;
                padding: 2px 4px;
                border-radius: 3px;
                border: 1px dashed #ffc107;
                font-weight: bold;
                display: inline-block;
                min-width: 50px;
                text-align: center;
                user-select: none;
                cursor: text;
                min-height: 1em;
                vertical-align: middle;
            }
            /* 当用户尝试选择或点击占位符时，允许文本选择/编辑 */
            .mce-content-body   .contract-placeholder:focus,
            .mce-content-body .contract-placeholder:active,
            .mce-content-body .contract-placeholder:hover {
                user-select: text;
            }
            /* 如果 span 为空，显示 data-placeholder-key 的值作为提示 */
            /* 由于JS已经默认填充了placeholderName，此CSS可能不再严格需要，但保留以防万一 */
            .mce-content-body .contract-placeholder:empty::before {
                content: attr(data-placeholder-key);
                color: #aaa;
                font-style: italic;
                pointer-events: none;
                display: inline-block;
            }

            /* 电子签名画布样式 */
            .signature-pad {
                border: 1px solid #ccc;
                border-radius: 4px;
                background-color: #fdfdfd;
                box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
            }
            .signature-preview {
                max-width: 100%;
                height: auto;
                border: 1px solid #ddd;
                margin-top: 10px;
                display: block;
            }

            /* 模态框样式优化 */
            .modal {
                padding-right: 0 !important;
            }
            .modal-backdrop {
                opacity: 0.5;
                z-index: 1040;
            }
            .modal-backdrop.fade {
                opacity: 0;
            }
            .modal-backdrop.show {
                opacity: 0.5;
            }
            
            /* 确保客户选择模态框的z-index高于其背景遮罩 */
            #customerSelectModal {
                z-index: 1055 !important;
            }
            
            /* 确保添加客户模态框的z-index更高 */
            #addCustomerFormModal {
                z-index: 1060 !important;
            }
            
            /* 防止模态框背景遮罩重叠问题 */
            .modal-backdrop:not(:last-of-type) {
                display: none !important;
            }
            /* 修复模态框滚动问题 */
            body.modal-open {
                overflow: hidden !important;
                padding-right: 0 !important;
            }
            /* 确保模态框内容可以滚动 */
            .modal-dialog {
                overflow-y: initial !important;
            }
            .modal-body {
                max-height: calc(100vh - 200px);
                overflow-y: auto;
            }
            #customerSelectModal .modal-dialog {
                margin: 1.75rem auto;
                max-width: 95%;
                height: auto;
                max-height: calc(100vh - 3.5rem);
            }
            #customerSelectModal .modal-content {
                height: 100%;
                display: flex;
                flex-direction: column;
                max-height: calc(100vh - 3.5rem);
                border-radius: 0.5rem;
            }
            #customerSelectModal .modal-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                padding: 0;
            }
            #customerSelectModal .table-responsive {
                flex: 1;
                overflow: auto;
                margin-bottom: 0;
                position: relative;
                -webkit-overflow-scrolling: touch; /* 改善移动端滚动体验 */
            }
            /* 自定义滚动条样式 */
            #customerSelectModal .table-responsive::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            #customerSelectModal .table-responsive::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            #customerSelectModal .table-responsive::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }
            #customerSelectModal .table-responsive::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            /* 其他样式保持不变 */
            #customerSelectModal thead {
                position: sticky;
                top: 0;
                z-index: 2;
                background: white;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            #customerSelectModal tbody tr {
                cursor: pointer;
                transition: all 0.2s ease;
            }
            #customerSelectModal tbody tr:hover {
                background-color: rgba(13, 110, 253, 0.1);
                transform: translateY(-1px);
            }
            #customerSelectModal .modal-footer {
                border-top: 1px solid #dee2e6;
                background: #f8f9fa;
                padding: 0.75rem;
                margin: 0;
            }
            #customerSelectModal .pagination {
                margin-bottom: 0;
                padding: 0.5rem 0;
            }
            #customerSelectModal .search-section {
                background: #f8f9fa;
                padding: 1rem;
                border-bottom: 1px solid #dee2e6;
                margin: 0;
                position: sticky;
                top: 0;
                z-index: 3;
            }

            /* 添加动画效果 */
            .modal.fade .modal-dialog {
                transform: translate(0, -30px);
                transition: transform 0.2s ease-out;
            }
            .modal.show .modal-dialog {
                transform: none;
            }

            /* 优化表格内容布局 */
            #customerTableModal th,
            #customerTableModal td {
                padding: 0.75rem;
                vertical-align: middle;
            }
            #customerTableModal .btn-action {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }

            /* 加载动画优化 */
            #customerModalSpinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                padding: 2rem;
                border-radius: 0.5rem;
                box-shadow: 0 0 15px rgba(0,0,0,0.1);
                z-index: 4;
            }
        </style>

        <script th:inline="javascript">

            // 强制清理所有模态框状态的函数
            function forceCleanModalState() {
                console.log('🧹 开始强制清理模态框状态...');
                
                // 强制移除所有背景遮罩
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach((backdrop, index) => {
                    console.log(`🧹 移除背景遮罩 ${index + 1}:`, backdrop);
                    backdrop.remove();
                });
                
                // 强制重置body状态
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                document.body.style.marginRight = '';
                
                // 移除所有可能的模态框状态类
                document.documentElement.classList.remove('modal-open');
                
                // 确保没有剩余的模态框显示状态
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    if (modal.id !== 'customerSelectModal') {
                        modal.classList.remove('show');
                        modal.style.display = 'none';
                    }
                });
                
                console.log('✅ 强制清理完成，body状态已重置');
            }

            // --- 新的、事件驱动的 showAddCustomerModal 函数 ---
            function showAddCustomerModal() {
                console.log('🚀 [标准嵌套流程] 开始显示"添加客户"模态框...');

                const customerSelectModalEl = document.getElementById('customerSelectModal');
                const addCustomerFormModalEl = document.getElementById('addCustomerFormModal');

                if (!customerSelectModalEl || !addCustomerFormModalEl) {
                    console.error('错误：一个或多个模态框元素未找到！');
                    return;
                }

                const customerSelectModal = bootstrap.Modal.getInstance(customerSelectModalEl);
                const addCustomerFormModal = bootstrap.Modal.getOrCreateInstance(addCustomerFormModalEl, {
                    backdrop: false,  // 禁用背景遮罩，保持页面可操作
                    keyboard: true,
                    focus: false     // 禁用焦点锁定，允许页面滚动
                });

                // 关键：监听第一个模态框"完全隐藏"的事件
                customerSelectModalEl.addEventListener('hidden.bs.modal', function onHidden() {
                    console.log('✅ 第一个模态框已完全隐藏，现在安全地显示第二个...');

                    // 重置表单
                    const form = document.getElementById('addCustomerFormInModal_draft');
                    if (form) {
                        form.reset();
                        form.classList.remove('was-validated');
                    }

                    // 显示第二个模态框
                    addCustomerFormModal.show();

                    // 恢复页面滚动功能
                    setTimeout(() => {
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        document.body.classList.remove('modal-open');
                    }, 100);

                    // 【重要】移除监听器，避免下次重复触发
                    customerSelectModalEl.removeEventListener('hidden.bs.modal', onHidden);
                }, { once: true }); // { once: true } 是另一种确保只监听一次的现代写法

                // 开始执行流程：隐藏第一个模态框
                if (customerSelectModal) {
                    console.log('⏳ 正在隐藏第一个模态框，等待它完成后再显示第二个...');
                    customerSelectModal.hide();
                } else {
                    // 如果第一个模态框不存在或未初始化，直接显示第二个
                    console.log('第一个模态框未初始化，直接显示第二个...');

                    // 重置表单
                    const form = document.getElementById('addCustomerFormInModal_draft');
                    if (form) {
                        form.reset();
                        form.classList.remove('was-validated');
                    }

                    // 确保无背景遮罩配置
                    const addCustomerModalNoBackdrop = bootstrap.Modal.getOrCreateInstance(addCustomerFormModalEl, {
                        backdrop: false,  // 禁用背景遮罩，保持页面可操作
                        keyboard: true,
                        focus: false     // 禁用焦点锁定，允许页面滚动
                    });
                    addCustomerModalNoBackdrop.show();

                    // 恢复页面滚动功能
                    setTimeout(() => {
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        document.body.classList.remove('modal-open');
                    }, 100);
                }
            }



            // --- 新的、事件驱动的 backToCustomerSelect 函数 (用于返回按钮) ---
            window.backToCustomerSelect = function() {
                console.log('🔄 [返回按钮] 被点击，准备返回"选择客户"模态框...');

                const customerSelectModalEl = document.getElementById('customerSelectModal');
                const addCustomerFormModalEl = document.getElementById('addCustomerFormModal');

                if (!customerSelectModalEl || !addCustomerFormModalEl) {
                    console.error('错误：一个或多个模态框元素未找到！');
                    return;
                }

                const customerSelectModal = bootstrap.Modal.getOrCreateInstance(customerSelectModalEl);
                const addCustomerFormModal = bootstrap.Modal.getInstance(addCustomerFormModalEl);

                // 监听第二个模态框“完全隐藏”的事件
                addCustomerFormModalEl.addEventListener('hidden.bs.modal', function onHidden() {
                    console.log('✅ 第二个模态框已完全隐藏，现在安全地显示第一个...');
                    
                    // 清理背景遮罩
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 1) {
                        console.log('🧹 发现多个背景遮罩，清理多余的遮罩');
                        for (let i = 1; i < backdrops.length; i++) {
                            backdrops[i].remove();
                        }
                    }
                    
                    // 重置body状态
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    
                    // 延迟一点点时间确保DOM状态完全重置
                    setTimeout(() => {
                        customerSelectModal.show();
                        // 重新加载客户数据
                        loadCustomerData('', 0);
                    }, 50);
                    
                    addCustomerFormModalEl.removeEventListener('hidden.bs.modal', onHidden);
                }, { once: true });

                // 立即强制清理状态，不等待事件
                forceCleanModalState();

                // 隐藏添加客户模态框
                if (addCustomerFormModal) {
                    console.log('⏳ 正在隐藏添加客户模态框...');
                    addCustomerFormModal.hide();
                }

                // 延迟显示客户选择模态框，确保状态完全清理
                setTimeout(() => {
                    // 再次强制清理
                    forceCleanModalState();
                    
                    // 销毁现有的模态框实例并重新创建
                    const existingModal = bootstrap.Modal.getInstance(customerSelectModalEl);
                    if (existingModal) {
                        existingModal.dispose();
                    }
                    
                    // 重新创建客户选择模态框实例，确保干净状态
                    const customerSelectModal = new bootstrap.Modal(customerSelectModalEl, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    customerSelectModal.show();
                    
                    // 重新加载客户数据
                    loadCustomerData('', 0);
                    
                    console.log('✅ 客户选择模态框重新显示完成');
                }, 300);
            };

            // 标准的隐藏"添加客户"模态框函数
            function hideAddCustomerModal() {
                const modalEl = document.getElementById('addCustomerFormModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    modal.hide();
                    
                    // 监听模态框隐藏事件，确保清理背景遮罩
                    modalEl.addEventListener('hidden.bs.modal', function onHidden() {
                        // 清理可能残留的背景遮罩
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // 重置body状态
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        modalEl.removeEventListener('hidden.bs.modal', onHidden);
                    }, { once: true });
                }
            }

            // 标准的隐藏"选择客户"模态框函数
            function hideCustomerSelectModal() {
                const modalEl = document.getElementById('customerSelectModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    modal.hide();
                    
                    // 监听模态框隐藏事件，确保清理背景遮罩
                    modalEl.addEventListener('hidden.bs.modal', function onHidden() {
                        // 清理可能残留的背景遮罩
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        
                        // 重置body状态
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        
                        modalEl.removeEventListener('hidden.bs.modal', onHidden);
                    }, { once: true });
                }
            }

            // 在模态框中显示提示消息的辅助函数
            function showAlertInModal(containerId, message, type) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';

                container.innerHTML = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        <i class="bi ${icon} me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                    }

        // 简单的提交客户表单函数
        function submitAddCustomerForm() {
            console.log('🔘 提交按钮被点击');
            
            const addCustomerForm = document.getElementById('addCustomerFormInModal_draft');
            
            // 表单验证
            if (!addCustomerForm.checkValidity()) {
                addCustomerForm.classList.add('was-validated');
                return;
            }
            
            handleAddCustomerFormSubmit();
        }

        // 添加客户表单AJAX提交处理函数
        function handleAddCustomerFormSubmit(e) {
            console.log('📤 开始提交客户信息');
            
            const addCustomerForm = document.getElementById('addCustomerFormInModal_draft');
            
            // 收集表单数据
            const formData = new FormData(addCustomerForm);
            
            // 显示提交中状态
            const submitBtn = document.getElementById('saveNewCustomerBtn_draft');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>提交中...';
            submitBtn.disabled = true;
            
            // AJAX提交
            fetch('/customers/api/add', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || '添加客户失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ 客户添加成功:', data);
                
                // 显示成功消息
                showAlertInModal('addCustomerModalAlertPlaceholder_draft', '客户添加成功！', 'success');
                
                // 重置表单
                addCustomerForm.reset();
                addCustomerForm.classList.remove('was-validated');
                
                // 延迟后自动返回选择客户界面
                setTimeout(() => {
                    window.backToCustomerSelect();
                }, 1500);
            })
            .catch(error => {
                console.error('❌ 添加客户失败:', error);
                showAlertInModal('addCustomerModalAlertPlaceholder_draft', error.message, 'danger');
            })
            .finally(() => {
                // 恢复按钮状态
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
            
            return false; // 确保阻止默认提交
        }

        // 在DOM加载完成后初始化 - 添加全局保护，避免重复初始化
            document.addEventListener('DOMContentLoaded', function() {
                // 防止重复初始化的标记
                if (window.formValidationInitialized) {
                    console.log('⚠️ 表单验证已初始化，跳过重复初始化');
                    return;
                }

                // 初始化表单验证
                const forms = document.querySelectorAll('.needs-validation');
                Array.from(forms).forEach(form => {
                    form.addEventListener('submit', function(event) {
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    });
                });

                // 标记已初始化
                window.formValidationInitialized = true;

                // 不再监听Bootstrap模态框事件，因为我们使用自定义显示方式
                console.log('✅ 添加客户模态框使用自定义显示方式，无需Bootstrap事件监听');

                // 页面加载时清理可能的残留状态
                forceCleanModalState();
                
                // 每10秒检查一次是否有残留的背景遮罩（用于调试）
                setInterval(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 0) {
                        console.log('⚠️ 发现残留的背景遮罩，自动清理...');
                        forceCleanModalState();
                    }
                }, 10000);

                // 添加全局点击事件，如果点击到背景遮罩就强制清理
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('modal-backdrop')) {
                        console.log('🔘 点击到背景遮罩，强制清理...');
                        forceCleanModalState();
                    }
                });
            });
        </script>
    </head>
    <body>

    <section layout:fragment="content">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0 h2"><i class="bi bi-file-earmark-plus-fill text-primary me-2"></i>起草新合同</h1>
                <a th:href="@{/dashboard}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left-circle me-1"></i>返回仪表盘
                </a>
            </div>

            <div id="alertPlaceholder">
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i> <span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${#fields.hasErrors('contractDraftRequest.*')}" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong><i class="bi bi-exclamation-circle-fill me-2"></i>请检查您的输入：</strong>
                    <ul class="mb-0 ps-4">
                        <li th:each="err : ${#fields.errors('contractDraftRequest.*')}" th:text="${err}"></li>
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${attachmentError}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${attachmentError}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>


            <form th:action="@{/contract-manager/draft}" method="post" th:object="${contractDraftRequest}" id="draftContractForm" class="needs-validation" novalidate>
                <div id="hiddenAttachmentInputsContainer"></div>
                <input type="hidden" id="placeholderValuesJson" name="placeholderValues">
                <input type="hidden" id="signatureDataPartyA" name="signatureDataPartyA">
                <input type="hidden" id="signatureDataPartyB" name="signatureDataPartyB">


                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light">
                        <i class="bi bi-info-circle-fill me-2"></i>合同基本信息
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="templateSelect" class="form-label">选择合同模板 (可选)</label>
                            <select class="form-select form-control-sm" id="templateSelect" th:field="*{templateId}">
                                <option value="">-- 不使用模板 --</option>
                                <option th:each="template : ${contractTemplates}"
                                        th:value="${template.id}"
                                        th:text="${template.templateName}"></option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="contractName" class="form-label">合同名称 <span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="contractName" th:field="*{contractName}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('contractName')}" th:errors="*{contractName}">合同名称不能为空。</div>
                            <div class="invalid-feedback">请输入合同名称。</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startDate" class="form-label">开始日期 <span class="required-asterisk">*</span></label>
                                <input type="date" class="form-control form-control-sm" id="startDate" th:field="*{startDate}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}">开始日期不能为空。</div>
                                <div class="invalid-feedback">请选择开始日期。</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endDate" class="form-label">结束日期 <span class="required-asterisk">*</span></label>
                                <input type="date" class="form-control form-control-sm" id="endDate" th:field="*{endDate}" required>
                                <div class="invalid-feedback" id="endDateValidationFeedback" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}">结束日期不能为空。</div>
                                <div class="invalid-feedback">结束日期不可以是过去时间</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light">
                        <i class="bi bi-person-badge-fill me-2"></i>客户信息
                    </div>
                    <div class="card-body">
                        <label class="form-label">签约客户 <span class="required-asterisk">*</span></label>
                        <div class="input-group input-group-sm">
                                            <button class="btn btn-sm btn-outline-primary" type="button" id="openCustomerSelectModalBtn"
                            onclick="openCustomerSelectModal()" style="min-width: 110px;"
                            data-bypass-unified-manager="true">
                                <i class="bi bi-search me-1"></i> 选择客户
                            </button>
                            <div id="selectedCustomerInfoPlaceholder" class="form-control-sm"> <span class="text-muted">尚未选择客户</span>
                            </div>
                        </div>
                        <input type="hidden" id="selectedCustomerId" th:field="*{selectedCustomerId}" required>
                        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('selectedCustomerId')}" th:errors="*{selectedCustomerId}"></div>
                        <div class="invalid-feedback" id="selectedCustomerIdClientFeedback">请选择一个签约客户。</div>

                        <div id="selectedCustomerDetailsCard" class="card mt-2" style="display: none;">
                            <div class="card-body p-2">
                                <h6 class="card-title mb-1 small"><strong id="selectedCustomerNameText"></strong></h6>
                                <p class="card-text mb-0 small">
                                    <strong>编号:</strong> <span id="selectedCustomerNumberText"></span> <br>
                                    <strong>电话:</strong> <span id="selectedCustomerPhoneText"></span> <br>
                                    <strong>邮箱:</strong> <span id="selectedCustomerEmailText"></span> <br>
                                    <strong>地址:</strong> <span id="selectedCustomerAddressText"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light">
                        <i class="bi bi-file-text-fill me-2"></i>合同条款与附件
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="contractContent" class="form-label">合同主要内容</label>
                            <textarea class="form-control form-control-sm" id="contractContent" rows="8" th:field="*{contractContent}" placeholder="请在此处填写合同的核心条款和内容..."></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('contractContent')}" th:errors="*{contractContent}"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">甲方签字 <span class="required-asterisk">*</span></label>
                            <div class="card">
                                <div class="card-body">
                                    <p class="small text-muted mb-2">请在下方画布上签名，或上传您的签名图片。</p>
                                    <canvas id="signatureCanvasPartyA" class="signature-pad" width="300" height="100"></canvas>
                                    <div class="d-flex mt-2 mb-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyA"><i class="bi bi-x-circle me-1"></i>清空签名</button>
                                        <label for="uploadSignatureInputPartyA" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>上传签名图片</label>
                                        <input type="file" id="uploadSignatureInputPartyA" accept="image/png, image/jpeg" style="display: none;">
                                    </div>
                                    <img id="signaturePreviewPartyA" class="signature-preview" style="display:none;">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">乙方签字 <span class="required-asterisk">*</span></label>
                            <div class="card">
                                <div class="card-body">
                                    <p class="small text-muted mb-2">请在下方画布上签名，或上传您的签名图片。</p>
                                    <canvas id="signatureCanvasPartyB" class="signature-pad" width="300" height="100"></canvas>
                                    <div class="d-flex mt-2 mb-2">
                                        <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyB"><i class="bi bi-x-circle me-1"></i>清空签名</button>
                                        <label for="uploadSignatureInputPartyB" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>上传签名图片</label>
                                        <input type="file" id="uploadSignatureInputPartyB" accept="image/png, image/jpeg" style="display: none;">
                                    </div>
                                    <img id="signaturePreviewPartyB" class="signature-preview" style="display:none;">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                        <label for="attachmentFilesInput" class="form-label mb-0">上传合同附件 (可选, 可多选)</label>
                        <button type="button" id="fileTypeHelpBtn" class="btn btn-outline-info btn-sm" onclick="showFileTypeHelp()">
                            <i class="bi bi-question-circle me-1"></i>支持的文件类型
                        </button>
                    </div>
                    <input type="file" class="form-control form-control-sm mt-2" id="attachmentFilesInput" multiple>
                            <div class="form-text mb-2">
                                <i class="bi bi-info-circle text-info me-1"></i>
                                支持Office文档、PDF、图片、压缩包、多媒体等多种格式。普通文件最大10MB，压缩包/多媒体文件最大100MB。
                                <br><small class="text-muted">可按住Ctrl/Shift选择多个文件，支持断点续传。</small>
                            </div>

                            <div id="fileListContainer" class="mt-2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary btn-lg px-5 me-3" id="submitDraftContractBtn">
                        <i class="bi bi-save-fill me-2"></i>确认起草并提交
                    </button>
                    <button type="reset" class="btn btn-outline-secondary btn-lg px-4">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>全部重置
                    </button>
                </div>
            </form>
        </div>

        <!-- 客户选择模态框 -->
        <div class="modal fade" id="customerSelectModal" tabindex="-1" aria-labelledby="customerSelectModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customerSelectModalLabel">
                            <i class="bi bi-people-fill me-2"></i>选择签约客户
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <!-- 搜索区域 -->
                        <div class="search-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="input-group input-group-sm flex-grow-1 me-2" style="max-width: 400px;">
                                    <span class="input-group-text bg-white">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" id="customerSearchKeyword" class="form-control border-start-0"
                                           placeholder="输入客户名称或编号搜索...">
                                </div>
                                <button type="button" class="btn btn-success btn-sm" id="addNewCustomerBtnInModal" onclick="showAddCustomerModal()">
                                    <i class="bi bi-plus-circle me-1"></i>添加新客户
                                </button>
                            </div>
                        </div>

                        <!-- 提示信息区域 -->
                        <div id="customerModalAlertPlaceholder" class="px-3"></div>

                        <!-- 表格区域 -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="customerTableModal">
                                <thead class="table-light">
                                    <tr>
                                        <th>客户编号</th>
                                        <th>客户名称</th>
                                        <th>联系电话</th>
                                        <th>邮箱</th>
                                        <th class="text-center">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="customerSelectTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- 加载动画 -->
                        <div id="customerModalSpinner" class="d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>

                        <!-- 分页区域 -->
                        <nav aria-label="客户分页" id="customerSelectPagination" class="border-top">
                            <ul class="pagination pagination-sm justify-content-center">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加客户模态框 - 完全自定义显示，不使用Bootstrap Modal功能 -->
        <div class="modal fade" id="addCustomerFormModal" tabindex="-1" aria-labelledby="addCustomerFormModalLabel" aria-hidden="true" data-bs-backdrop="false" data-bs-keyboard="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="addCustomerFormInModal_draft" class="needs-validation" novalidate>
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="addCustomerFormModalLabel">
                                <i class="bi bi-person-plus-fill me-2"></i>快速添加新客户
                            </h5>
                            <button type="button" class="btn-close btn-close-white" onclick="hideAddCustomerModal()" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="addCustomerModalAlertPlaceholder_draft" class="mb-3"></div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new_draft_customerNumber" class="form-label">客户编号 <span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control form-control-sm" name="customerNumber"
                                           id="new_draft_customerNumber" required placeholder="例如: CUST-2025-001">
                                    <div class="invalid-feedback">请输入客户编号。</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="new_draft_customerName" class="form-label">客户名称 <span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control form-control-sm" name="customerName"
                                           id="new_draft_customerName" required placeholder="请输入完整的客户官方名称">
                                    <div class="invalid-feedback">请输入客户名称。</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="new_draft_phoneNumber" class="form-label">联系电话 <span class="required-asterisk">*</span></label>
                                    <input type="tel" class="form-control form-control-sm" name="phoneNumber"
                                           id="new_draft_phoneNumber" required placeholder="请输入联系电话">
                                    <div class="invalid-feedback">请输入联系电话。</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="new_draft_email" class="form-label">邮箱 <span class="required-asterisk">*</span></label>
                                    <input type="email" class="form-control form-control-sm" name="email"
                                           id="new_draft_email" required placeholder="请输入邮箱地址">
                                    <div class="invalid-feedback">请输入有效的邮箱地址。</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="new_draft_address" class="form-label">地址</label>
                                    <input type="text" class="form-control form-control-sm" name="address"
                                           id="new_draft_address" placeholder="请输入客户地址（可选）">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" id="backToSelectCustomerBtn" onclick="window.backToCustomerSelect()">
                                <i class="bi bi-arrow-left-short"></i> 返回选择
                            </button>
                                                    <button type="button" class="btn btn-success" id="saveNewCustomerBtn_draft" onclick="submitAddCustomerForm()">
                            <i class="bi bi-check-circle-fill me-1"></i>确认并保存客户
                        </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script th:inline="javascript">
        // 重复的函数定义已删除 - 使用head部分的唯一版本

        // 紧急停止重复调用的全局函数
        window.stopAddCustomerModal = function() {
            window.addCustomerModalShowing = true;
            console.log('🛑 紧急停止添加客户模态框调用');
        };

        // 重置状态的全局函数
        window.resetAddCustomerModal = function() {
            window.addCustomerModalShowing = false;
            console.log('🔄 重置添加客户模态框状态');
        };

        document.addEventListener('DOMContentLoaded', function() {
            // 防止重复绑定的标记
            if (window.addCustomerButtonBound) {
                console.log('⚠️ 添加客户按钮事件已绑定，跳过重复绑定');
                return;
            }

            console.log('ℹ️ 添加新客户按钮使用onclick属性，无需JavaScript事件绑定');

            /*
            // 冲突的事件监听器已注释掉 - 改用onclick属性
            document.addEventListener('click', function(e) {
                if (e.target.id === 'addNewCustomerBtnInModal') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔘 添加新客户按钮被点击');
                    showAddCustomerModal();
                }
            });
            */

            // 标记已绑定
            window.addCustomerButtonBound = true;

                // 添加新客户的处理函数已移至全局作用域

                // 返回按钮现在使用onclick属性，无需JavaScript事件绑定
                console.log('ℹ️ 返回选择按钮使用onclick属性，无需JavaScript事件绑定');

                // 关闭按钮现在使用onclick属性，无需JavaScript事件绑定
                console.log('ℹ️ 关闭按钮使用onclick属性，无需JavaScript事件绑定');

                            // 绑定添加客户表单提交事件 - 使用AJAX提交避免页面跳转
            const addCustomerForm = document.getElementById('addCustomerFormInModal_draft');
            if (addCustomerForm) {
                console.log('🔗 绑定添加客户表单AJAX提交事件');
                // 移除可能存在的旧事件监听器
                addCustomerForm.removeEventListener('submit', handleAddCustomerFormSubmit);
                // 添加新的事件监听器
                addCustomerForm.addEventListener('submit', handleAddCustomerFormSubmit);
                
                // 为提交按钮添加点击事件
                const submitBtn = document.getElementById('saveNewCustomerBtn_draft');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('🔘 提交按钮被点击');
                        
                        // 表单验证
                        if (!addCustomerForm.checkValidity()) {
                            addCustomerForm.classList.add('was-validated');
                            return;
                        }
                        
                        // 调用处理函数
                        handleAddCustomerFormSubmit(e);
                    });
                }
            }

                // 由于使用自定义显示方式，不需要监听Bootstrap模态框事件
                console.log('✅ 模态框事件处理已简化');
                    // 直接执行，不需要延迟
        });
    </script>

    <!-- 直接嵌入文件类型帮助模态框 -->
    <div class="modal fade" id="fileTypeHelpModal" tabindex="-1" aria-labelledby="fileTypeHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="fileTypeHelpModalLabel">
                        <i class="bi bi-info-circle-fill me-2"></i>支持的文件类型说明
                    </h5>
                    <button type="button" class="btn-close btn-close-white" onclick="hideFileTypeHelp()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="bi bi-file-earmark-text"></i> 文档类型</h6>
                            <ul class="list-unstyled mb-4">
                                <li><span class="badge bg-secondary me-2">PDF</span>便携式文档格式</li>
                                <li><span class="badge bg-secondary me-2">DOC/DOCX</span>Microsoft Word 文档</li>
                                <li><span class="badge bg-secondary me-2">XLS/XLSX</span>Microsoft Excel 表格</li>
                                <li><span class="badge bg-secondary me-2">PPT/PPTX</span>Microsoft PowerPoint 演示文稿</li>
                                <li><span class="badge bg-secondary me-2">TXT</span>纯文本文件</li>
                                <li><span class="badge bg-secondary me-2">RTF</span>富文本格式</li>
                            </ul>

                            <h6 class="text-success"><i class="bi bi-image"></i> 图片类型</h6>
                            <ul class="list-unstyled mb-4">
                                <li><span class="badge bg-success me-2">JPG/JPEG</span>常用照片格式</li>
                                <li><span class="badge bg-success me-2">PNG</span>透明背景图片</li>
                                <li><span class="badge bg-success me-2">GIF</span>动画图片</li>
                                <li><span class="badge bg-success me-2">BMP</span>位图格式</li>
                                <li><span class="badge bg-success me-2">WEBP</span>现代Web图片格式</li>
                                <li><span class="badge bg-success me-2">SVG</span>矢量图形</li>
                                <li><span class="badge bg-success me-2">TIFF</span>高质量图片</li>
                            </ul>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-warning"><i class="bi bi-file-zip"></i> 压缩文件</h6>
                            <ul class="list-unstyled mb-4">
                                <li><span class="badge bg-warning text-dark me-2">ZIP</span>通用压缩格式</li>
                                <li><span class="badge bg-warning text-dark me-2">RAR</span>WinRAR压缩格式</li>
                                <li><span class="badge bg-warning text-dark me-2">7Z</span>7-Zip压缩格式</li>
                                <li><span class="badge bg-warning text-dark me-2">TAR</span>Unix归档格式</li>
                                <li><span class="badge bg-warning text-dark me-2">GZIP</span>GNU压缩格式</li>
                            </ul>

                            <h6 class="text-danger"><i class="bi bi-play-circle"></i> 多媒体文件</h6>
                            <ul class="list-unstyled mb-4">
                                <li><span class="badge bg-danger me-2">MP4</span>视频文件</li>
                                <li><span class="badge bg-danger me-2">AVI</span>视频文件</li>
                                <li><span class="badge bg-danger me-2">MP3</span>音频文件</li>
                                <li><span class="badge bg-danger me-2">WAV</span>无损音频</li>
                            </ul>

                            <h6 class="text-info"><i class="bi bi-code-square"></i> 数据文件</h6>
                            <ul class="list-unstyled">
                                <li><span class="badge bg-info me-2">JSON</span>数据交换格式</li>
                                <li><span class="badge bg-info me-2">XML</span>标记语言</li>
                                <li><span class="badge bg-info me-2">CSV</span>逗号分隔值文件</li>
                            </ul>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <h6 class="alert-heading"><i class="bi bi-info-circle"></i> 文件大小限制：</h6>
                        <ul class="mb-0">
                            <li><strong>普通文件</strong>：最大 10MB</li>
                            <li><strong>压缩包/多媒体文件</strong>：最大 100MB (提高限制支持大型压缩包)</li>
                        </ul>
                    </div>

                    <div class="alert alert-success mt-3">
                        <h6 class="alert-heading"><i class="bi bi-check-circle"></i> 支持功能：</h6>
                        <ul class="mb-0">
                            <li>✅ 断点续传：网络中断后可继续上传</li>
                            <li>✅ 自动重试：失败后智能重试机制</li>
                            <li>✅ 在线预览：PDF、图片、文本、多媒体文件</li>
                            <li>✅ 安全下载：所有文件类型均可下载</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideFileTypeHelp()">
                        <i class="bi bi-x-circle me-1"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>


    <th:block layout:fragment="scripts">
        <script src="https://cdn.tiny.cloud/1/epd4u3q4czck41xhryufu73clhe4jzhzc0bxvnmw9t0z6ayk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            document.addEventListener('DOMContentLoaded', function () {
                // 防止重复初始化的标记
                if (window.tinyMceEditorInitialized) {
                    console.log('⚠️ TinyMCE编辑器已初始化，跳过重复初始化');
                    return;
                }

                // TinyMCE 初始化
                let contractEditor;

                tinymce.init({
                    selector: '#contractContent',
                    // 修正插件列表：移除可能不存在或有问题的插件，例如 'print', 'paste'
                    // 确保只包含您确实需要且当前版本支持的插件
                    plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount autoresize',
                    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                    autoresize_bottom_margin: 20,
                    menubar: false,
                    setup: function (editor) {
                        contractEditor = editor;
                        console.log('📝 TinyMCE 编辑器开始设置');
                        editor.on('change', function () {
                            editor.save();
                        });
                        // 确保编辑器初始化完成后再尝试操作，避免 'getRng' 错误
                        editor.on('init', function() {
                            console.log('✅ TinyMCE 编辑器初始化完成');
                            // 如果 templateSelect 有初始值，触发其change事件以加载内容
                            const templateSelect = document.getElementById('templateSelect');
                            console.log('🔍 检查模板选择下拉框:', templateSelect ? '元素存在' : '元素不存在');
                            if (templateSelect) {
                                console.log('🔍 模板选择下拉框值:', templateSelect.value);
                                if (templateSelect.value) {
                                    console.log('🔄 触发模板选择change事件，初始值:', templateSelect.value);
                                    templateSelect.dispatchEvent(new Event('change'));
                                } else {
                                    console.log('🔍 模板选择下拉框无初始值');
                                }
                            } else {
                                console.log('❌ 模板选择下拉框元素不存在');
                            }
                        });
                    }
                });

                // 标记TinyMCE已初始化
                window.tinyMceEditorInitialized = true;

                console.log("DEBUG: DOMContentLoaded 事件触发 - 脚本开始执行。");

                // 客户选择功能由通用模态框管理器处理

                // 添加网络错误检查
                function checkNetworkConnectivity() {
                    return fetch('/customers/api/search?keyword=&page=0&size=1', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`网络请求失败: ${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("DEBUG: 网络连接正常，API响应:", data);
                        return true;
                    })
                    .catch(error => {
                        console.error("ERROR: 网络连接或API错误:", error);
                        showAlertOnMainPage('网络连接异常，无法加载客户数据。请检查网络连接并刷新页面。', 'danger');
                        return false;
                    });
                }

                // === 客户选择功能实现 ===
                const openCustomerSelectModalBtn = document.getElementById('openCustomerSelectModalBtn');
                const customerSelectModal = document.getElementById('customerSelectModal');
                const customerSelectTableBody = document.getElementById('customerSelectTableBody');
                const customerSearchKeyword = document.getElementById('customerSearchKeyword');
                const modalSearchCustomerBtn = document.getElementById('modalSearchCustomerBtn');
                const selectedCustomerId = document.getElementById('selectedCustomerId');
                const selectedCustomerInfoPlaceholder = document.getElementById('selectedCustomerInfoPlaceholder');
                const selectedCustomerDetailsCard = document.getElementById('selectedCustomerDetailsCard');

                // 客户选择按钮点击事件
                if (openCustomerSelectModalBtn) {
                    console.log('✅ 找到客户选择按钮，绑定点击事件');
                    openCustomerSelectModalBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🔘 客户选择按钮被点击');
                        // 使用专门的客户选择模态框显示函数，避免背景变暗问题
                        showCustomerSelectModal();
                        loadCustomerData('', 0);
                    }, true); // 使用捕获阶段，确保优先处理
                } else {
                    console.error('❌ 未找到客户选择按钮元素 #openCustomerSelectModalBtn');
                }

                // 备用方案：为按钮添加全局点击处理
                window.openCustomerSelectModal = function() {
                    console.log('🔘 通过全局函数打开客户选择模态框');
                    // 使用专门的客户选择模态框显示函数，避免背景变暗问题
                    showCustomerSelectModal();
                    loadCustomerData('', 0);
                };

                // 专门的客户选择模态框显示函数 - 无背景遮罩，无变暗效果
                function showCustomerSelectModal() {
                    const modal = document.getElementById('customerSelectModal');
                    if (modal) {
                        // 完全无背景遮罩的显示方式
                        modal.style.display = 'block';
                        modal.classList.add('show');

                        // 清理任何可能存在的背景遮罩
                        const existingBackdrop = document.querySelector('.custom-modal-backdrop');
                        if (existingBackdrop) {
                            existingBackdrop.remove();
                        }

                        // 设置模态框样式 - 完全透明背景，无遮挡
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100%';
                        modal.style.height = '100%';
                        modal.style.zIndex = '1050';
                        modal.style.backgroundColor = 'transparent'; // 完全透明，无遮挡
                        modal.style.overflow = 'auto';
                        modal.style.pointerEvents = 'none'; // 模态框本身不阻挡点击

                        // 确保模态框内容可以交互
                        const modalDialog = modal.querySelector('.modal-dialog');
                        if (modalDialog) {
                            modalDialog.style.position = 'relative';
                            modalDialog.style.zIndex = '1055';
                            modalDialog.style.pointerEvents = 'auto'; // 只有对话框内容可以点击
                            modalDialog.style.margin = '1.75rem auto';
                            modalDialog.style.backgroundColor = 'white'; // 确保对话框有背景色
                            modalDialog.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.15)'; // 添加阴影突出显示
                            modalDialog.style.borderRadius = '0.375rem'; // 圆角
                        }

                        // 完全不修改 body 样式，页面保持正常状态

                        // 不再在这里绑定添加客户按钮，已在页面加载时全局绑定
                        console.log('ℹ️ 添加客户按钮事件已在页面加载时绑定，无需重复处理');

                        console.log('✅ 客户选择模态框已显示，无背景遮罩，页面完全正常');
                    }
                }

                // 专门的客户选择模态框隐藏函数
                function hideCustomerSelectModal() {
                    const modal = document.getElementById('customerSelectModal');
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');

                        // 清理任何可能的背景遮罩（虽然我们不创建它们）
                        const backdrop = document.querySelector('.custom-modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }

                        console.log('✅ 客户选择模态框已隐藏');
                    }
                }

                // 客户搜索功能
                if (modalSearchCustomerBtn) {
                    modalSearchCustomerBtn.addEventListener('click', function() {
                        const keyword = customerSearchKeyword.value.trim();
                        loadCustomerData(keyword, 0);
                    });
                }

                if (customerSearchKeyword) {
                    customerSearchKeyword.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            const keyword = this.value.trim();
                            loadCustomerData(keyword, 0);
                        }
                    });
                }

                // 加载客户数据
                async function loadCustomerData(keyword = '', page = 0) {
                    const spinner = document.getElementById('customerModalSpinner');
                    const tbody = document.getElementById('customerSelectTableBody');

                    if (spinner) spinner.style.display = 'block';
                    if (tbody) tbody.innerHTML = '';

                    try {
                        const response = await fetch(`/customers/api/search?keyword=${encodeURIComponent(keyword)}&page=${page}&size=10`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('客户数据加载成功:', data);

                        if (tbody) {
                            tbody.innerHTML = '';
                            if (data.content && data.content.length > 0) {
                                data.content.forEach((customer, index) => {
                                    console.log(`🔍 客户 ${index + 1} 数据:`, customer);
                                    console.log(`📞 客户 ${index + 1} 电话:`, customer.phoneNumber);
                                    console.log(`📧 客户 ${index + 1} 邮箱:`, customer.email);
                                    const row = createCustomerRow(customer);
                                    tbody.appendChild(row);
                                });
                            } else {
                                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">没有找到客户数据</td></tr>';
                            }
                        }

                        // 更新分页
                        updateCustomerPagination(data, keyword);

                    } catch (error) {
                        console.error('加载客户数据失败:', error);
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">加载失败：' + error.message + '</td></tr>';
                        }
                    } finally {
                        if (spinner) spinner.style.display = 'none';
                    }
                }

                // 创建客户行
                function createCustomerRow(customer) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.customerNumber || ''}</td>
                        <td>${customer.customerName || ''}</td>
                        <td>${customer.phoneNumber || ''}</td>
                        <td>${customer.email || ''}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-primary select-customer-btn"
                                    data-customer-id="${customer.id}"
                                    data-customer-name="${customer.customerName}"
                                    data-customer-number="${customer.customerNumber}"
                                    data-customer-phone="${customer.phoneNumber || ''}"
                                    data-customer-email="${customer.email || ''}"
                                    data-customer-address="${customer.address || ''}">
                                <i class="bi bi-check-circle me-1"></i>选择
                            </button>
                        </td>
                    `;

                    // 选择客户按钮事件
                    const selectBtn = row.querySelector('.select-customer-btn');
                    selectBtn.addEventListener('click', function() {
                        const customerId = this.dataset.customerId;
                        const customerName = this.dataset.customerName;
                        const customerNumber = this.dataset.customerNumber;
                        const customerPhone = this.dataset.customerPhone;
                        const customerEmail = this.dataset.customerEmail;
                        const customerAddress = this.dataset.customerAddress;

                        selectCustomer({
                            id: customerId,
                            customerName: customerName,
                            customerNumber: customerNumber,
                            phoneNumber: customerPhone,
                            email: customerEmail,
                            address: customerAddress
                        });
                    });

                    return row;
                }

                // 选择客户
                function selectCustomer(customer) {
                    console.log('🔍 选择客户函数被调用，客户数据:', customer);
                    console.log('📞 电话号码:', customer.phoneNumber);
                    console.log('📧 邮箱:', customer.email);
                    console.log('🏠 地址:', customer.address);
                    
                    if (selectedCustomerId) selectedCustomerId.value = customer.id;

                    if (selectedCustomerInfoPlaceholder) {
                        selectedCustomerInfoPlaceholder.innerHTML = `
                            <i class="bi bi-person-check-fill text-success me-2"></i>
                            <strong>${customer.customerName}</strong> (${customer.customerNumber})
                        `;
                        selectedCustomerInfoPlaceholder.classList.remove('is-invalid-placeholder');
                    }

                    // 填充客户详情卡片
                    if (selectedCustomerDetailsCard) {
                        document.getElementById('selectedCustomerNameText').textContent = customer.customerName;
                        document.getElementById('selectedCustomerNumberText').textContent = customer.customerNumber;
                        document.getElementById('selectedCustomerPhoneText').textContent = customer.phoneNumber || '无';
                        document.getElementById('selectedCustomerEmailText').textContent = customer.email || '无';
                        document.getElementById('selectedCustomerAddressText').textContent = customer.address || '无';
                        selectedCustomerDetailsCard.style.display = 'block';
                    }

                    // 隐藏模态框
                    hideCustomerSelectModal();
                    console.log('客户选择完成:', customer);
                }

                // 更新分页
                function updateCustomerPagination(data, keyword) {
                    const pagination = document.getElementById('customerSelectPagination');
                    if (!pagination) return;

                    const ul = pagination.querySelector('ul');
                    if (!ul) return;

                    ul.innerHTML = '';

                    if (data.totalPages <= 1) return;

                    const currentPage = data.number;
                    const totalPages = data.totalPages;

                    // 上一页
                    const prevLi = document.createElement('li');
                    prevLi.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
                    prevLi.innerHTML = `<a class="page-link" href="#">上一页</a>`;
                    if (currentPage > 0) {
                        prevLi.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadCustomerData(keyword, currentPage - 1);
                        });
                    }
                    ul.appendChild(prevLi);

                    // 页码
                    for (let i = 0; i < totalPages; i++) {
                        const li = document.createElement('li');
                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                        li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
                        li.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadCustomerData(keyword, i);
                        });
                        ul.appendChild(li);
                    }

                    // 下一页
                    const nextLi = document.createElement('li');
                    nextLi.className = `page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}`;
                    nextLi.innerHTML = `<a class="page-link" href="#">下一页</a>`;
                    if (currentPage < totalPages - 1) {
                        nextLi.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadCustomerData(keyword, currentPage + 1);
                        });
                    }
                    ul.appendChild(nextLi);
                }

                // 为客户选择模态框的关闭按钮添加事件监听
                const customerModalCloseButtons = document.querySelectorAll('#customerSelectModal .btn-close, #customerSelectModal [data-bs-dismiss="modal"]');
                customerModalCloseButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        hideCustomerSelectModal();
                    });
                });

                // 点击模态框背景关闭
                const customerModal = document.getElementById('customerSelectModal');
                if (customerModal) {
                    customerModal.addEventListener('click', function(e) {
                        if (e.target === customerModal) {
                            hideCustomerSelectModal();
                        }
                    });
                }

                // === 客户选择功能结束 ===

                // === 文件上传状态管理 ===

                // 保存上传状态到localStorage
                function saveUploadState() {
                    try {
                        const uploadState = {
                            files: uploadedFilesData.map(file => ({
                                id: file.id,
                                fileName: file.file.name,
                                fileSize: file.file.size,
                                fileType: file.file.type,
                                status: file.status,
                                progress: file.progress,
                                uploadedBytes: file.uploadedBytes || 0,
                                serverFileName: file.serverFileName,
                                uploadId: file.uploadId,
                                retryCount: file.retryCount || 0
                            }))
                        };
                        localStorage.setItem('draftContractUploadState', JSON.stringify(uploadState));
                    } catch (error) {
                        console.warn('保存上传状态失败:', error);
                    }
                }

                // 从localStorage加载上传状态
                function loadUploadState() {
                    try {
                        const saved = localStorage.getItem('draftContractUploadState');
                        return saved ? JSON.parse(saved) : null;
                    } catch (error) {
                        console.warn('加载上传状态失败:', error);
                        return null;
                    }
                }

                // 清理上传状态
                function clearUploadState() {
                    try {
                        localStorage.removeItem('draftContractUploadState');
                    } catch (error) {
                        console.warn('清理上传状态失败:', error);
                    }
                }

                function prepareAttachmentsForSubmission() {
                    // 清空现有的隐藏input
                    hiddenAttachmentInputsContainer.innerHTML = '';

                    // 为每个已完成上传的文件创建隐藏input
                    uploadedFilesData.forEach((fileEntry, index) => {
                        if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = `attachments[${index}].serverFileName`;
                            hiddenInput.value = fileEntry.serverFileName;
                            hiddenAttachmentInputsContainer.appendChild(hiddenInput);

                            const originalNameInput = document.createElement('input');
                            originalNameInput.type = 'hidden';
                            originalNameInput.name = `attachments[${index}].originalFileName`;
                            originalNameInput.value = fileEntry.file.name;
                            hiddenAttachmentInputsContainer.appendChild(originalNameInput);
                        }
                    });

                    console.log(`📎 准备了${hiddenAttachmentInputsContainer.children.length / 2}个附件提交`);
                }

                // 页面加载时恢复上传状态
                function restoreUploadStateOnPageLoad() {
                    const saved = loadUploadState();
                    if (saved && saved.files && saved.files.length > 0) {
                        console.log(`🔄 恢复${saved.files.length}个文件的上传状态`);

                        saved.files.forEach(savedEntry => {
                            // 创建虚拟文件对象用于显示
                            const virtualFile = new File([''], savedEntry.fileName, {
                                type: 'application/octet-stream',
                                lastModified: Date.now()
                            });

                            const fileEntry = {
                                id: savedEntry.id,
                                file: virtualFile,
                                fileName: savedEntry.fileName,
                                fileSize: savedEntry.fileSize,
                                status: savedEntry.status,
                                progress: savedEntry.progress,
                                uploadedBytes: savedEntry.uploadedBytes || 0,
                                serverFileName: savedEntry.serverFileName,
                                uploadId: savedEntry.uploadId,
                                retryCount: savedEntry.retryCount || 0,
                                maxRetries: 3,
                                chunkSize: 1024 * 1024
                            };

                            uploadedFilesData.push(fileEntry);
                            addFileToUI(fileEntry);

                            // 如果是未完成的上传，标记需要重新选择文件
                            if (fileEntry.status !== 'completed') {
                                fileEntry.status = 'error';
                                updateFileUIStatus(fileEntry);

                                // 显示需要重新选择文件的提示
                                const statusSpan = document.querySelector(`#file-item-${fileEntry.id} .file-status`);
                                if (statusSpan) {
                                    statusSpan.innerHTML = '⚠️ 需要重新选择文件以继续上传';
                                    statusSpan.className = 'file-status d-block text-warning';
                                }
                            }
                        });

                        // 提示用户
                        if (saved.files.some(f => f.status !== 'completed')) {
                            showAlertOnMainPage('检测到未完成的文件上传，请重新选择相应文件以继续上传。', 'info', 8000);
                        }
                    }
                }

                // 页面卸载时保存状态
                window.addEventListener('beforeunload', function() {
                    saveUploadState();
                });

                // 在页面加载完成后恢复状态
                try {
                    restoreUploadStateOnPageLoad();
                    console.log('✅ 文件上传状态恢复完成');
                } catch (error) {
                    console.error('❌ 文件上传状态恢复失败:', error);
                }

                // 为文件类型帮助按钮添加处理函数
                window.showFileTypeHelp = function() {
                    showModal('fileTypeHelpModal');
                };

                window.hideFileTypeHelp = function() {
                    hideModal('fileTypeHelpModal');
                };

                // 添加Chrome第三方Cookie警告处理
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    // 忽略Chrome扩展相关的错误
                    window.addEventListener('error', function(event) {
                        if (event.message && event.message.includes('chrome')) {
                            console.warn('Chrome扩展相关错误已忽略:', event.message);
                            event.preventDefault();
                            return false;
                        }
                    });
                }

                // 添加全局错误处理
                window.addEventListener('unhandledrejection', function(event) {
                    console.error('未处理的Promise拒绝:', event.reason);
                    if (event.reason && event.reason.message && event.reason.message.includes('客户')) {
                        showAlertOnMainPage('客户数据加载出现问题，请刷新页面重试', 'warning');
                    }
                });

                console.log("DEBUG: draft-contract.html 的内联脚本主要逻辑执行完毕。");

                // 检查Bootstrap是否正确加载
                if (typeof bootstrap !== 'undefined') {
                    console.log("Bootstrap 5 JS 成功加载并可用。");

                    // 手动初始化下拉菜单
                    const adminMenuDropdown = document.getElementById('adminMenuDropdown');
                    const userDropdown = document.getElementById('userDropdown');

                    if (adminMenuDropdown) {
                        console.log("手动初始化 Bootstrap Dropdown: adminMenuDropdown");
                        new bootstrap.Dropdown(adminMenuDropdown);
                    }

                    if (userDropdown) {
                        console.log("手动初始化 Bootstrap Dropdown: userDropdown");
                        new bootstrap.Dropdown(userDropdown);
                    }
                } else {
                    console.error("Bootstrap 5 JS 未正确加载！");
                    showAlertOnMainPage('页面脚本加载异常，部分功能可能不可用', 'warning');
                }

                // --- 开始：现有客户选择和 Bootstrap 验证逻辑 ---
                (function () {
                    'use strict'
                    var forms = document.querySelectorAll('.needs-validation');
                    var customerIdField = document.getElementById('selectedCustomerId');
                    var customerIdClientFeedback = document.getElementById('selectedCustomerIdClientFeedback');
                    var customerInfoPlaceholder = document.getElementById('selectedCustomerInfoPlaceholder');

                    // 获取日期输入字段
                    const startDateField = document.getElementById('startDate');
                    const endDateField = document.getElementById('endDate');
                    const endDateValidationFeedback = document.getElementById('endDateValidationFeedback');

                    Array.prototype.slice.call(forms)
                        .forEach(function (form) {
                            form.addEventListener('submit', function (event) {
                                // 在这里添加新的表单提交预处理逻辑
                                if (form.id === 'draftContractForm') {
                                    // 1. 从 TinyMCE 内容中提取占位符值并填充到 placeholderValuesJson
                                    extractAndPreparePlaceholderValues();
                                    // 2. 从签名画布中获取签名数据
                                    prepareSignatureForSubmission('PartyA');
                                    prepareSignatureForSubmission('PartyB');
                                    // 3. 准备附件数据
                                    prepareAttachmentsForSubmission();
                                }

                                let isFormValid = form.checkValidity();

                                if (form.id === 'draftContractForm') {
                                    // 客户ID验证
                                    if (customerIdField && customerIdField.required && customerIdField.value === '') {
                                        if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'block';
                                        if (customerInfoPlaceholder) customerInfoPlaceholder.classList.add('is-invalid-placeholder');
                                        isFormValid = false;
                                    } else if (customerIdField) {
                                        if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'none';
                                        if (customerInfoPlaceholder) customerInfoPlaceholder.classList.remove('is-invalid-placeholder');
                                    }

                                    // 结束日期不能为过去时间的新验证
                                    if (endDateField && endDateField.value) {
                                        const selectedEndDate = new Date(endDateField.value);
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);

                                        if (selectedEndDate < today) {
                                            endDateField.classList.add('is-invalid');
                                            if (endDateValidationFeedback) {
                                                endDateValidationFeedback.textContent = '结束日期不能早于今天。';
                                                endDateValidationFeedback.style.display = 'block';
                                            }
                                            isFormValid = false;
                                        } else {
                                            endDateField.classList.remove('is-invalid');
                                            if (endDateValidationFeedback) {
                                                endDateValidationFeedback.textContent = '结束日期不能为空。';
                                                if (!endDateField.dataset.thymeleafErrors) {
                                                    endDateValidationFeedback.style.display = 'none';
                                                }
                                            }
                                        }
                                    }
                                }

                                if (!isFormValid) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                }
                                form.classList.add('was-validated');
                            }, false);
                        });

                    // 实时验证结束日期何时更改
                    if (endDateField) {
                        endDateField.addEventListener('change', function() {
                            const selectedEndDate = new Date(this.value);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            if (selectedEndDate < today) {
                                this.classList.add('is-invalid');
                                if (endDateValidationFeedback) {
                                    endDateValidationFeedback.textContent = '结束日期不能早于今天。';
                                    endDateValidationFeedback.style.display = 'block';
                                }
                            } else {
                                this.classList.remove('is-invalid');
                                if (endDateValidationFeedback) {
                                    endDateValidationFeedback.textContent = '结束日期不能为空。';
                                    if (!this.dataset.thymeleafErrors) {
                                        endDateValidationFeedback.style.display = 'none';
                                    }
                                }
                            }
                        });

                        if (endDateField.classList.contains('is-invalid') && endDateValidationFeedback && endDateValidationFeedback.textContent !== '结束日期不能为空。') {
                            endDateField.dataset.thymeleafErrors = 'true';
                            endDateValidationFeedback.style.display = 'block';
                        }
                    }

                })();
                // --- 客户选择和验证逻辑结束 ---
    // --- 开始：精准的模态框嵌套切换逻辑 ---
                const customerSelectModalEl = document.getElementById('customerSelectModal');
                const addCustomerFormModalEl = document.getElementById('addCustomerFormModal');

                // 确保两个模态框元素都存在，才进行后续操作，保证代码安全
                if (customerSelectModalEl && addCustomerFormModalEl) {
                    // 注释掉重复的事件绑定，因为我们在上面已经绑定了
                    console.log('✅ 模态框元素已找到，跳过重复绑定');
                }
                // --- 嵌套切换逻辑结束 ---

                // 所有客户模态框相关函数已迁移到通用模态框管理器

                console.log('🚀 开始初始化文件上传功能...');

                const attachmentFilesInput = document.getElementById('attachmentFilesInput');
                const fileListContainer = document.getElementById('fileListContainer');
                const hiddenAttachmentInputsContainer = document.getElementById('hiddenAttachmentInputsContainer');
                const mainDraftForm = document.getElementById('draftContractForm');

                console.log('🔍 页面元素检查结果:');
                console.log('  - attachmentFilesInput:', attachmentFilesInput ? '✅找到' : '❌未找到');
                console.log('  - fileListContainer:', fileListContainer ? '✅找到' : '❌未找到');
                console.log('  - hiddenAttachmentInputsContainer:', hiddenAttachmentInputsContainer ? '✅找到' : '❌未找到');
                console.log('  - mainDraftForm:', mainDraftForm ? '✅找到' : '❌未找到');

                let uploadedFilesData = [];
                let fileUploadQueue = [];
                let isUploading = false;

                // 持久化存储键名
                const STORAGE_KEY = 'contract_draft_uploads';
                const STORAGE_EXPIRY_HOURS = 24; // 24小时后过期

                if (attachmentFilesInput) {
                    console.log('✅ 文件上传输入元素已找到，绑定change事件');
                    attachmentFilesInput.addEventListener('change', handleFileSelection);
                } else {
                    console.error('❌ 未找到文件上传输入元素 #attachmentFilesInput');
                }

                // === 断点续传文件上传功能 ===
                function handleFileSelection(event) {
                    const files = event.target.files;
                    console.log(`🔄 用户选择了 ${files.length} 个文件`);
                    if (files.length === 0) return;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        console.log(`📄 处理文件 ${i+1}: ${file.name}, 类型: ${file.type}, 大小: ${(file.size/1024/1024).toFixed(2)}MB`);

                        // 验证文件类型和大小
                        if (!validateFile(file)) continue;

                        // 检查是否是续传文件
                        const existingEntry = findExistingFileEntry(file);
                        if (existingEntry) {
                            console.log(`🔄 发现续传文件: ${file.name}`);
                            resumeFileUpload(existingEntry, file);
                        } else {
                            // 新文件上传
                            const fileEntry = createFileEntry(file, i);
                            uploadedFilesData.push(fileEntry);
                            addFileToUI(fileEntry);
                            fileUploadQueue.push(fileEntry);
                            saveUploadState();
                        }
                    }

                    attachmentFilesInput.value = '';
                    processFileUploadQueue();
                }

                // 验证文件类型和大小
                function validateFile(file) {
                    const allowedTypes = [
                        'application/pdf', 'application/msword',
                        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                        'text/plain', 'application/rtf', 'image/jpeg', 'image/png', 'image/gif', 'image/bmp',
                        'image/webp', 'image/tiff', 'image/svg+xml', 'application/zip',
                        'application/x-zip-compressed', 'application/x-rar-compressed', 'application/vnd.rar',
                        'application/x-rar', 'application/x-7z-compressed', 'application/x-tar',
                        'application/gzip', 'application/x-gzip', 'audio/mpeg', 'audio/wav',
                        'video/mp4', 'video/avi', 'application/json', 'text/csv',
                        'application/xml', 'text/xml'
                    ];

                    const fileName = file.name.toLowerCase();
                    const isAllowedByMimeType = allowedTypes.includes(file.type);
                    const isAllowedByExtension = /\.(pdf|docx?|xlsx?|pptx?|txt|rtf|jpe?g|png|gif|bmp|webp|tiff|svg|zip|rar|7z|tar|gz|mp[34]|avi|mp3|wav|json|xml|csv)$/i.test(fileName);

                    if (!isAllowedByMimeType && !isAllowedByExtension) {
                        showAlertOnMainPage(`❌ 文件 "${file.name}" 类型不被支持。<br><small>支持：Office文档、PDF、图片、压缩包、多媒体文件等</small>`, 'danger');
                        return false;
                    }

                    // 动态文件大小限制
                    const maxSize = getMaxSizeForFile(file.type, file.name);
                    if (file.size > maxSize) {
                        const sizeLimitMB = Math.round(maxSize / 1024 / 1024);
                        const fileTypeName = maxSize > 10 * 1024 * 1024 ? '压缩包/多媒体文件' : '普通文件';
                        showAlertOnMainPage(`❌ 文件 "${file.name}" 大小超过${fileTypeName}的${sizeLimitMB}MB限制。<br><small>当前: ${(file.size/1024/1024).toFixed(2)}MB</small>`, 'danger');
                        return false;
                    }

                    return true;
                }

                function getMaxSizeForFile(fileType, fileName) {
                    const ext = fileName.toLowerCase();
                    const isLargeFile = ext.match(/\.(zip|rar|7z|tar|gz|mp4|avi|mp3|wav)$/) ||
                                      fileType.startsWith('video/') || fileType.startsWith('audio/') ||
                                      fileType.includes('compressed') || fileType.includes('zip');

                    return isLargeFile ? 100 * 1024 * 1024 : 10 * 1024 * 1024; // 100MB 或 10MB
                }

                // 查找已存在的文件条目（支持续传）
                function findExistingFileEntry(file) {
                    const saved = loadUploadState();
                    if (!saved || !saved.files) return null;
                    return saved.files.find(entry =>
                        entry.fileName === file.name &&
                        entry.fileSize === file.size &&
                        entry.status !== 'completed'
                    );
                }

                // 创建文件条目
                function createFileEntry(file, index) {
                    return {
                        id: Date.now() + '-' + index,
                        file: file,
                        fileName: file.name,
                        fileSize: file.size,
                        status: 'pending',
                        progress: 0,
                        uploadedBytes: 0,
                        serverFileName: null,
                        uploadId: null,
                        chunkSize: 1024 * 1024, // 1MB分块
                        retryCount: 0,
                        maxRetries: 3
                    };
                }

                // 恢复文件上传
                function resumeFileUpload(existingEntry, newFile) {
                    console.log(`🔄 恢复上传: ${existingEntry.fileName}, 已上传: ${existingEntry.uploadedBytes}/${existingEntry.fileSize}`);

                    // 更新文件对象为新选择的文件
                    existingEntry.file = newFile;

                    // 如果已经在UI中显示，更新状态
                    const existingUI = document.getElementById(`file-item-${existingEntry.id}`);
                    if (!existingUI) {
                        addFileToUI(existingEntry);
                    }

                    // 添加到上传队列
                    fileUploadQueue.push(existingEntry);

                    // 更新现有条目
                    const existingIndex = uploadedFilesData.findIndex(entry => entry.id === existingEntry.id);
                    if (existingIndex === -1) {
                        uploadedFilesData.push(existingEntry);
                    } else {
                        uploadedFilesData[existingIndex] = existingEntry;
                    }
                }

                // === UI管理和进度显示 ===
                function addFileToUI(fileEntry) {
                    if (!fileListContainer) return;

                    // 检查是否已存在UI元素
                    const existingItem = document.getElementById(`file-item-${fileEntry.id}`);
                    if (existingItem) {
                        updateFileUIStatus(fileEntry);
                        return;
                    }

                    const listItem = document.createElement('div');
                    listItem.id = `file-item-${fileEntry.id}`;
                    listItem.classList.add('file-list-item');

                    const fileInfo = document.createElement('div');
                    fileInfo.classList.add('file-info');

                    // 显示续传信息
                    const resumeInfo = fileEntry.uploadedBytes > 0 ?
                        ` <small class="text-info">(续传: ${((fileEntry.uploadedBytes / fileEntry.fileSize) * 100).toFixed(1)}%)</small>` : '';

                    fileInfo.innerHTML = `
                        <span class="file-name" title="${fileEntry.file.name}">${fileEntry.file.name}${resumeInfo}</span>
                        <span class="file-size">${(fileEntry.file.size / 1024 / 1024).toFixed(2)} MB</span>
                        <span class="file-status" data-status="${fileEntry.status}">
                            ${getStatusText(fileEntry.status)}
                        </span>
                    `;
                    listItem.appendChild(fileInfo);

                    const fileActions = document.createElement('div');
                    fileActions.classList.add('file-actions');

                    // 预览按钮
                    const previewBtn = document.createElement('button');
                    previewBtn.classList.add('btn', 'btn-sm', 'btn-outline-info', 'me-2', 'preview-btn');
                    previewBtn.innerHTML = '<i class="bi bi-eye"></i> 预览';
                    previewBtn.style.display = fileEntry.status === 'completed' ? 'inline-block' : 'none';
                    previewBtn.addEventListener('click', () => {
                        if (fileEntry.serverFileName) {
                            handlePreviewFile(fileEntry.serverFileName);
                        }
                    });
                    fileActions.appendChild(previewBtn);

                    // 重试按钮
                    const retryBtn = document.createElement('button');
                    retryBtn.classList.add('btn', 'btn-sm', 'btn-warning', 'me-2', 'retry-btn');
                    retryBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 重试';
                    retryBtn.style.display = fileEntry.status === 'error' ? 'inline-block' : 'none';
                    retryBtn.addEventListener('click', () => retryUpload(fileEntry.id));
                    fileActions.appendChild(retryBtn);

                    // 暂停/恢复按钮
                    const pauseBtn = document.createElement('button');
                    pauseBtn.classList.add('btn', 'btn-sm', 'btn-secondary', 'me-2', 'pause-btn');
                    pauseBtn.innerHTML = '<i class="bi bi-pause"></i> 暂停';
                    pauseBtn.style.display = 'none';
                    pauseBtn.addEventListener('click', () => toggleUploadPause(fileEntry.id));
                    fileActions.appendChild(pauseBtn);

                    // 移除按钮
                    const removeBtn = document.createElement('button');
                    removeBtn.classList.add('btn', 'btn-sm', 'btn-danger', 'remove-btn');
                    removeBtn.innerHTML = '<i class="bi bi-x-circle"></i> 移除';
                    removeBtn.addEventListener('click', () => removeFile(fileEntry.id));
                    fileActions.appendChild(removeBtn);

                    listItem.appendChild(fileActions);

                    // 进度条容器
                    const progressBarContainer = document.createElement('div');
                    progressBarContainer.classList.add('file-progress');

                    const progressBar = document.createElement('div');
                    progressBar.classList.add('file-progress-bar');
                    const initialProgress = fileEntry.uploadedBytes > 0 ?
                        (fileEntry.uploadedBytes / fileEntry.fileSize) * 100 : 0;
                    progressBar.style.width = `${initialProgress}%`;
                    progressBar.textContent = `${initialProgress.toFixed(1)}%`;

                    // 如果正在上传，添加动画效果
                    if (fileEntry.status === 'uploading') {
                        progressBar.classList.add('uploading');
                    }

                    progressBarContainer.appendChild(progressBar);

                    // 分块进度信息
                    const chunkInfo = document.createElement('small');
                    chunkInfo.classList.add('chunk-info', 'text-muted', 'd-block', 'mt-1');
                    chunkInfo.style.display = 'none';
                    progressBarContainer.appendChild(chunkInfo);

                    listItem.appendChild(progressBarContainer);

                    // 根据状态设置样式
                    updateFileUIStatus(fileEntry);

                    fileListContainer.appendChild(listItem);
                }

                function updateFileUIStatus(fileEntry) {
                    const listItem = document.getElementById(`file-item-${fileEntry.id}`);
                    if (!listItem) return;

                    const statusSpan = listItem.querySelector('.file-status');
                    const previewBtn = listItem.querySelector('.preview-btn');
                    const retryBtn = listItem.querySelector('.retry-btn');
                    const pauseBtn = listItem.querySelector('.pause-btn');
                    const removeBtn = listItem.querySelector('.remove-btn');

                    if (statusSpan) {
                        statusSpan.textContent = getStatusText(fileEntry.status);
                        statusSpan.setAttribute('data-status', fileEntry.status);
                    }

                    // 移除所有状态类
                    listItem.classList.remove('upload-error', 'upload-success', 'upload-uploading', 'upload-paused');

                    // 根据状态添加相应的类和显示按钮
                    switch (fileEntry.status) {
                        case 'completed':
                            listItem.classList.add('upload-success');
                            if (previewBtn) previewBtn.style.display = 'inline-block';
                            if (retryBtn) retryBtn.style.display = 'none';
                            if (pauseBtn) pauseBtn.style.display = 'none';
                            break;
                        case 'error':
                            listItem.classList.add('upload-error');
                            if (previewBtn) previewBtn.style.display = 'none';
                            if (retryBtn) retryBtn.style.display = 'inline-block';
                            if (pauseBtn) pauseBtn.style.display = 'none';
                            break;
                        case 'uploading':
                            listItem.classList.add('upload-uploading');
                            if (previewBtn) previewBtn.style.display = 'none';
                            if (retryBtn) retryBtn.style.display = 'none';
                            if (pauseBtn) {
                                pauseBtn.style.display = 'inline-block';
                                pauseBtn.innerHTML = '<i class="bi bi-pause"></i> 暂停';
                            }
                            break;
                        case 'paused':
                            listItem.classList.add('upload-paused');
                            if (pauseBtn) {
                                pauseBtn.innerHTML = '<i class="bi bi-play"></i> 继续';
                                pauseBtn.style.display = 'inline-block';
                            }
                            break;
                        default:
                            if (retryBtn) retryBtn.style.display = 'none';
                            if (pauseBtn) pauseBtn.style.display = 'none';
                            if (previewBtn) previewBtn.style.display = 'none';
                    }
                }

                function getStatusText(status) {
                    const statusMap = {
                        'pending': '⏳ 等待上传',
                        'uploading': '⬆️ 上传中',
                        'paused': '⏸️ 已暂停',
                        'completed': '✅ 上传完成',
                        'error': '❌ 上传失败'
                    };
                    return statusMap[status] || status;
                }

                function updateFileProgress(fileId, progress, uploadedBytes = 0, chunkInfo = '') {
                    const progressBar = document.querySelector(`#file-item-${fileId} .file-progress-bar`);
                    const chunkInfoElement = document.querySelector(`#file-item-${fileId} .chunk-info`);

                    if (progressBar) {
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress.toFixed(1)}%`;

                        // 移除所有状态类
                        progressBar.classList.remove('uploading', 'completed', 'error');

                        // 根据进度应用不同的视觉效果
                        if (progress >= 100) {
                            progressBar.classList.add('completed');
                        } else if (progress > 0) {
                            progressBar.classList.add('uploading');
                        }
                    }

                    if (chunkInfoElement && chunkInfo) {
                        chunkInfoElement.textContent = chunkInfo;
                        chunkInfoElement.style.display = 'block';
                    } else if (chunkInfoElement) {
                        chunkInfoElement.style.display = 'none';
                    }

                    // 更新文件条目的上传字节数
                    const fileEntry = uploadedFilesData.find(entry => entry.id === fileId);
                    if (fileEntry) {
                        fileEntry.progress = progress;
                        fileEntry.uploadedBytes = uploadedBytes;
                        saveUploadState();
                    }
                }

                function updateFileStatusUI(fileId, status, message = '') {
                    const listItem = document.getElementById(`file-item-${fileId}`);
                    if (listItem) {
                        // 清除所有状态类
                        listItem.classList.remove('upload-pending', 'upload-uploading', 'upload-completed', 'upload-error', 'upload-need_file');
                        listItem.classList.add(`upload-${status}`);

                        const fileInfo = listItem.querySelector('.file-info');
                        const retryBtn = listItem.querySelector('.btn-warning');
                        const previewBtn = listItem.querySelector('.btn-outline-info');

                        if (fileInfo) {
                            // 先移除已存在的状态span
                            const existingStatusSpan = fileInfo.querySelector('.file-status');
                            if (existingStatusSpan) {
                                existingStatusSpan.remove();
                            }

                            // 创建新的状态span
                            const statusSpan = document.createElement('span');
                            statusSpan.classList.add('file-status', 'd-block');

                            if (status === 'completed') {
                                statusSpan.classList.add('text-success');
                                statusSpan.textContent = '(上传成功)';
                                if (retryBtn) retryBtn.style.display = 'none';
                                if (previewBtn) previewBtn.style.display = 'inline-block'; // 显示预览按钮
                            } else if (status === 'error') {
                                statusSpan.classList.add('text-danger');
                                statusSpan.textContent = `(上传失败: ${message})`;
                                if (retryBtn) retryBtn.style.display = 'inline-block'; // 显示重试按钮

                                // 为进度条添加错误样式
                                const progressBar = listItem.querySelector('.file-progress-bar');
                                if (progressBar) {
                                    progressBar.classList.remove('uploading', 'completed');
                                    progressBar.classList.add('error');
                                }
                            } else if (status === 'uploading') {
                                statusSpan.classList.add('text-info');
                                statusSpan.textContent = message || '(上传中...)';
                                if (retryBtn) retryBtn.style.display = 'none';
                            } else if (status === 'paused') {
                                statusSpan.classList.add('text-warning');
                                statusSpan.textContent = `(已暂停: ${message})`;
                                if (retryBtn) retryBtn.style.display = 'inline-block'; // 显示重试按钮
                            } else if (status === 'need_file') {
                                statusSpan.classList.add('text-warning');
                                statusSpan.innerHTML = `⚠️ ${message}`;

                                // 为需要选择文件的状态创建特殊的选择文件按钮
                                if (retryBtn) {
                                    retryBtn.style.display = 'inline-block';
                                    retryBtn.textContent = '🔄 选择文件继续上传';
                                    retryBtn.classList.remove('btn-warning');
                                    retryBtn.classList.add('btn-primary');
                                    retryBtn.style.fontWeight = 'bold';
                                }
                            } else {
                                statusSpan.classList.add('text-muted');
                                statusSpan.textContent = '(等待上传)';
                                if (retryBtn) {
                                    retryBtn.style.display = 'none';
                                    // 重置按钮样式（避免need_file状态的样式残留）
                                    retryBtn.textContent = '重试';
                                    retryBtn.classList.remove('btn-primary');
                                    retryBtn.classList.add('btn-warning');
                                    retryBtn.style.fontWeight = 'normal';
                                }
                            }

                            // 添加到文件信息区域
                            fileInfo.appendChild(statusSpan);
                        }

                        // 隐藏进度条（如果上传完成）
                        if (status === 'completed') {
                            const progressBarContainer = listItem.querySelector('.file-progress');
                            if (progressBarContainer) progressBarContainer.style.display = 'none';
                        }
                    }
                }

                function removeFile(fileId) {
                    uploadedFilesData = uploadedFilesData.filter(file => file.id !== fileId);
                    const listItem = document.getElementById(`file-item-${fileId}`);
                    if (listItem) {
                        listItem.remove();
                    }
                    prepareAttachmentsForSubmission();
                    saveUploadState(); // 保存状态
                }

                // 重试上传功能
                async function retryUpload(fileId) {
                    const fileEntry = uploadedFilesData.find(file => file.id === fileId);
                    if (!fileEntry) {
                        console.error(`未找到文件ID: ${fileId}`);
                        return;
                    }

                    // 如果是虚拟文件（从localStorage恢复的），直接弹出文件选择
                    if (fileEntry.file.size === 0 || (fileEntry.file.size > 0 && typeof fileEntry.file.stream === 'undefined')) {
                        console.log(`检测到虚拟文件 "${fileEntry.file.name}"，直接开始文件选择流程`);
                        showFileSelectionDialog(fileEntry, true); // 使用自动续传模式
                        return;
                    }

                    // 重置状态
                    fileEntry.status = 'pending';
                    fileEntry.progress = 0;
                    updateFileProgress(fileId, 0);
                    updateFileStatusUI(fileId, 'uploading', '重新开始上传...');

                    // 显示进度条
                    const listItem = document.getElementById(`file-item-${fileId}`);
                    if (listItem) {
                        const progressBarContainer = listItem.querySelector('.file-progress');
                        if (progressBarContainer) progressBarContainer.style.display = 'block';
                    }

                    try {
                        if (fileEntry.uploadId) {
                            // 如果有上传ID，尝试断点续传
                            try {
                                await uploadFileWithResume(fileEntry, fileEntry.uploadId);
                            } catch (error) {
                                if (error.message === 'RESTART_UPLOAD') {
                                    // 需要重新开始上传
                                    console.log('重新开始上传流程...');
                                    await uploadFile(fileEntry);
                                    return;
                                } else if (error.message === 'NEED_REAL_FILE') {
                                    // 需要重新选择文件，直接开始文件选择流程
                                    console.log('检测到虚拟文件对象，直接开始文件选择流程');
                                    showFileSelectionDialog(fileEntry, true); // 使用自动续传模式
                                    return;
                                } else {
                                    throw error; // 其他错误继续抛出
                                }
                            }
                        } else {
                            // 否则重新开始上传
                            await uploadFile(fileEntry);
                            return; // uploadFile 会处理完整流程
                        }

                        // 3. 完成上传
                        const finalizeResponse = await fetch(`/api/attachments/finalize/${fileEntry.uploadId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                        });

                        if (!finalizeResponse.ok) {
                            throw new Error('完成上传失败');
                        }

                        const finalizeResult = await finalizeResponse.json();

                        fileEntry.status = 'completed';
                        fileEntry.progress = 100;
                        fileEntry.serverFileName = finalizeResult.fileName;
                        updateFileProgress(fileEntry.id, 100);
                        updateFileStatusUI(fileEntry.id, 'completed');
                        saveUploadState(); // 保存状态
                        showAlertOnMainPage(`文件 "${fileEntry.file.name}" 重试上传成功。`, 'success', 3000);

                    } catch (error) {
                        console.error('重试上传失败:', error);
                        fileEntry.status = 'error';
                        updateFileStatusUI(fileEntry.id, 'error', `重试失败: ${error.message}`);
                        saveUploadState(); // 保存状态
                        showAlertOnMainPage(`文件 "${fileEntry.file.name}" 重试上传失败: ${error.message}`, 'danger');
                    }
                }

                // 网络状态监测
                function setupNetworkStatusMonitoring() {
                    window.addEventListener('online', () => {
                        console.log('网络已恢复');
                        showAlertOnMainPage('网络连接已恢复，您可以继续上传文件。', 'info', 5000);

                        // 检查是否有失败的上传，提示用户重试
                        const failedUploads = uploadedFilesData.filter(file => file.status === 'error');
                        if (failedUploads.length > 0) {
                            showAlertOnMainPage(`发现 ${failedUploads.length} 个失败的上传，您可以点击"重试"按钮继续上传。`, 'warning', 8000);
                        }
                    });

                    window.addEventListener('offline', () => {
                        console.log('网络已断开');
                        showAlertOnMainPage('网络连接已断开，上传可能会失败。请检查网络连接。', 'warning', 8000);
                    });
                }

                // 启动网络状态监测
                setupNetworkStatusMonitoring();

                // 页面加载时恢复未完成的上传
                restoreUploadState();

                // 页面卸载时清理过期状态
                window.addEventListener('beforeunload', clearExpiredUploads);

                // 表单提交成功后清除上传状态
                window.clearUploadStateOnSuccess = function() {
                    localStorage.removeItem(STORAGE_KEY);
                    console.log('表单提交成功，已清除上传状态');
                };

                // 已移除自动批量续传相关代码，改为手动点击按钮选择文件

                // 显示文件选择对话框
                function showFileSelectionDialog(fileEntry, isAutoResume = false) {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '*/*';

                    if (isAutoResume) {
                        // 自动续传模式下，提供更好的用户提示
                        showAlertOnMainPage(`请选择文件 "${fileEntry.file.name}" 以继续断点续传`, 'warning', 8000);
                    }

                    input.onchange = function(e) {
                        const selectedFile = e.target.files[0];
                        if (selectedFile) {
                            // 验证文件名和大小是否匹配
                            if (selectedFile.name === fileEntry.file.name && selectedFile.size === fileEntry.file.size) {
                                // 替换文件对象
                                console.log(`文件重新选择成功: ${selectedFile.name}, 大小: ${selectedFile.size} bytes`);
                                fileEntry.file = selectedFile;

                                // 验证新文件对象的切片功能
                                try {
                                    const testChunk = selectedFile.slice(0, Math.min(1024, selectedFile.size));
                                    console.log(`新文件切片测试成功，测试分块大小: ${testChunk.size} bytes`);
                                } catch (sliceError) {
                                    console.error('新文件切片测试失败:', sliceError);
                                    alert('选择的文件无法正常读取，请重新选择。');
                                    return;
                                }

                                updateFileStatusUI(fileEntry.id, 'uploading', '文件已选择，开始断点续传...');

                                // 立即开始上传
                                setTimeout(() => {
                                    retryUpload(fileEntry.id);
                                }, 300);
                            } else {
                                const proceed = confirm(`选择的文件与原文件不匹配：\n原文件: ${fileEntry.file.name} (${(fileEntry.file.size/1024/1024).toFixed(2)}MB)\n新文件: ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(2)}MB)\n\n是否仍要使用新文件？`);
                                if (proceed) {
                                    // 更新文件信息
                                    fileEntry.file = selectedFile;
                                    fileEntry.uploadId = null; // 清除旧的uploadId
                                    fileEntry.progress = 0;

                                    // 更新UI显示
                                    const fileInfo = document.querySelector(`#file-item-${fileEntry.id} .file-info`);
                                    if (fileInfo) {
                                        fileInfo.innerHTML = `
                                            <span class="file-name" title="${selectedFile.name}">${selectedFile.name}</span>
                                            <span class="file-size">${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</span>
                                        `;
                                    }

                                    updateFileStatusUI(fileEntry.id, 'pending', '新文件已选择，准备上传');

                                    // 立即开始上传
                                    setTimeout(() => {
                                        retryUpload(fileEntry.id);
                                    }, 500);
                                }
                            }
                        }
                    };
                    input.click();
                }

                // 简单的模态框控制函数
                window.showFileTypeHelp = function() {
                    console.log('显示文件类型帮助');
                    const modal = document.getElementById('fileTypeHelpModal');
                    if (modal) {
                        modal.style.display = 'block';
                        modal.classList.add('show');
                        modal.setAttribute('aria-hidden', 'false');
                        document.body.classList.add('modal-open');

                        // 添加遮罩层
                        const backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        backdrop.id = 'simple-backdrop';
                        backdrop.onclick = function() { hideFileTypeHelp(); };
                        document.body.appendChild(backdrop);
                    }
                };

                window.hideFileTypeHelp = function() {
                    console.log('隐藏文件类型帮助');
                    const modal = document.getElementById('fileTypeHelpModal');
                    const backdrop = document.getElementById('simple-backdrop');

                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        modal.setAttribute('aria-hidden', 'true');
                        document.body.classList.remove('modal-open');
                    }

                    if (backdrop) {
                        backdrop.remove();
                    }
                };

                // 持久化上传状态到localStorage
                function saveUploadState() {
                    try {
                        const uploadState = {
                            timestamp: Date.now(),
                            files: uploadedFilesData.map(file => ({
                                id: file.id,
                                name: file.file.name,
                                size: file.file.size,
                                type: file.file.type,
                                status: file.status,
                                progress: file.progress,
                                uploadId: file.uploadId,
                                serverFileName: file.serverFileName,
                                lastModified: file.file.lastModified // 用于验证文件一致性
                            }))
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(uploadState));
                        console.log('上传状态已保存');
                    } catch (error) {
                        console.warn('保存上传状态失败:', error);
                    }
                }

                // 从localStorage恢复上传状态
                function restoreUploadState() {
                    try {
                        const savedState = localStorage.getItem(STORAGE_KEY);
                        if (!savedState) return;

                        const uploadState = JSON.parse(savedState);
                        const now = Date.now();
                        const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;

                        // 检查是否过期
                        if (now - uploadState.timestamp > expiryTime) {
                            console.log('保存的上传状态已过期，清除');
                            localStorage.removeItem(STORAGE_KEY);
                            return;
                        }

                        if (uploadState.files && uploadState.files.length > 0) {
                            console.log(`发现 ${uploadState.files.length} 个未完成的上传`);
                            showUploadRestorationDialog(uploadState.files);
                        }
                    } catch (error) {
                        console.warn('恢复上传状态失败:', error);
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }

                // 显示上传恢复对话框（简化版）
                function showUploadRestorationDialog(savedFiles) {
                    const uncompletedFiles = savedFiles.filter(file => file.status !== 'completed');
                    if (uncompletedFiles.length === 0) {
                        localStorage.removeItem(STORAGE_KEY);
                        return;
                    }

                    console.log(`自动恢复 ${uncompletedFiles.length} 个未完成的上传`);

                    // 自动恢复，不再询问用户
                    restoreUncompletedUploads(savedFiles);

                    // 显示更清晰的提示信息
                    const fileList = uncompletedFiles.map(f => `• ${f.name} (${(f.size/1024/1024).toFixed(2)}MB)`).join('\n');
                    showAlertOnMainPage(
                        `🔄 检测到 ${uncompletedFiles.length} 个未完成的上传：\n${fileList}\n\n👆 请点击文件旁的 "选择文件继续上传" 按钮来恢复断点续传`,
                        'warning',
                        15000
                    );
                }

                // 恢复未完成的上传
                async function restoreUncompletedUploads(savedFiles) {
                    for (const savedFile of savedFiles) {
                        if (savedFile.status === 'completed') {
                            // 直接恢复已完成的文件
                            const fileEntry = {
                                id: savedFile.id,
                                file: {
                                    name: savedFile.name,
                                    size: savedFile.size,
                                    type: savedFile.type,
                                    lastModified: savedFile.lastModified
                                },
                                status: savedFile.status,
                                progress: savedFile.progress,
                                uploadId: savedFile.uploadId,
                                serverFileName: savedFile.serverFileName
                            };
                            uploadedFilesData.push(fileEntry);
                            addFileToUI(fileEntry);
                            updateFileStatusUI(fileEntry.id, 'completed');
                        } else {
                            // 为未完成的文件创建虚拟文件对象
                            const virtualFile = createVirtualFile(savedFile);
                            if (virtualFile) {
                                const fileEntry = {
                                    id: savedFile.id,
                                    file: virtualFile,
                                    status: 'paused', // 设置为暂停状态
                                    progress: savedFile.progress,
                                    uploadId: savedFile.uploadId,
                                    serverFileName: savedFile.serverFileName
                                };
                                uploadedFilesData.push(fileEntry);
                                addFileToUI(fileEntry);
                                updateFileStatusUI(fileEntry.id, 'need_file', '需要重新选择文件继续断点续传');
                            }
                        }
                    }

                    const uncompletedCount = savedFiles.filter(f => f.status !== 'completed').length;
                    if (uncompletedCount > 0) {
                        showAlertOnMainPage(`已恢复 ${savedFiles.length} 个文件，其中 ${uncompletedCount} 个需要继续上传。点击"重试"按钮继续。`, 'info', 8000);
                    }

                    saveUploadState(); // 更新状态
                }

                // 创建虚拟文件对象（用于恢复）
                function createVirtualFile(savedFile) {
                    try {
                        // 创建一个虚拟的File对象用于显示
                        const blob = new Blob([''], { type: savedFile.type });
                        const file = new File([blob], savedFile.name, {
                            type: savedFile.type,
                            lastModified: savedFile.lastModified
                        });

                        // 由于无法恢复实际文件内容，我们需要在重试时提示用户重新选择文件
                        Object.defineProperty(file, 'size', {
                            value: savedFile.size,
                            writable: false
                        });

                        return file;
                    } catch (error) {
                        console.error('创建虚拟文件失败:', error);
                        return null;
                    }
                }

                // 清除过期的上传状态
                function clearExpiredUploads() {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (savedState) {
                        try {
                            const uploadState = JSON.parse(savedState);
                            const now = Date.now();
                            const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;

                            if (now - uploadState.timestamp > expiryTime) {
                                localStorage.removeItem(STORAGE_KEY);
                                console.log('已清除过期的上传状态');
                            }
                        } catch (error) {
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    }
                }

                async function processFileUploadQueue() {
                    if (isUploading) return;
                    isUploading = true;

                    while (fileUploadQueue.length > 0) {
                        const fileEntry = fileUploadQueue.shift();
                        if (fileEntry.status === 'pending') {
                            await uploadFile(fileEntry);
                        }
                    }
                    isUploading = false;
                }

                // 断点续传核心函数
                async function uploadFileWithResume(fileEntry, uploadId) {
                    const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
                    const totalChunks = Math.ceil(fileEntry.file.size / CHUNK_SIZE);

                    console.log(`DEBUG: 开始断点续传 - 文件: ${fileEntry.file.name}, 总大小: ${fileEntry.file.size} bytes, 总分块: ${totalChunks}`);

                    // 检查文件对象是否为虚拟文件（从localStorage恢复的）
                    if (typeof fileEntry.file.stream === 'undefined' || typeof fileEntry.file.slice !== 'function') {
                        console.warn('检测到虚拟文件对象，无法进行切片操作');
                        throw new Error('NEED_REAL_FILE'); // 特殊错误码，表示需要重新选择文件
                    }

                    // 测试文件切片功能
                    try {
                        const testChunk = fileEntry.file.slice(0, Math.min(1024, fileEntry.file.size));
                        if (testChunk.size === 0 && fileEntry.file.size > 0) {
                            console.warn('文件切片测试失败，无法读取文件内容');
                            throw new Error('NEED_REAL_FILE');
                        }
                        console.log(`文件切片测试成功，测试分块大小: ${testChunk.size} bytes`);
                    } catch (sliceError) {
                        console.warn('文件切片测试出错:', sliceError);
                        throw new Error('NEED_REAL_FILE');
                    }

                    // 1. 查询服务器已上传状态
                    let uploadedChunks = new Set();
                    let serverTotalChunks = 0;
                    let serverFileSize = 0;

                    try {
                        const statusResponse = await fetch(`/api/attachments/status/${uploadId}`);
                        if (statusResponse.ok) {
                            const status = await statusResponse.json();
                            uploadedChunks = new Set(status.uploadedChunks || []);
                            serverTotalChunks = status.totalChunks || 0;
                            serverFileSize = status.totalSize || 0;

                            console.log(`服务器状态: 文件大小=${serverFileSize}, 总分块=${serverTotalChunks}, 已上传=${uploadedChunks.size}个分块`);
                            console.log(`当前文件: 文件大小=${fileEntry.file.size}, 计算分块=${totalChunks}`);

                            // 验证文件一致性
                            if (serverFileSize !== fileEntry.file.size) {
                                console.error(`文件大小不一致! 服务器: ${serverFileSize}, 当前: ${fileEntry.file.size}`);
                                throw new Error(`文件不一致：服务器记录大小 ${serverFileSize} bytes，当前文件大小 ${fileEntry.file.size} bytes`);
                            }

                            // 验证分块数一致性（0表示新上传会话，是正常的）
                            if (serverTotalChunks > 0 && serverTotalChunks !== totalChunks) {
                                console.error(`分块数不一致! 服务器: ${serverTotalChunks}, 当前: ${totalChunks}`);
                                throw new Error(`分块数不一致：服务器记录 ${serverTotalChunks} 块，当前计算 ${totalChunks} 块`);
                            } else if (serverTotalChunks === 0) {
                                console.log(`新上传会话，服务器totalChunks为0是正常的`);
                            }

                            console.log(`文件 "${fileEntry.file.name}" 断点续传: 已上传 ${uploadedChunks.size}/${totalChunks} 分块`);

                            // 更新UI显示已有进度
                            if (uploadedChunks.size > 0) {
                                const existingProgress = Math.round((uploadedChunks.size / totalChunks) * 90);
                                fileEntry.progress = existingProgress;
                                updateFileProgress(fileEntry.id, existingProgress);
                                updateFileStatusUI(fileEntry.id, 'uploading', `继续上传 (${uploadedChunks.size}/${totalChunks} 已完成)`);
                            }
                        }
                    } catch (error) {
                        console.warn(`查询上传状态失败，将从头开始: ${error.message}`);
                        if (error.message.includes('不一致')) {
                            // 文件不一致，提供重新开始选项
                            const restart = confirm(`检测到文件与服务器记录不一致：\n${error.message}\n\n是否清理服务器状态并重新开始上传？\n\n点击"确定"重新开始，点击"取消"停止上传。`);
                            if (restart) {
                                console.log('用户选择重新开始上传，清理服务器状态...');
                                try {
                                    // 尝试清理服务器状态（删除uploadId记录）
                                    const cleanupResponse = await fetch(`/api/attachments/cleanup/${uploadId}`, { method: 'DELETE' });
                                    if (cleanupResponse.ok) {
                                        console.log('服务器状态已成功清理');
                                    } else {
                                        console.warn('清理服务器状态失败，但将继续重新开始上传');
                                    }
                                } catch (cleanupError) {
                                    console.warn('清理服务器状态时出错，但将继续重新开始上传:', cleanupError);
                                }

                                // 无论清理是否成功，都清理本地状态并重新开始
                                console.log('清理本地状态，准备重新开始上传');
                                fileEntry.uploadId = null;
                                saveUploadState();
                                throw new Error('RESTART_UPLOAD'); // 特殊错误码，表示需要重新开始
                            } else {
                                throw new Error('用户取消上传');
                            }
                        }
                    }

                    // 2. 只上传缺失的分块
                    for (let chunkNumber = 0; chunkNumber < totalChunks; chunkNumber++) {
                        if (uploadedChunks.has(chunkNumber)) {
                            console.log(`跳过已上传的分块: ${chunkNumber + 1}/${totalChunks}`);
                            continue; // 跳过已上传的分块
                        }

                        // 计算当前分块的大小进行验证
                        const start = chunkNumber * CHUNK_SIZE;
                        const end = Math.min(start + CHUNK_SIZE, fileEntry.file.size);
                        const expectedChunkSize = end - start;

                        console.log(`DEBUG: 准备上传分块 ${chunkNumber + 1}/${totalChunks}, 预期大小: ${expectedChunkSize} bytes (${start}-${end})`);

                        if (expectedChunkSize <= 0) {
                            console.error(`分块 ${chunkNumber + 1} 计算出错误的大小: ${expectedChunkSize}`);
                            throw new Error(`分块 ${chunkNumber + 1} 大小计算错误: ${expectedChunkSize} bytes`);
                        }

                        const success = await uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, CHUNK_SIZE);
                        if (!success) {
                            throw new Error(`分块 ${chunkNumber + 1} 多次重试后仍然失败`);
                        }

                        // 更新进度和分块信息
                        const uploadedCount = chunkNumber + 1;
                        const progress = Math.round((uploadedCount / totalChunks) * 90);
                        fileEntry.progress = progress;
                        const chunkInfo = `分块 ${uploadedCount}/${totalChunks} 已上传`;
                        updateFileProgress(fileEntry.id, progress, chunkInfo);

                        // 每5个分块保存一次状态（减少存储频率）
                        if (uploadedCount % 5 === 0 || uploadedCount === totalChunks) {
                            saveUploadState();
                        }
                    }
                }

                // 支持重试的分块上传函数
                async function uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, chunkSize, maxRetries = 3) {
                    const start = chunkNumber * chunkSize;
                    const end = Math.min(start + chunkSize, fileEntry.file.size);
                    const chunk = fileEntry.file.slice(start, end);

                    // 验证分块大小
                    if (chunk.size === 0) {
                        console.error(`分块 ${chunkNumber + 1} 切片结果为空! start=${start}, end=${end}, fileSize=${fileEntry.file.size}`);
                        throw new Error(`分块 ${chunkNumber + 1} 切片失败：结果为空`);
                    }

                    for (let attempt = 0; attempt < maxRetries; attempt++) {
                        try {
                            const chunkFormData = new FormData();
                            chunkFormData.append('file', chunk);
                            chunkFormData.append('chunkNumber', chunkNumber);
                            chunkFormData.append('totalChunks', totalChunks);

                            console.log(`DEBUG: 实际上传分块 ${chunkNumber + 1}/${totalChunks}, 大小: ${chunk.size} bytes, 范围: ${start}-${end}, uploadId: ${uploadId}`);

                            const chunkResponse = await fetch('/api/attachments/upload-chunk', {
                                method: 'POST',
                                headers: {
                                    'X-Upload-Id': uploadId
                                },
                                body: chunkFormData
                            });

                            if (chunkResponse.ok) {
                                console.log(`分块 ${chunkNumber + 1}/${totalChunks} 上传成功 ${attempt > 0 ? '(重试 ' + attempt + ' 次后)' : ''}`);
                                return true; // 成功
                            } else {
                                // 获取详细的错误信息
                                let errorDetails = `HTTP ${chunkResponse.status}: ${chunkResponse.statusText}`;
                                try {
                                    const errorText = await chunkResponse.text();
                                    if (errorText) {
                                        errorDetails += ` - ${errorText}`;
                                    }
                                } catch (e) {
                                    console.warn('无法获取详细错误信息:', e);
                                }
                                throw new Error(errorDetails);
                            }
                        } catch (error) {
                            console.warn(`分块 ${chunkNumber + 1} 上传失败 (尝试 ${attempt + 1}/${maxRetries}): ${error.message}`);

                            if (attempt === maxRetries - 1) {
                                // 最后一次尝试失败
                                updateFileStatusUI(fileEntry.id, 'error', `分块 ${chunkNumber + 1} 重试 ${maxRetries} 次后失败`);
                                return false;
                            }

                            // 指数退避策略
                            const delay = Math.min(1000 * Math.pow(2, attempt), 10000); // 最大10秒
                            console.log(`${delay}ms 后重试分块 ${chunkNumber + 1}...`);
                            updateFileStatusUI(fileEntry.id, 'uploading', `分块 ${chunkNumber + 1} 重试中... (${attempt + 1}/${maxRetries})`);
                            await sleep(delay);
                        }
                    }
                    return false;
                }

                // 工具函数：延时
                function sleep(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }

                async function uploadFile(fileEntry) {
                    fileEntry.status = 'uploading';
                    updateFileStatusUI(fileEntry.id, 'uploading');

                    try {
                        // 1. 初始化上传
                        const initResponse = await fetch('/api/attachments/initiate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                fileName: fileEntry.file.name,
                                totalSize: fileEntry.file.size
                            })
                        });

                        if (!initResponse.ok) {
                            throw new Error('初始化上传失败');
                        }

                        const initResult = await initResponse.json();
                        const uploadId = initResult.uploadId;
                        const serverFileName = initResult.serverFileName;

                        // 保存上传ID供断点续传使用
                        fileEntry.uploadId = uploadId;
                        fileEntry.serverFileName = serverFileName;
                        saveUploadState(); // 保存状态

                        // 2. 智能分块上传 (支持断点续传)
                        await uploadFileWithResume(fileEntry, uploadId);

                        // 3. 完成上传
                        const finalizeResponse = await fetch(`/api/attachments/finalize/${uploadId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                        });

                        if (!finalizeResponse.ok) {
                            throw new Error('完成上传失败');
                        }

                        const finalizeResult = await finalizeResponse.json();

                        fileEntry.status = 'completed';
                        fileEntry.progress = 100;
                        fileEntry.serverFileName = finalizeResult.fileName;
                        updateFileProgress(fileEntry.id, 100);
                        updateFileStatusUI(fileEntry.id, 'completed');
                        saveUploadState(); // 保存状态
                        showAlertOnMainPage(`文件 "${fileEntry.file.name}" 上传成功。`, 'success', 3000);
                    } catch (error) {
                        if (error.message === 'NEED_REAL_FILE') {
                            // 需要重新选择文件
                            console.log('上传过程中检测到虚拟文件对象，需要重新选择文件');
                            fileEntry.status = 'pending';
                            updateFileStatusUI(fileEntry.id, 'pending', '需要重新选择文件');
                            saveUploadState();

                            const confirmed = confirm(`文件 "${fileEntry.file.name}" 需要重新选择才能继续上传。\n\n点击确定来选择文件，或取消删除此项。`);
                            if (confirmed) {
                                showFileSelectionDialog(fileEntry);
                            } else {
                                removeFile(fileEntry.id);
                            }
                            return;
                        }

                        console.error('文件上传错误:', error);
                        fileEntry.status = 'error';
                        fileEntry.progress = 0;
                        updateFileProgress(fileEntry.id, 0);
                        updateFileStatusUI(fileEntry.id, 'error', error.message);
                        saveUploadState(); // 保存状态
                        showAlertOnMainPage(`文件 "${fileEntry.file.name}" 上传失败: ${error.message}`, 'danger');
                    }
                }

                function prepareAttachmentsForSubmission() {
                    if (hiddenAttachmentInputsContainer) {
                        hiddenAttachmentInputsContainer.innerHTML = '';
                        const completedFiles = uploadedFilesData.filter(fileEntry =>
                            fileEntry.status === 'completed' && fileEntry.serverFileName
                        );

                        console.log(`准备附件提交: 发现 ${completedFiles.length} 个已完成的文件`, completedFiles);

                        completedFiles.forEach(fileEntry => {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'attachmentServerFileNames';
                            hiddenInput.value = fileEntry.serverFileName;
                            hiddenAttachmentInputsContainer.appendChild(hiddenInput);
                            console.log(`添加附件到表单: ${fileEntry.serverFileName}`);
                        });

                        console.log(`附件容器内容:`, hiddenAttachmentInputsContainer.innerHTML);
                    } else {
                        console.error('未找到隐藏附件输入容器');
                    }
                }

                // --- 开始：电子签名逻辑 ---
                // 甲方
                const signatureCanvasPartyA = document.getElementById('signatureCanvasPartyA');
                const signatureCtxPartyA = signatureCanvasPartyA.getContext('2d');
                const clearSignatureBtnPartyA = document.getElementById('clearSignatureBtnPartyA');
                const uploadSignatureInputPartyA = document.getElementById('uploadSignatureInputPartyA');
                const signaturePreviewPartyA = document.getElementById('signaturePreviewPartyA');
                const signatureDataInputPartyA = document.getElementById('signatureDataPartyA');

                // 乙方
                const signatureCanvasPartyB = document.getElementById('signatureCanvasPartyB');
                const signatureCtxPartyB = signatureCanvasPartyB.getContext('2d');
                const clearSignatureBtnPartyB = document.getElementById('clearSignatureBtnPartyB');
                const uploadSignatureInputPartyB = document.getElementById('uploadSignatureInputPartyB');
                const signaturePreviewPartyB = document.getElementById('signaturePreviewPartyB');
                const signatureDataInputPartyB = document.getElementById('signatureDataPartyB');


                // 统一初始化画布
                function initSignatureCanvas(canvas, ctx) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                }
                initSignatureCanvas(signatureCanvasPartyA, signatureCtxPartyA);
                initSignatureCanvas(signatureCanvasPartyB, signatureCtxPartyB);

                // 绘制函数工厂
                function createDrawHandler(canvas, ctx, previewImg) {
                    let isDrawing = false;
                    let lastX = 0;
                    let lastY = 0;

                    canvas.addEventListener('mousedown', (e) => {
                        isDrawing = true;
                        [lastX, lastY] = [e.offsetX, e.offsetY];
                        if (previewImg) previewImg.style.display = 'none';
                    });

                    canvas.addEventListener('mousemove', (e) => {
                        if (!isDrawing) return;
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(e.offsetX, e.offsetY);
                        ctx.stroke();
                        [lastX, lastY] = [e.offsetX, e.offsetY];
                    });

                    canvas.addEventListener('mouseup', () => isDrawing = false);
                    canvas.addEventListener('mouseout', () => isDrawing = false);
                }

                // 为甲方和乙方签名板创建绘制处理函数
                createDrawHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA);
                createDrawHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB);


                // 清空签名函数工厂
                function createClearSignatureHandler(canvas, ctx, previewImg, dataInput) {
                    return () => {
                        initSignatureCanvas(canvas, ctx);
                        if (previewImg) {
                            previewImg.src = '';
                            previewImg.style.display = 'none';
                        }
                        dataInput.value = '';
                    };
                }
                if (clearSignatureBtnPartyA) clearSignatureBtnPartyA.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
                if (clearSignatureBtnPartyB) clearSignatureBtnPartyB.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));

                // 上传签名图片函数工厂
                function createUploadSignatureHandler(canvas, ctx, previewImg, dataInput) {
                    return (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                    initSignatureCanvas(canvas, ctx);
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    if (previewImg) {
                                        previewImg.src = e.target.result;
                                        previewImg.style.display = 'block';
                                    }
                                    dataInput.value = canvas.toDataURL('image/png');
                                };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    };
                }
                if (uploadSignatureInputPartyA) uploadSignatureInputPartyA.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
                if (uploadSignatureInputPartyB) uploadSignatureInputPartyB.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));


                // 准备签名数据以供提交 (通用化)
                function prepareSignatureForSubmission(party) {
                    const canvas = document.getElementById(`signatureCanvas${party}`);
                    const ctx = canvas.getContext('2d');
                    const preview = document.getElementById(`signaturePreview${party}`);
                    const dataInput = document.getElementById(`signatureData${party}`);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    let hasDrawn = false;
                    for (let i = 0; i < imageData.length; i += 4) {
                        if (imageData[i + 3] !== 0 && (imageData[i] !== 255 || imageData[i+1] !== 255 || imageData[i+2] !== 255)) {
                            hasDrawn = true;
                            break;
                        }
                    }

                    if (hasDrawn) {
                        dataInput.value = canvas.toDataURL('image/png');
                    } else if (preview.src && preview.style.display !== 'none') {
                        dataInput.value = preview.src;
                    } else {
                        dataInput.value = '';
                    }
                }
                // --- 电子签名逻辑结束 ---


                // --- 开始：模板选择和直接编辑占位符逻辑 ---
                console.log('📝 开始初始化模板选择功能...');
                // originalTemplateContent 变量用于存储从后端获取的原始模板内容
                let originalTemplateContent = '';

                // extractAndPreparePlaceholderValues 函数用于从 TinyMCE 内容中提取占位符值
                function extractAndPreparePlaceholderValues() {
                    if (!contractEditor) return;

                    const editorContent = contractEditor.getContent(); // 获取 TinyMCE 当前的 HTML 内容
                    const placeholderValues = {};

                    // 创建一个临时的 DOM 元素来解析编辑器内容，方便查找 span
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = editorContent;

                    // 查找所有具有 .contract-placeholder 类和 data-placeholder-key 属性的可编辑 span
                    const placeholderSpans = tempDiv.querySelectorAll('.contract-placeholder[data-placeholder-key][contenteditable="true"]');

                    placeholderSpans.forEach(span => {
                        const key = span.dataset.placeholderKey;
                        const value = span.textContent || ''; // 获取用户实际填写的值

                        if (key) {
                            placeholderValues[key] = value;
                        }
                    });

                    // 将占位符值打包到隐藏字段中
                    document.getElementById('placeholderValuesJson').value = JSON.stringify(placeholderValues);
                }

                // escapeRegExp 函数用于转义正则表达式特殊字符
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // templateSelect 的 change 事件监听器
                const templateSelect = document.getElementById('templateSelect');
                // 注意：templateSelect.dispatchEvent(new Event('change')); 已被移至 tinymce.init 的 'init' 事件中

                if (templateSelect) {
                    console.log('✅ 模板选择下拉框已找到，绑定change事件');
                    templateSelect.addEventListener('change', async function() {
                        const templateId = this.value;

                        // 清除编辑器内容和原始模板内容
                        if (contractEditor) {
                            contractEditor.setContent('');
                        }
                        originalTemplateContent = '';

                        if (!templateId) {
                            return; // 选择了 "-- 不使用模板 --"
                        }

                        try {
                            const response = await fetch(`/contract-manager/api/templates/${templateId}`);
                            if (!response.ok) {
                                throw new Error(`无法获取模板详情 (状态: ${response.status})`);
                            }
                            const template = await response.json();

                            originalTemplateContent = template.templateContent || '';
                            if (!originalTemplateContent) {
                                console.warn("DEBUG: 获取到的模板内容为空。");
                                showAlertOnMainPage('选择的模板内容为空，请检查模板配置。', 'warning');
                                return;
                            }

                            const placeholderRegex = /\{\{([a-zA-Z0-9_\u4e00-\u9fa5]+?)\}\}/g;

                            let contentToDisplayInEditor = originalTemplateContent.replace(placeholderRegex, (match, placeholderName) => {
                                // 在 span 内部直接放置占位符名称，作为默认内容
                                return `<span class="contract-placeholder" data-placeholder-key="${placeholderName}" contenteditable="true">___________</span>`; // 11个下划线作为示例
                            });

                            if (contractEditor) {
                                contractEditor.setContent(contentToDisplayInEditor);
                                contractEditor.save();
                                // 移除 mceRepaint，因为其可能导致 getRng 错误
                            }

                        } catch (error) {
                            console.error("获取模板详情失败:", error);
                            showAlertOnMainPage('加载模板失败: ' + error.message, 'danger');
                        }
                    });
                } else {
                    console.error('❌ 未找到模板选择下拉框元素 #templateSelect');
                }
                // --- 模板选择和直接编辑占位符逻辑结束 ---

                // --- 完整预览功能实现 ---
                function handlePreviewFile(serverFileName) {
                    if (!serverFileName) return;

                    const downloadUrl = `/api/attachments/download/${encodeURIComponent(serverFileName)}`;
                    const fileExtension = serverFileName.toLowerCase().split('.').pop();

                    // 定义各种文件类型的预览支持
                    const previewableInBrowser = {
                        images: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'],
                        pdf: ['pdf'],
                        text: ['txt', 'csv', 'log', 'md', 'json', 'xml', 'html', 'css', 'js'],
                        audio: ['mp3', 'wav', 'ogg', 'aac', 'm4a'],
                        video: ['mp4', 'webm', 'ogg', 'mov']
                    };

                    const downloadOnly = {
                        office: ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'],
                        archives: ['zip', 'rar', '7z', 'tar', 'gz'],
                        others: ['exe', 'msi', 'dmg', 'deb', 'rpm']
                    };

                    let canPreview = false;
                    let fileCategory = '';

                    for (const [category, extensions] of Object.entries(previewableInBrowser)) {
                        if (extensions.includes(fileExtension)) {
                            canPreview = true;
                            fileCategory = category;
                            break;
                        }
                    }

                    if (canPreview) {
                        if (fileCategory === 'images') {
                            openImagePreview(downloadUrl, serverFileName);
                        } else if (fileCategory === 'pdf') {
                            const userChoice = confirm(
                                `PDF文件 "${serverFileName}" 预览选项：\n\n` +
                                `点击"确定"在新窗口预览PDF\n` +
                                `点击"取消"下载到本地查看`
                            );
                            if (userChoice) {
                                window.open(downloadUrl, '_blank');
                            } else {
                                downloadFileUtil(downloadUrl, serverFileName);
                            }
                        } else if (fileCategory === 'text') {
                            window.open(downloadUrl, '_blank');
                        } else if (fileCategory === 'audio' || fileCategory === 'video') {
                            openMediaPreview(downloadUrl, serverFileName, fileCategory);
                        }
                    } else {
                        let downloadReason = '';
                        if (downloadOnly.office.includes(fileExtension)) {
                            downloadReason = 'Office文档需要使用相应的办公软件打开';
                        } else if (downloadOnly.archives.includes(fileExtension)) {
                            downloadReason = '压缩包文件需要解压缩软件打开';
                        } else {
                            downloadReason = '此文件类型不支持在浏览器中直接预览';
                        }

                        const userConfirmed = confirm(
                            `文件 "${serverFileName}" ${downloadReason}。\n\n点击"确定"下载文件到本地查看，点击"取消"关闭此对话框。`
                        );
                        if (userConfirmed) {
                            downloadFileUtil(downloadUrl, serverFileName);
                        }
                    }
                }

                function openImagePreview(imageUrl, fileName) {
                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = `imagePreviewModal_${Date.now()}`;
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">图片预览: ${fileName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="preview-loading" id="imageLoading">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        正在加载图片...
                                    </div>
                                    <img src="${imageUrl}" class="img-fluid" style="max-height: 70vh; display: none;" alt="${fileName}"
                                         onload="this.style.display='block'; document.getElementById('imageLoading').style.display='none';"
                                         onerror="this.onerror=null; this.style.display='none'; document.getElementById('imageLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="alert alert-warning mt-3" style="display: none;">
                                        <i class="bi bi-exclamation-triangle"></i> 图片加载失败，请尝试下载后查看
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <small class="text-muted me-auto">快捷键: ESC-关闭, D-下载</small>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="downloadFileUtil('${imageUrl}', '${fileName}')">
                                        <i class="bi bi-download"></i> 下载
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    showModal(modal.id);

                    modal.addEventListener('hidden.bs.modal', () => {
                        document.body.removeChild(modal);
                    });

                    modal.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            hideModal(modal.id);
                        } else if (e.key === 'd' || e.key === 'D') {
                            downloadFileUtil(imageUrl, fileName);
                        }
                    });
                }

                function openMediaPreview(mediaUrl, fileName, mediaType) {
                    const isVideo = mediaType === 'video';
                    const mediaTag = isVideo ? 'video' : 'audio';
                    const mediaControls = isVideo ? 'controls width="100%" height="400"' : 'controls width="100%"';

                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = `mediaPreviewModal_${Date.now()}`;
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-${isVideo ? 'camera-video' : 'music-note'}"></i>
                                        ${isVideo ? '视频' : '音频'}预览: ${fileName}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="preview-loading" id="mediaLoading">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        正在加载${isVideo ? '视频' : '音频'}...
                                    </div>
                                    <${mediaTag} ${mediaControls} preload="metadata" style="display: none;"
                                            onloadedmetadata="this.style.display='block'; document.getElementById('mediaLoading').style.display='none';"
                                            onerror="this.onerror=null; this.style.display='none'; document.getElementById('mediaLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                        <source src="${mediaUrl}" type="${mediaType}/${fileName.split('.').pop()}">
                                        您的浏览器不支持${isVideo ? '视频' : '音频'}播放。
                                    </${mediaTag}>
                                    <div class="alert alert-warning mt-3" style="display: none;">
                                        <i class="bi bi-exclamation-triangle"></i> ${isVideo ? '视频' : '音频'}加载失败，请尝试下载后查看
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <small class="text-muted me-auto">快捷键: ESC-关闭, D-下载, 空格-播放/暂停</small>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    <button type="button" class="btn btn-primary" onclick="downloadFileUtil('${mediaUrl}', '${fileName}')">
                                        <i class="bi bi-download"></i> 下载
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    showModal(modal.id);

                    modal.addEventListener('hidden.bs.modal', () => {
                        document.body.removeChild(modal);
                    });

                    modal.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            hideModal(modal.id);
                        } else if (e.key === 'd' || e.key === 'D') {
                            downloadFileUtil(mediaUrl, fileName);
                        } else if (e.key === ' ') {
                            e.preventDefault();
                            const mediaElement = modal.querySelector('video, audio');
                            if (mediaElement) {
                                if (mediaElement.paused) {
                                    mediaElement.play();
                                } else {
                                    mediaElement.pause();
                                }
                            }
                        }
                    });
                }

                function downloadFileUtil(fileUrl, fileName) {
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.setAttribute('download', fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                console.log("DEBUG: draft-contract.html 的内联脚本主要逻辑执行完毕。");
            });
            /*]]>*/
        </script>
    </th:block>

    <th:block layout:fragment="script-links">
        <script th:src="@{/js/customer-select-modal.js}"></script>
    </th:block>
    </body>
    </html>