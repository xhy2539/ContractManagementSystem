<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}" lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>起草新合同 - 合同管理系统</title>
    <th:block layout:fragment="css-links">
    </th:block>
    <style layout:fragment="inline-css">
        .card-header { font-weight: 500; }
        #selectedCustomerInfoPlaceholder {
            padding: 0.575rem .75rem;
            border: 1px solid #dee2e6;
            border-left: 0;
            border-top-right-radius: .25rem;
            border-bottom-right-radius: .25rem;
            background-color: #e9ecef;
            line-height: 1.5;
            min-height: calc(1.5em + .5rem + 2px);
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        #customerTableModal tbody tr { cursor: pointer; }
        #customerTableModal tbody tr:hover { background-color: #f8f9fa; }
        .modal-xl { max-width: 900px; }
        .form-label { font-weight: 500; }
        .required-asterisk { color: var(--bs-danger); }
        #alertPlaceholder { min-height: 60px; transition: opacity 0.15s linear; }
        #alertPlaceholder:empty { min-height: 0; opacity: 0; }
        .form-text { font-size: .875em; }
        .is-invalid-placeholder {
            border-color: var(--bs-danger) !important;
        }

        /* Styles for multi-file upload list */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }
        .file-info {
            flex-grow: 1;
            margin-right: 1rem;
            overflow: hidden;
        }
        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .file-size, .file-status {
            font-size: 0.8em;
            color: #6c757d;
        }
        .file-actions button {
            margin-left: 0.5rem;
        }
        .file-progress {
            height: 10px;
            margin-top: 0.25rem;
            background-color: #e9ecef;
            border-radius: .25rem;
            overflow: hidden;
        }
        .file-progress-bar {
            background-color: #0d6efd;
            height: 100%;
            transition: width 0.2s ease-in-out;
            color: white;
            font-size: 0.7em;
            line-height:10px;
            text-align: center;
        }
        .file-list-item.upload-error {
            border-left: 5px solid var(--bs-danger);
            background-color: #fbe9e7;
        }
        .file-list-item.upload-success {
            border-left: 5px solid var(--bs-success);
            background-color: #e8f5e9;
        }

        /* TinyMCE 内容中占位符的高亮样式 */
        .mce-content-body .contract-placeholder {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px dashed #ffc107;
            font-weight: bold;
            display: inline-block;
            min-width: 50px;
            text-align: center;
            user-select: none;
            cursor: text;
            min-height: 1em;
            vertical-align: middle;
        }
        /* 当用户尝试选择或点击占位符时，允许文本选择/编辑 */
        .mce-content-body .contract-placeholder:focus,
        .mce-content-body .contract-placeholder:active,
        .mce-content-body .contract-placeholder:hover {
            user-select: text;
        }
        /* 如果 span 为空，显示 data-placeholder-key 的值作为提示 */
        /* 由于JS已经默认填充了placeholderName，此CSS可能不再严格需要，但保留以防万一 */
        .mce-content-body .contract-placeholder:empty::before {
            content: attr(data-placeholder-key);
            color: #aaa;
            font-style: italic;
            pointer-events: none;
            display: inline-block;
        }

        /* 电子签名画布样式 */
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fdfdfd;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
        }
        .signature-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            margin-top: 10px;
            display: block;
        }
    </style>
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0 h2"><i class="bi bi-file-earmark-plus-fill text-primary me-2"></i>起草新合同</h1>
            <a th:href="@{/dashboard}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>返回仪表盘
            </a>
        </div>

        <div id="alertPlaceholder">
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${#fields.hasErrors('contractDraftRequest.*')}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong><i class="bi bi-exclamation-circle-fill me-2"></i>请检查您的输入：</strong>
                <ul class="mb-0 ps-4">
                    <li th:each="err : ${#fields.errors('contractDraftRequest.*')}" th:text="${err}"></li>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${attachmentError}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${attachmentError}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>


        <form th:action="@{/contract-manager/draft}" method="post" th:object="${contractDraftRequest}" id="draftContractForm" class="needs-validation" novalidate>
            <div id="hiddenAttachmentInputsContainer"></div>
            <input type="hidden" id="placeholderValuesJson" name="placeholderValues">
            <input type="hidden" id="signatureDataPartyA" name="signatureDataPartyA">
            <input type="hidden" id="signatureDataPartyB" name="signatureDataPartyB">


            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-info-circle-fill me-2"></i>合同基本信息
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">选择合同模板 (可选)</label>
                        <select class="form-select form-control-sm" id="templateSelect" th:field="*{templateId}">
                            <option value="">-- 不使用模板 --</option>
                            <option th:each="template : ${contractTemplates}"
                                    th:value="${template.id}"
                                    th:text="${template.templateName}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="contractName" class="form-label">合同名称 <span class="required-asterisk">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="contractName" th:field="*{contractName}" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('contractName')}" th:errors="*{contractName}">合同名称不能为空。</div>
                        <div class="invalid-feedback">请输入合同名称。</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">开始日期 <span class="required-asterisk">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="startDate" th:field="*{startDate}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}">开始日期不能为空。</div>
                            <div class="invalid-feedback">请选择开始日期。</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">结束日期 <span class="required-asterisk">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="endDate" th:field="*{endDate}" required>
                            <div class="invalid-feedback" id="endDateValidationFeedback" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}">结束日期不能为空。</div>
                            <div class="invalid-feedback">结束日期不可以是过去时间</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-person-badge-fill me-2"></i>客户信息
                </div>
                <div class="card-body">
                    <label class="form-label">签约客户 <span class="required-asterisk">*</span></label>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-sm btn-outline-primary" type="button" id="openCustomerSelectModalBtn" style="min-width: 110px;">
                            <i class="bi bi-search me-1"></i> 选择客户
                        </button>
                        <div id="selectedCustomerInfoPlaceholder" class="form-control-sm"> <span class="text-muted">尚未选择客户</span>
                        </div>
                    </div>
                    <input type="hidden" id="selectedCustomerId" th:field="*{selectedCustomerId}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('selectedCustomerId')}" th:errors="*{selectedCustomerId}"></div>
                    <div class="invalid-feedback" id="selectedCustomerIdClientFeedback">请选择一个签约客户。</div>

                    <div id="selectedCustomerDetailsCard" class="card mt-2" style="display: none;">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1 small"><strong id="selectedCustomerNameText"></strong></h6>
                            <p class="card-text mb-0 small">
                                <strong>编号:</strong> <span id="selectedCustomerNumberText"></span> <br>
                                <strong>电话:</strong> <span id="selectedCustomerPhoneText"></span> <br>
                                <strong>邮箱:</strong> <span id="selectedCustomerEmailText"></span> <br>
                                <strong>地址:</strong> <span id="selectedCustomerAddressText"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-file-text-fill me-2"></i>合同条款与附件
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="contractContent" class="form-label">合同主要内容</label>
                        <textarea class="form-control form-control-sm" id="contractContent" rows="8" th:field="*{contractContent}" placeholder="请在此处填写合同的核心条款和内容..."></textarea>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('contractContent')}" th:errors="*{contractContent}"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">甲方签字 <span class="required-asterisk">*</span></label>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted mb-2">请在下方画布上签名，或上传您的签名图片。</p>
                                <canvas id="signatureCanvasPartyA" class="signature-pad" width="300" height="100"></canvas>
                                <div class="d-flex mt-2 mb-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyA"><i class="bi bi-x-circle me-1"></i>清空签名</button>
                                    <label for="uploadSignatureInputPartyA" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>上传签名图片</label>
                                    <input type="file" id="uploadSignatureInputPartyA" accept="image/png, image/jpeg" style="display: none;">
                                </div>
                                <img id="signaturePreviewPartyA" class="signature-preview" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">乙方签字 <span class="required-asterisk">*</span></label>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted mb-2">请在下方画布上签名，或上传您的签名图片。</p>
                                <canvas id="signatureCanvasPartyB" class="signature-pad" width="300" height="100"></canvas>
                                <div class="d-flex mt-2 mb-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyB"><i class="bi bi-x-circle me-1"></i>清空签名</button>
                                    <label for="uploadSignatureInputPartyB" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>上传签名图片</label>
                                    <input type="file" id="uploadSignatureInputPartyB" accept="image/png, image/jpeg" style="display: none;">
                                </div>
                                <img id="signaturePreviewPartyB" class="signature-preview" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="attachmentFilesInput" class="form-label">上传合同附件 (可选, 可多选)</label>
                        <input type="file" class="form-control form-control-sm" id="attachmentFilesInput" multiple>
                        <div class="form-text mb-2">支持的格式：PDF, 图片 (JPEG, PNG), Word文档 (doc, docx)。可按住Ctrl/Shift选择多个文件。</div>

                        <div id="fileListContainer" class="mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-center">
                <button type="submit" class="btn btn-primary btn-lg px-5 me-3" id="submitDraftContractBtn">
                    <i class="bi bi-save-fill me-2"></i>确认起草并提交
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg px-4">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>全部重置
                </button>
            </div>
        </form>
    </div>

    <div class="modal fade" id="customerSelectModal" tabindex="-1" aria-labelledby="customerSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerSelectModalLabel"><i class="bi bi-people-fill me-2"></i>选择签约客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="input-group input-group-sm flex-grow-1 me-2">
                            <input type="text" id="modalCustomerSearchInput" class="form-control" placeholder="输入客户名称或编号搜索...">
                            <button type="button" class="btn btn-sm btn-primary" id="modalSearchCustomerBtn"><i class="bi bi-search"></i></button>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" id="modalAddNewCustomerBtn" data-bs-toggle="modal" data-bs-target="#addCustomerFormModal">
                            <i class="bi bi-plus-circle me-1"></i> 添加新客户
                        </button>
                    </div>
                    <div id="customerModalAlertPlaceholder"></div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover table-sm" id="customerTableModal">
                            <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">客户编号</th>
                                <th scope="col">客户名称</th>
                                <th scope="col">联系电话</th>
                                <th scope="col">邮箱</th>
                                <th scope="col" class="text-center">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div id="customerModalSpinner" class="text-center my-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                    <nav aria-label="客户分页" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center" id="customerModalPagination">
                        </ul>
                    </nav>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCustomerFormModal" data-bs-backdrop="static" tabindex="-1" aria-labelledby="addCustomerFormModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addCustomerFormInModal_draft" class="needs-validation" novalidate>
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="addCustomerFormModalLabel"><i class="bi bi-person-plus-fill me-2"></i>快速添加新客户</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="addCustomerModalAlertPlaceholder_draft" class="mb-3"></div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_customerNumber" class="form-label">客户编号 <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control form-control-sm" name="customerNumber" id="new_draft_customerNumber" required placeholder="例如: CUST-2025-001">
                                <div class="invalid-feedback">请输入客户编号。</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_customerName" class="form-label">客户名称 <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control form-control-sm" name="customerName" id="new_draft_customerName" required placeholder="请输入完整的客户官方名称">
                                <div class="invalid-feedback">请输入客户名称。</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_phoneNumber" class="form-label">联系电话 <span class="required-asterisk">*</span></label>
                                <input type="tel" class="form-control form-control-sm" name="phoneNumber" id="new_draft_phoneNumber" required placeholder="例如: 0755-12345678 或 13800138000">
                                <div class="invalid-feedback">请输入有效的联系电话。</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_email" class="form-label">邮箱 <span class="required-asterisk">*</span></label>
                                <input type="email" class="form-control form-control-sm" name="email" id="new_draft_email" required placeholder="例如: contact@example.com">
                                <div class="invalid-feedback">请输入有效的邮箱地址。</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new_draft_address" class="form-label">客户地址</label>
                            <textarea class="form-control form-control-sm" name="address" id="new_draft_address" rows="2" placeholder="请输入客户详细通讯地址"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-target="#customerSelectModal" data-bs-toggle="modal" id="backToCustomerSelectModalBtn">
                            <i class="bi bi-arrow-left-short"></i> 返回选择
                        </button>
                        <button type="submit" class="btn btn-success" id="saveNewCustomerBtn_draft">
                            <i class="bi bi-check-circle-fill me-1"></i>确认并保存客户
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>


<th:block layout:fragment="scripts">
    <script src="https://cdn.tiny.cloud/1/epd4u3q4czck41xhryufu73clhe4jzhzc0bxvnmw9t0z6ayk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            // TinyMCE 初始化
            let contractEditor;

            tinymce.init({
                selector: '#contractContent',
                // 修正插件列表：移除可能不存在或有问题的插件，例如 'print', 'paste'
                // 确保只包含您确实需要且当前版本支持的插件
                plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount autoresize',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                autoresize_bottom_margin: 20,
                menubar: false,
                setup: function (editor) {
                    contractEditor = editor;
                    editor.on('change', function () {
                        editor.save();
                    });
                    // 确保编辑器初始化完成后再尝试操作，避免 'getRng' 错误
                    editor.on('init', function() {
                        // 如果 templateSelect 有初始值，触发其change事件以加载内容
                        const templateSelect = document.getElementById('templateSelect');
                        if (templateSelect && templateSelect.value) {
                            templateSelect.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });

            console.log("DEBUG: DOMContentLoaded 事件触发 - 脚本开始执行。");

            // --- 开始：现有客户选择和 Bootstrap 验证逻辑 ---
            (function () {
                'use strict'
                var forms = document.querySelectorAll('.needs-validation');
                var customerIdField = document.getElementById('selectedCustomerId');
                var customerIdClientFeedback = document.getElementById('selectedCustomerIdClientFeedback');
                var customerInfoPlaceholder = document.getElementById('selectedCustomerInfoPlaceholder');

                // 获取日期输入字段
                const startDateField = document.getElementById('startDate');
                const endDateField = document.getElementById('endDate');
                const endDateValidationFeedback = document.getElementById('endDateValidationFeedback');

                Array.prototype.slice.call(forms)
                    .forEach(function (form) {
                        form.addEventListener('submit', function (event) {
                            // 在这里添加新的表单提交预处理逻辑
                            if (form.id === 'draftContractForm') {
                                // 1. 从 TinyMCE 内容中提取占位符值并填充到 placeholderValuesJson
                                extractAndPreparePlaceholderValues();
                                // 2. 从签名画布中获取签名数据
                                prepareSignatureForSubmission('PartyA');
                                prepareSignatureForSubmission('PartyB');
                            }

                            let isFormValid = form.checkValidity();

                            if (form.id === 'draftContractForm') {
                                // 客户ID验证
                                if (customerIdField && customerIdField.required && customerIdField.value === '') {
                                    if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'block';
                                    if (customerInfoPlaceholder) customerInfoPlaceholder.classList.add('is-invalid-placeholder');
                                    isFormValid = false;
                                } else if (customerIdField) {
                                    if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'none';
                                    if (customerInfoPlaceholder) customerInfoPlaceholder.classList.remove('is-invalid-placeholder');
                                }

                                // 结束日期不能为过去时间的新验证
                                if (endDateField && endDateField.value) {
                                    const selectedEndDate = new Date(endDateField.value);
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);

                                    if (selectedEndDate < today) {
                                        endDateField.classList.add('is-invalid');
                                        if (endDateValidationFeedback) {
                                            endDateValidationFeedback.textContent = '结束日期不能早于今天。';
                                            endDateValidationFeedback.style.display = 'block';
                                        }
                                        isFormValid = false;
                                    } else {
                                        endDateField.classList.remove('is-invalid');
                                        if (endDateValidationFeedback) {
                                            endDateValidationFeedback.textContent = '结束日期不能为空。';
                                            if (!endDateField.dataset.thymeleafErrors) {
                                                endDateValidationFeedback.style.display = 'none';
                                            }
                                        }
                                    }
                                }
                            }

                            if (!isFormValid) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });

                // 实时验证结束日期何时更改
                if (endDateField) {
                    endDateField.addEventListener('change', function() {
                        const selectedEndDate = new Date(this.value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (selectedEndDate < today) {
                            this.classList.add('is-invalid');
                            if (endDateValidationFeedback) {
                                endDateValidationFeedback.textContent = '结束日期不能早于今天。';
                                endDateValidationFeedback.style.display = 'block';
                            }
                        } else {
                            this.classList.remove('is-invalid');
                            if (endDateValidationFeedback) {
                                endDateValidationFeedback.textContent = '结束日期不能为空。';
                                if (!this.dataset.thymeleafErrors) {
                                    endDateValidationFeedback.style.display = 'none';
                                }
                            }
                        }
                    });

                    if (endDateField.classList.contains('is-invalid') && endDateValidationFeedback && endDateValidationFeedback.textContent !== '结束日期不能为空。') {
                        endDateField.dataset.thymeleafErrors = 'true';
                        endDateValidationFeedback.style.display = 'block';
                    }
                }

            })();
            // --- 客户选择和验证逻辑结束 ---

            // --- 所有客户模态框和附件逻辑 ---
            const openCustomerSelectModalBtn = document.getElementById('openCustomerSelectModalBtn');
            const customerSelectModalEl = document.getElementById('customerSelectModal');
            const customerSelectModal = customerSelectModalEl ? new bootstrap.Modal(customerSelectModalEl) : null;
            const modalCustomerSearchInput = document.getElementById('modalCustomerSearchInput');
            const modalSearchCustomerBtn = document.getElementById('modalSearchCustomerBtn');
            const customerTableBody = document.querySelector('#customerTableModal tbody');
            const customerModalPagination = document.getElementById('customerModalPagination');
            const customerModalSpinner = document.getElementById('customerModalSpinner');
            const customerModalAlertPlaceholder = document.getElementById('customerModalAlertPlaceholder');
            const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
            const selectedCustomerInfoPlaceholder = document.getElementById('selectedCustomerInfoPlaceholder');
            const selectedCustomerDetailsCard = document.getElementById('selectedCustomerDetailsCard');
            const modalAddNewCustomerBtn = document.getElementById('modalAddNewCustomerBtn');
            const addCustomerFormModalEl = document.getElementById('addCustomerFormModal');
            const addCustomerFormModal = addCustomerFormModalEl ? new bootstrap.Modal(addCustomerFormModalEl) : null;
            const addCustomerFormInModalDraft = document.getElementById('addCustomerFormInModal_draft');
            const saveNewCustomerBtnDraft = document.getElementById('saveNewCustomerBtn_draft');
            const addCustomerModalAlertPlaceholderDraft = document.getElementById('addCustomerModalAlertPlaceholder_draft');
            const backToCustomerSelectModalBtn = document.getElementById('backToCustomerSelectModalBtn');

            let currentCustomerPage = 0;
            const CUSTOMER_PAGE_SIZE = 5;
            let customerSearchKeyword = '';

            if(openCustomerSelectModalBtn && customerSelectModal) {
                openCustomerSelectModalBtn.addEventListener('click', function() {
                    if(modalCustomerSearchInput) modalCustomerSearchInput.value = '';
                    customerSearchKeyword = '';
                    loadCustomersForModal(0);
                    customerSelectModal.show();
                });
            }

            if(modalSearchCustomerBtn && modalCustomerSearchInput) {
                modalSearchCustomerBtn.addEventListener('click', function() {
                    customerSearchKeyword = modalCustomerSearchInput.value.trim();
                    loadCustomersForModal(0, customerSearchKeyword);
                });
                modalCustomerSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        customerSearchKeyword = modalCustomerSearchInput.value.trim();
                        loadCustomersForModal(0, customerSearchKeyword);
                    }
                });
            }

            function loadCustomersForModal(page, keyword = customerSearchKeyword) {
                currentCustomerPage = page;
                const searchUrl = `/customers/api/search?keyword=${encodeURIComponent(keyword)}&page=${page}&size=${CUSTOMER_PAGE_SIZE}&sort=customerName,asc`;
                if(customerModalSpinner) customerModalSpinner.style.display = 'block';
                if(customerTableBody) customerTableBody.innerHTML = '';
                if(customerModalAlertPlaceholder) customerModalAlertPlaceholder.innerHTML = '';

                fetch(searchUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`网络响应错误 (${response.status}) 在获取客户时。`);
                        return response.json();
                    })
                    .then(pageData => {
                        if (pageData && pageData.content) {
                            renderCustomerTable(pageData.content);
                            renderCustomerPagination(pageData);
                        } else {
                            renderCustomerTable([]);
                            renderCustomerPagination(null);
                        }
                    })
                    .catch(error => {
                        console.error('加载客户列表失败:', error);
                        if(customerTableBody) customerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">加载客户数据失败: ${error.message}</td></tr>`;
                        renderCustomerPagination(null);
                        showAlertInModal('加载客户数据失败: ' + error.message, 'danger', customerModalAlertPlaceholder);
                    })
                    .finally(() => {
                        if(customerModalSpinner) customerModalSpinner.style.display = 'none';
                    });
            }

            function renderCustomerTable(customers) {
                if(!customerTableBody) return;
                customerTableBody.innerHTML = '';
                if (!customers || customers.length === 0) {
                    customerTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">未找到匹配的客户记录。</td></tr>`;
                    return;
                }
                customers.forEach(customer => {
                    const row = customerTableBody.insertRow();
                    row.insertCell().textContent = customer.customerNumber || 'N/A';
                    row.insertCell().textContent = customer.customerName;
                    row.insertCell().textContent = customer.phoneNumber || 'N/A';
                    row.insertCell().textContent = customer.email || 'N/A';
                    const actionCell = row.insertCell();
                    actionCell.classList.add('text-center');
                    const selectBtn = document.createElement('button');
                    selectBtn.classList.add('btn', 'btn-sm', 'btn-primary');
                    selectBtn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> 选择';
                    selectBtn.type = 'button';
                    selectBtn.addEventListener('click', function() { selectCustomerForForm(customer); });
                    actionCell.appendChild(selectBtn);
                });
            }

            function selectCustomerForForm(customer) {
                if (selectedCustomerIdInput) selectedCustomerIdInput.value = customer.id;
                if (selectedCustomerInfoPlaceholder) {
                    selectedCustomerInfoPlaceholder.innerHTML = `<strong class="text-success">${customer.customerName}</strong> <small class="text-muted">(编号: ${customer.customerNumber || 'N/A'})</small>`;
                    selectedCustomerInfoPlaceholder.classList.remove('is-invalid-placeholder');
                }
                if(selectedCustomerDetailsCard) {
                    document.getElementById('selectedCustomerNameText').textContent = customer.customerName || 'N/A';
                    document.getElementById('selectedCustomerNumberText').textContent = customer.customerNumber || 'N/A';
                    document.getElementById('selectedCustomerPhoneText').textContent = customer.phoneNumber || 'N/A';
                    document.getElementById('selectedCustomerEmailText').textContent = customer.email || 'N/A';
                    document.getElementById('selectedCustomerAddressText').textContent = customer.address || 'N/A';
                    selectedCustomerDetailsCard.style.display = 'block';
                }
                if(customerSelectModal) customerSelectModal.hide();
                if(selectedCustomerIdInput) {
                    selectedCustomerIdInput.dispatchEvent(new Event('change'));
                    selectedCustomerIdInput.classList.remove('is-invalid');
                }
                document.getElementById('selectedCustomerIdClientFeedback').style.display = 'none';
            }

            function renderCustomerPagination(pageData) {
                if(!customerModalPagination) return;
                customerModalPagination.innerHTML = '';
                if (!pageData || pageData.totalPages === undefined || pageData.totalPages <= 1) return;
                const { totalPages, number: currentPageIdx, first, last } = pageData;
                let prevLi = document.createElement('li');
                prevLi.className = `page-item ${first ? 'disabled' : ''}`;
                let prevA = document.createElement('a');
                prevA.className = 'page-link';
                prevA.href = '#';
                prevA.innerHTML = '&laquo; <span class="d-none d-sm-inline">上一页</span>';
                if (!first) prevA.addEventListener('click', (e) => { e.preventDefault(); loadCustomersForModal(currentPageIdx - 1); });
                prevLi.appendChild(prevA);
                customerModalPagination.appendChild(prevLi);
                let currentLi = document.createElement('li');
                currentLi.className = 'page-item disabled';
                let currentA = document.createElement('a');
                currentA.className = 'page-link';
                currentA.textContent = `第 ${currentPageIdx + 1} / ${totalPages} 页`;
                currentLi.appendChild(currentA);
                customerModalPagination.appendChild(currentLi);
                let nextLi = document.createElement('li');
                nextLi.className = `page-item ${last ? 'disabled' : ''}`;
                nextA = document.createElement('a');
                nextA.className = 'page-link';
                nextA.href = '#';
                nextA.innerHTML = '<span class="d-none d-sm-inline">下一页</span> &raquo;';
                if (!last) nextA.addEventListener('click', (e) => { e.preventDefault(); loadCustomersForModal(currentPageIdx + 1); });
                nextLi.appendChild(nextA);
                customerModalPagination.appendChild(nextLi);
            }

            if(addCustomerFormInModalDraft && saveNewCustomerBtnDraft && addCustomerFormModal) {
                addCustomerFormInModalDraft.addEventListener('submit', function(event) {
                    event.preventDefault();
                    if (!addCustomerFormInModalDraft.checkValidity()) {
                        event.stopPropagation();
                        addCustomerFormInModalDraft.classList.add('was-validated');
                        return;
                    }
                    const formData = new FormData(addCustomerFormInModalDraft);
                    saveNewCustomerBtnDraft.disabled = true;
                    saveNewCustomerBtnDraft.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>保存中...';
                    fetch('/customers/api/add', {
                        method: 'POST',
                        body: new URLSearchParams(formData)
                    })
                        .then(response => {
                            if (response.status === 201) return response.json();
                            return response.json().then(errorData => { throw new Error(errorData.message || '创建客户失败') });
                        })
                        .then(newCustomer => {
                            addCustomerFormModal.hide();
                            showAlertOnMainPage(`新客户 "${newCustomer.customerName}" 已成功添加!`, 'success');
                            selectCustomerForForm(newCustomer);
                        })
                        .catch(error => {
                            showAlertInModal('添加客户失败: ' + error.message, 'danger', addCustomerModalAlertPlaceholderDraft);
                        })
                        .finally(() => {
                            saveNewCustomerBtnDraft.disabled = false;
                            saveNewCustomerBtnDraft.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>确认并保存客户';
                        });
                });
            }

            if(backToCustomerSelectModalBtn && addCustomerFormModal && customerSelectModal){
                backToCustomerSelectModalBtn.addEventListener('click', function(){
                    addCustomerFormModal.hide();
                    customerSelectModal.show();
                });
            }

            function showAlertInModal(message, type, placeholderElement, duration = 7000) {
                createAndShowAlert(message, type, placeholderElement, duration);
            }
            function showAlertOnMainPage(message, type, duration = 7000) {
                createAndShowAlert(message, type, document.getElementById('alertPlaceholder'), duration);
            }

            function createAndShowAlert(message, type, placeholderElement, duration) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                placeholderElement.innerHTML = '';
                placeholderElement.append(wrapper.firstChild);
                setTimeout(() => {
                    const bsAlert = bootstrap.Alert.getInstance(wrapper.firstChild);
                    if (bsAlert) bsAlert.close();
                }, duration);
            }

            const attachmentFilesInput = document.getElementById('attachmentFilesInput');
            const fileListContainer = document.getElementById('fileListContainer');
            const hiddenAttachmentInputsContainer = document.getElementById('hiddenAttachmentInputsContainer');
            const mainDraftForm = document.getElementById('draftContractForm');

            let uploadedFilesData = [];
            let fileUploadQueue = [];
            let isUploading = false;

            if (attachmentFilesInput) {
                attachmentFilesInput.addEventListener('change', handleFileSelection);
            }

            function handleFileSelection(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                    const maxSize = 5 * 1024 * 1024;

                    if (!allowedTypes.includes(file.type)) {
                        showAlertOnMainPage(`文件 "${file.name}" 类型不被支持。只允许PDF, 图片, Word文档。`, 'danger');
                        continue;
                    }
                    if (file.size > maxSize) {
                        showAlertOnMainPage(`文件 "${file.name}" 大小超过5MB限制。`, 'danger');
                        continue;
                    }

                    const fileEntry = {
                        id: Date.now() + '-' + i,
                        file: file,
                        status: 'pending',
                        progress: 0,
                        serverFileName: null
                    };
                    uploadedFilesData.push(fileEntry);
                    addFileToUI(fileEntry);
                    fileUploadQueue.push(fileEntry);
                }
                attachmentFilesInput.value = '';

                processFileUploadQueue();
            }

            function addFileToUI(fileEntry) {
                if (!fileListContainer) return;

                const listItem = document.createElement('div');
                listItem.id = `file-item-${fileEntry.id}`;
                listItem.classList.add('file-list-item');

                const fileInfo = document.createElement('div');
                fileInfo.classList.add('file-info');
                fileInfo.innerHTML = `
                    <span class="file-name" title="${fileEntry.file.name}">${fileEntry.file.name}</span>
                    <span class="file-size">${(fileEntry.file.size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                listItem.appendChild(fileInfo);

                const fileActions = document.createElement('div');
                fileActions.classList.add('file-actions');

                const removeBtn = document.createElement('button');
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                removeBtn.innerHTML = '<i class="bi bi-x-circle"></i> 移除';
                removeBtn.addEventListener('click', () => removeFile(fileEntry.id));
                fileActions.appendChild(removeBtn);

                listItem.appendChild(fileActions);

                const progressBarContainer = document.createElement('div');
                progressBarContainer.classList.add('file-progress');
                const progressBar = document.createElement('div');
                progressBar.classList.add('file-progress-bar');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBarContainer.appendChild(progressBar);
                listItem.appendChild(progressBarContainer);

                fileListContainer.appendChild(listItem);
            }

            function updateFileProgress(fileId, progress) {
                const progressBar = document.querySelector(`#file-item-${fileId} .file-progress-bar`);
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                }
            }

            function updateFileStatusUI(fileId, status, message = '') {
                const listItem = document.getElementById(`file-item-${fileId}`);
                if (listItem) {
                    listItem.classList.remove('upload-pending', 'upload-uploading', 'upload-completed', 'upload-error');
                    listItem.classList.add(`upload-${status}`);
                    const fileNameSpan = listItem.querySelector('.file-name');
                    const fileSizeSpan = listItem.querySelector('.file-size');
                    const statusSpan = document.createElement('span');
                    statusSpan.classList.add('file-status', `text-${status === 'completed' ? 'success' : 'danger'}`);
                    statusSpan.textContent = status === 'completed' ? ' (上传成功)' : ` (上传失败: ${message})`;
                    if (fileNameSpan && !fileNameSpan.querySelector('.file-status')) {
                        fileSizeSpan.parentNode.insertBefore(statusSpan, fileSizeSpan.nextSibling);
                    } else if (fileNameSpan && fileNameSpan.querySelector('.file-status')) {
                        fileNameSpan.querySelector('.file-status').textContent = status === 'completed' ? ' (上传成功)' : ` (上传失败: ${message})`;
                    }
                    if (status === 'completed') {
                        const progressBarContainer = listItem.querySelector('.file-progress');
                        if (progressBarContainer) progressBarContainer.style.display = 'none';
                    }
                }
            }

            function removeFile(fileId) {
                uploadedFilesData = uploadedFilesData.filter(file => file.id !== fileId);
                const listItem = document.getElementById(`file-item-${fileId}`);
                if (listItem) {
                    listItem.remove();
                }
                prepareAttachmentsForSubmission();
            }

            async function processFileUploadQueue() {
                if (isUploading) return;
                isUploading = true;

                while (fileUploadQueue.length > 0) {
                    const fileEntry = fileUploadQueue.shift();
                    if (fileEntry.status === 'pending') {
                        await uploadFile(fileEntry);
                    }
                }
                isUploading = false;
            }

            async function uploadFile(fileEntry) {
                fileEntry.status = 'uploading';
                const formData = new FormData();
                formData.append('file', fileEntry.file);

                try {
                    const response = await fetch('/attachments/upload', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || '文件上传失败');
                    }

                    const result = await response.json();
                    fileEntry.status = 'completed';
                    fileEntry.progress = 100;
                    fileEntry.serverFileName = result.fileName;
                    updateFileProgress(fileEntry.id, 100);
                    updateFileStatusUI(fileEntry.id, 'completed');
                    showAlertOnMainPage(`文件 "${fileEntry.file.name}" 上传成功。`, 'success', 3000);
                } catch (error) {
                    console.error('文件上传错误:', error);
                    fileEntry.status = 'error';
                    fileEntry.progress = 0;
                    updateFileProgress(fileEntry.id, 0);
                    updateFileStatusUI(fileEntry.id, 'error', error.message);
                    showAlertOnMainPage(`文件 "${fileEntry.file.name}" 上传失败: ${error.message}`, 'danger');
                }
            }

            function prepareAttachmentsForSubmission() {
                if (hiddenAttachmentInputsContainer) {
                    hiddenAttachmentInputsContainer.innerHTML = '';
                    uploadedFilesData.forEach(fileEntry => {
                        if (fileEntry.status === 'completed' && fileEntry.serverFileName) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = 'attachmentServerFileNames';
                            hiddenInput.value = fileEntry.serverFileName;
                            hiddenAttachmentInputsContainer.appendChild(hiddenInput);
                        }
                    });
                }
            }

            // --- 开始：电子签名逻辑 ---
            // 甲方
            const signatureCanvasPartyA = document.getElementById('signatureCanvasPartyA');
            const signatureCtxPartyA = signatureCanvasPartyA.getContext('2d');
            const clearSignatureBtnPartyA = document.getElementById('clearSignatureBtnPartyA');
            const uploadSignatureInputPartyA = document.getElementById('uploadSignatureInputPartyA');
            const signaturePreviewPartyA = document.getElementById('signaturePreviewPartyA');
            const signatureDataInputPartyA = document.getElementById('signatureDataPartyA');

            // 乙方
            const signatureCanvasPartyB = document.getElementById('signatureCanvasPartyB');
            const signatureCtxPartyB = signatureCanvasPartyB.getContext('2d');
            const clearSignatureBtnPartyB = document.getElementById('clearSignatureBtnPartyB');
            const uploadSignatureInputPartyB = document.getElementById('uploadSignatureInputPartyB');
            const signaturePreviewPartyB = document.getElementById('signaturePreviewPartyB');
            const signatureDataInputPartyB = document.getElementById('signatureDataPartyB');


            // 统一初始化画布
            function initSignatureCanvas(canvas, ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            }
            initSignatureCanvas(signatureCanvasPartyA, signatureCtxPartyA);
            initSignatureCanvas(signatureCanvasPartyB, signatureCtxPartyB);

            // 绘制函数工厂
            function createDrawHandler(canvas, ctx, previewImg) {
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                canvas.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                    if (previewImg) previewImg.style.display = 'none';
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                });

                canvas.addEventListener('mouseup', () => isDrawing = false);
                canvas.addEventListener('mouseout', () => isDrawing = false);
            }

            // 为甲方和乙方签名板创建绘制处理函数
            createDrawHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA);
            createDrawHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB);


            // 清空签名函数工厂
            function createClearSignatureHandler(canvas, ctx, previewImg, dataInput) {
                return () => {
                    initSignatureCanvas(canvas, ctx);
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    dataInput.value = '';
                };
            }
            if (clearSignatureBtnPartyA) clearSignatureBtnPartyA.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
            if (clearSignatureBtnPartyB) clearSignatureBtnPartyB.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));

            // 上传签名图片函数工厂
            function createUploadSignatureHandler(canvas, ctx, previewImg, dataInput) {
                return (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                initSignatureCanvas(canvas, ctx);
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                if (previewImg) {
                                    previewImg.src = e.target.result;
                                    previewImg.style.display = 'block';
                                }
                                dataInput.value = canvas.toDataURL('image/png');
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
            if (uploadSignatureInputPartyA) uploadSignatureInputPartyA.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
            if (uploadSignatureInputPartyB) uploadSignatureInputPartyB.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));


            // 准备签名数据以供提交 (通用化)
            function prepareSignatureForSubmission(party) {
                const canvas = document.getElementById(`signatureCanvas${party}`);
                const ctx = canvas.getContext('2d');
                const preview = document.getElementById(`signaturePreview${party}`);
                const dataInput = document.getElementById(`signatureData${party}`);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                let hasDrawn = false;
                for (let i = 0; i < imageData.length; i += 4) {
                    if (imageData[i + 3] !== 0 && (imageData[i] !== 255 || imageData[i+1] !== 255 || imageData[i+2] !== 255)) {
                        hasDrawn = true;
                        break;
                    }
                }

                if (hasDrawn) {
                    dataInput.value = canvas.toDataURL('image/png');
                } else if (preview.src && preview.style.display !== 'none') {
                    dataInput.value = preview.src;
                } else {
                    dataInput.value = '';
                }
            }
            // --- 电子签名逻辑结束 ---


            // --- 开始：模板选择和直接编辑占位符逻辑 ---
            // originalTemplateContent 变量用于存储从后端获取的原始模板内容
            let originalTemplateContent = '';

            // extractAndPreparePlaceholderValues 函数用于从 TinyMCE 内容中提取占位符值
            function extractAndPreparePlaceholderValues() {
                if (!contractEditor) return;

                const editorContent = contractEditor.getContent(); // 获取 TinyMCE 当前的 HTML 内容
                const placeholderValues = {};

                // 创建一个临时的 DOM 元素来解析编辑器内容，方便查找 span
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = editorContent;

                // 查找所有具有 .contract-placeholder 类和 data-placeholder-key 属性的可编辑 span
                const placeholderSpans = tempDiv.querySelectorAll('.contract-placeholder[data-placeholder-key][contenteditable="true"]');

                placeholderSpans.forEach(span => {
                    const key = span.dataset.placeholderKey;
                    const value = span.textContent || ''; // 获取用户实际填写的值

                    if (key) {
                        placeholderValues[key] = value;
                    }
                });

                // 将占位符值打包到隐藏字段中
                document.getElementById('placeholderValuesJson').value = JSON.stringify(placeholderValues);
            }

            // escapeRegExp 函数用于转义正则表达式特殊字符
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // templateSelect 的 change 事件监听器
            const templateSelect = document.getElementById('templateSelect');
            // 注意：templateSelect.dispatchEvent(new Event('change')); 已被移至 tinymce.init 的 'init' 事件中

            if (templateSelect) {
                templateSelect.addEventListener('change', async function() {
                    const templateId = this.value;

                    // 清除编辑器内容和原始模板内容
                    if (contractEditor) {
                        contractEditor.setContent('');
                    }
                    originalTemplateContent = '';

                    if (!templateId) {
                        return; // 选择了 "-- 不使用模板 --"
                    }

                    try {
                        const response = await fetch(`/contract-manager/api/templates/${templateId}`);
                        if (!response.ok) {
                            throw new Error(`无法获取模板详情 (状态: ${response.status})`);
                        }
                        const template = await response.json();

                        originalTemplateContent = template.templateContent || '';
                        if (!originalTemplateContent) {
                            console.warn("DEBUG: 获取到的模板内容为空。");
                            showAlertOnMainPage('选择的模板内容为空，请检查模板配置。', 'warning');
                            return;
                        }

                        const placeholderRegex = /\{\{([a-zA-Z0-9_\u4e00-\u9fa5]+?)\}\}/g;

                        let contentToDisplayInEditor = originalTemplateContent.replace(placeholderRegex, (match, placeholderName) => {
                            // 在 span 内部直接放置占位符名称，作为默认内容
                            return `<span class="contract-placeholder" data-placeholder-key="${placeholderName}" contenteditable="true">___________</span>`; // 11个下划线作为示例
                        });

                        if (contractEditor) {
                            contractEditor.setContent(contentToDisplayInEditor);
                            contractEditor.save();
                            // 移除 mceRepaint，因为其可能导致 getRng 错误
                        }

                    } catch (error) {
                        console.error("获取模板详情失败:", error);
                        showAlertOnMainPage('加载模板失败: ' + error.message, 'danger');
                    }
                });
            }
            // --- 模板选择和直接编辑占位符逻辑结束 ---

            console.log("DEBUG: draft-contract.html 的内联脚本主要逻辑执行完毕。");
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>