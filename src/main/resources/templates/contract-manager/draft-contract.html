<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}" lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>èµ·è‰æ–°åˆåŒ - åˆåŒç®¡ç†ç³»ç»Ÿ</title>
    <th:block layout:fragment="css-links">
    </th:block>
    <style layout:fragment="inline-css">
        .card-header { font-weight: 500; }
        #selectedCustomerInfoPlaceholder {
            padding: 0.575rem .75rem;
            border: 1px solid #dee2e6;
            border-left: 0;
            border-top-right-radius: .25rem;
            border-bottom-right-radius: .25rem;
            background-color: #e9ecef;
            line-height: 1.5;
            min-height: calc(1.5em + .5rem + 2px);
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        #customerTableModal tbody tr { cursor: pointer; }
        #customerTableModal tbody tr:hover { background-color: #f8f9fa; }
        .modal-xl { max-width: 900px; }
        .form-label { font-weight: 500; }
        .required-asterisk { color: var(--bs-danger); }
        #alertPlaceholder { min-height: 60px; transition: opacity 0.15s linear; }
        #alertPlaceholder:empty { min-height: 0; opacity: 0; }
        .form-text { font-size: .875em; }
        .is-invalid-placeholder {
            border-color: var(--bs-danger) !important;
        }

        /* Styles for multi-file upload list */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: #f8f9fa;
        }
        .file-info {
            flex-grow: 1;
            margin-right: 1rem;
            overflow: hidden;
        }
        .file-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .file-size, .file-status {
            font-size: 0.8em;
            color: #6c757d;
        }
        .file-actions button {
            margin-left: 0.5rem;
        }
        .file-progress {
            height: 10px;
            margin-top: 0.25rem;
            background-color: #e9ecef;
            border-radius: .25rem;
            overflow: hidden;
        }
        .file-progress-bar {
            background-color: #0d6efd;
            height: 100%;
            transition: width 0.2s ease-in-out;
            color: white;
            font-size: 0.7em;
            line-height:10px;
            text-align: center;
        }
        .file-list-item.upload-error {
            border-left: 5px solid var(--bs-danger);
            background-color: #fbe9e7;
        }
        .file-list-item.upload-success {
            border-left: 5px solid var(--bs-success);
            background-color: #e8f5e9;
        }
        .file-list-item.upload-need_file {
            border-left: 5px solid var(--bs-warning);
            background-color: #fff3cd;
            animation: pulse-warning 2s infinite;
        }
        @keyframes pulse-warning {
            0% { background-color: #fff3cd; }
            50% { background-color: #ffeaa7; }
            100% { background-color: #fff3cd; }
        }

        /* TinyMCE å†…å®¹ä¸­å ä½ç¬¦çš„é«˜äº®æ ·å¼ */
        .mce-content-body .contract-placeholder {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px dashed #ffc107;
            font-weight: bold;
            display: inline-block;
            min-width: 50px;
            text-align: center;
            user-select: none;
            cursor: text;
            min-height: 1em;
            vertical-align: middle;
        }
        /* å½“ç”¨æˆ·å°è¯•é€‰æ‹©æˆ–ç‚¹å‡»å ä½ç¬¦æ—¶ï¼Œå…è®¸æ–‡æœ¬é€‰æ‹©/ç¼–è¾‘ */
        .mce-content-body .contract-placeholder:focus,
        .mce-content-body .contract-placeholder:active,
        .mce-content-body .contract-placeholder:hover {
            user-select: text;
        }
        /* å¦‚æœ span ä¸ºç©ºï¼Œæ˜¾ç¤º data-placeholder-key çš„å€¼ä½œä¸ºæç¤º */
        /* ç”±äºJSå·²ç»é»˜è®¤å¡«å……äº†placeholderNameï¼Œæ­¤CSSå¯èƒ½ä¸å†ä¸¥æ ¼éœ€è¦ï¼Œä½†ä¿ç•™ä»¥é˜²ä¸‡ä¸€ */
        .mce-content-body .contract-placeholder:empty::before {
            content: attr(data-placeholder-key);
            color: #aaa;
            font-style: italic;
            pointer-events: none;
            display: inline-block;
        }

        /* ç”µå­ç­¾åç”»å¸ƒæ ·å¼ */
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fdfdfd;
            box-shadow: inset 0 1px 2px rgba(0,0,0,.075);
        }
        .signature-preview {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            margin-top: 10px;
            display: block;
        }
    </style>
</head>
<body>

<section layout:fragment="content">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0 h2"><i class="bi bi-file-earmark-plus-fill text-primary me-2"></i>èµ·è‰æ–°åˆåŒ</h1>
            <a th:href="@{/dashboard}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i>è¿”å›ä»ªè¡¨ç›˜
            </a>
        </div>

        <div id="alertPlaceholder">
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i> <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${#fields.hasErrors('contractDraftRequest.*')}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong><i class="bi bi-exclamation-circle-fill me-2"></i>è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥ï¼š</strong>
                <ul class="mb-0 ps-4">
                    <li th:each="err : ${#fields.errors('contractDraftRequest.*')}" th:text="${err}"></li>
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${attachmentError}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${attachmentError}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>


        <form th:action="@{/contract-manager/draft}" method="post" th:object="${contractDraftRequest}" id="draftContractForm" class="needs-validation" novalidate>
            <div id="hiddenAttachmentInputsContainer"></div>
            <input type="hidden" id="placeholderValuesJson" name="placeholderValues">
            <input type="hidden" id="signatureDataPartyA" name="signatureDataPartyA">
            <input type="hidden" id="signatureDataPartyB" name="signatureDataPartyB">


            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-info-circle-fill me-2"></i>åˆåŒåŸºæœ¬ä¿¡æ¯
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">é€‰æ‹©åˆåŒæ¨¡æ¿ (å¯é€‰)</label>
                        <select class="form-select form-control-sm" id="templateSelect" th:field="*{templateId}">
                            <option value="">-- ä¸ä½¿ç”¨æ¨¡æ¿ --</option>
                            <option th:each="template : ${contractTemplates}"
                                    th:value="${template.id}"
                                    th:text="${template.templateName}"></option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="contractName" class="form-label">åˆåŒåç§° <span class="required-asterisk">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="contractName" th:field="*{contractName}" required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('contractName')}" th:errors="*{contractName}">åˆåŒåç§°ä¸èƒ½ä¸ºç©ºã€‚</div>
                        <div class="invalid-feedback">è¯·è¾“å…¥åˆåŒåç§°ã€‚</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ <span class="required-asterisk">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="startDate" th:field="*{startDate}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('startDate')}" th:errors="*{startDate}">å¼€å§‹æ—¥æœŸä¸èƒ½ä¸ºç©ºã€‚</div>
                            <div class="invalid-feedback">è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸã€‚</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ <span class="required-asterisk">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="endDate" th:field="*{endDate}" required>
                            <div class="invalid-feedback" id="endDateValidationFeedback" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}">ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºç©ºã€‚</div>
                            <div class="invalid-feedback">ç»“æŸæ—¥æœŸä¸å¯ä»¥æ˜¯è¿‡å»æ—¶é—´</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-person-badge-fill me-2"></i>å®¢æˆ·ä¿¡æ¯
                </div>
                <div class="card-body">
                    <label class="form-label">ç­¾çº¦å®¢æˆ· <span class="required-asterisk">*</span></label>
                    <div class="input-group input-group-sm">
                        <button class="btn btn-sm btn-outline-primary" type="button" id="openCustomerSelectModalBtn" style="min-width: 110px;">
                            <i class="bi bi-search me-1"></i> é€‰æ‹©å®¢æˆ·
                        </button>
                        <div id="selectedCustomerInfoPlaceholder" class="form-control-sm"> <span class="text-muted">å°šæœªé€‰æ‹©å®¢æˆ·</span>
                        </div>
                    </div>
                    <input type="hidden" id="selectedCustomerId" th:field="*{selectedCustomerId}" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('selectedCustomerId')}" th:errors="*{selectedCustomerId}"></div>
                    <div class="invalid-feedback" id="selectedCustomerIdClientFeedback">è¯·é€‰æ‹©ä¸€ä¸ªç­¾çº¦å®¢æˆ·ã€‚</div>

                    <div id="selectedCustomerDetailsCard" class="card mt-2" style="display: none;">
                        <div class="card-body p-2">
                            <h6 class="card-title mb-1 small"><strong id="selectedCustomerNameText"></strong></h6>
                            <p class="card-text mb-0 small">
                                <strong>ç¼–å·:</strong> <span id="selectedCustomerNumberText"></span> <br>
                                <strong>ç”µè¯:</strong> <span id="selectedCustomerPhoneText"></span> <br>
                                <strong>é‚®ç®±:</strong> <span id="selectedCustomerEmailText"></span> <br>
                                <strong>åœ°å€:</strong> <span id="selectedCustomerAddressText"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <i class="bi bi-file-text-fill me-2"></i>åˆåŒæ¡æ¬¾ä¸é™„ä»¶
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="contractContent" class="form-label">åˆåŒä¸»è¦å†…å®¹</label>
                        <textarea class="form-control form-control-sm" id="contractContent" rows="8" th:field="*{contractContent}" placeholder="è¯·åœ¨æ­¤å¤„å¡«å†™åˆåŒçš„æ ¸å¿ƒæ¡æ¬¾å’Œå†…å®¹..."></textarea>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('contractContent')}" th:errors="*{contractContent}"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç”²æ–¹ç­¾å­— <span class="required-asterisk">*</span></label>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted mb-2">è¯·åœ¨ä¸‹æ–¹ç”»å¸ƒä¸Šç­¾åï¼Œæˆ–ä¸Šä¼ æ‚¨çš„ç­¾åå›¾ç‰‡ã€‚</p>
                                <canvas id="signatureCanvasPartyA" class="signature-pad" width="300" height="100"></canvas>
                                <div class="d-flex mt-2 mb-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyA"><i class="bi bi-x-circle me-1"></i>æ¸…ç©ºç­¾å</button>
                                    <label for="uploadSignatureInputPartyA" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>ä¸Šä¼ ç­¾åå›¾ç‰‡</label>
                                    <input type="file" id="uploadSignatureInputPartyA" accept="image/png, image/jpeg" style="display: none;">
                                </div>
                                <img id="signaturePreviewPartyA" class="signature-preview" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ä¹™æ–¹ç­¾å­— <span class="required-asterisk">*</span></label>
                        <div class="card">
                            <div class="card-body">
                                <p class="small text-muted mb-2">è¯·åœ¨ä¸‹æ–¹ç”»å¸ƒä¸Šç­¾åï¼Œæˆ–ä¸Šä¼ æ‚¨çš„ç­¾åå›¾ç‰‡ã€‚</p>
                                <canvas id="signatureCanvasPartyB" class="signature-pad" width="300" height="100"></canvas>
                                <div class="d-flex mt-2 mb-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clearSignatureBtnPartyB"><i class="bi bi-x-circle me-1"></i>æ¸…ç©ºç­¾å</button>
                                    <label for="uploadSignatureInputPartyB" class="btn btn-outline-primary btn-sm mb-0"><i class="bi bi-upload me-1"></i>ä¸Šä¼ ç­¾åå›¾ç‰‡</label>
                                    <input type="file" id="uploadSignatureInputPartyB" accept="image/png, image/jpeg" style="display: none;">
                                </div>
                                <img id="signaturePreviewPartyB" class="signature-preview" style="display:none;">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                    <label for="attachmentFilesInput" class="form-label mb-0">ä¸Šä¼ åˆåŒé™„ä»¶ (å¯é€‰, å¯å¤šé€‰)</label>
                    <button type="button" id="fileTypeHelpBtn" class="btn btn-outline-info btn-sm" onclick="showFileTypeHelp()">
                        <i class="bi bi-question-circle me-1"></i>æ”¯æŒçš„æ–‡ä»¶ç±»å‹
                    </button>
                </div>
                <input type="file" class="form-control form-control-sm mt-2" id="attachmentFilesInput" multiple>
                        <div class="form-text mb-2">
                            <i class="bi bi-info-circle text-info me-1"></i>
                            æ”¯æŒOfficeæ–‡æ¡£ã€PDFã€å›¾ç‰‡ã€å‹ç¼©åŒ…ã€å¤šåª’ä½“ç­‰å¤šç§æ ¼å¼ã€‚æ™®é€šæ–‡ä»¶æœ€å¤§10MBï¼Œå‹ç¼©åŒ…/å¤šåª’ä½“æ–‡ä»¶æœ€å¤§100MBã€‚
                            <br><small class="text-muted">å¯æŒ‰ä½Ctrl/Shifté€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚</small>
                        </div>

                        <div id="fileListContainer" class="mt-2">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-center">
                <button type="submit" class="btn btn-primary btn-lg px-5 me-3" id="submitDraftContractBtn">
                    <i class="bi bi-save-fill me-2"></i>ç¡®è®¤èµ·è‰å¹¶æäº¤
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg px-4">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>å…¨éƒ¨é‡ç½®
                </button>
            </div>
        </form>
    </div>

    <div class="modal fade" id="customerSelectModal" tabindex="-1" aria-labelledby="customerSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerSelectModalLabel"><i class="bi bi-people-fill me-2"></i>é€‰æ‹©ç­¾çº¦å®¢æˆ·</h5>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="input-group input-group-sm flex-grow-1 me-2">
                            <input type="text" id="modalCustomerSearchInput" class="form-control" placeholder="è¾“å…¥å®¢æˆ·åç§°æˆ–ç¼–å·æœç´¢...">
                            <button type="button" class="btn btn-sm btn-primary" id="modalSearchCustomerBtn"><i class="bi bi-search"></i></button>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" id="modalAddNewCustomerBtn">
                            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ æ–°å®¢æˆ·
                        </button>
                    </div>
                    <div id="customerModalAlertPlaceholder"></div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover table-sm" id="customerTableModal">
                            <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">å®¢æˆ·ç¼–å·</th>
                                <th scope="col">å®¢æˆ·åç§°</th>
                                <th scope="col">è”ç³»ç”µè¯</th>
                                <th scope="col">é‚®ç®±</th>
                                <th scope="col" class="text-center">æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div id="customerModalSpinner" class="text-center my-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                    <nav aria-label="å®¢æˆ·åˆ†é¡µ" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center" id="customerModalPagination">
                        </ul>
                    </nav>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i>å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCustomerFormModal" tabindex="-1" aria-labelledby="addCustomerFormModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="addCustomerFormInModal_draft" class="needs-validation" novalidate>
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="addCustomerFormModalLabel"><i class="bi bi-person-plus-fill me-2"></i>å¿«é€Ÿæ·»åŠ æ–°å®¢æˆ·</h5>
                        <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="addCustomerModalAlertPlaceholder_draft" class="mb-3"></div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_customerNumber" class="form-label">å®¢æˆ·ç¼–å· <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control form-control-sm" name="customerNumber" id="new_draft_customerNumber" required placeholder="ä¾‹å¦‚: CUST-2025-001">
                                <div class="invalid-feedback">è¯·è¾“å…¥å®¢æˆ·ç¼–å·ã€‚</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_customerName" class="form-label">å®¢æˆ·åç§° <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control form-control-sm" name="customerName" id="new_draft_customerName" required placeholder="è¯·è¾“å…¥å®Œæ•´çš„å®¢æˆ·å®˜æ–¹åç§°">
                                <div class="invalid-feedback">è¯·è¾“å…¥å®¢æˆ·åç§°ã€‚</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_phoneNumber" class="form-label">è”ç³»ç”µè¯ <span class="required-asterisk">*</span></label>
                                <input type="tel" class="form-control form-control-sm" name="phoneNumber" id="new_draft_phoneNumber" required placeholder="ä¾‹å¦‚: 0755-12345678 æˆ– 13800138000">
                                <div class="invalid-feedback">è¯·è¾“å…¥æœ‰æ•ˆçš„è”ç³»ç”µè¯ã€‚</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_draft_email" class="form-label">é‚®ç®± <span class="required-asterisk">*</span></label>
                                <input type="email" class="form-control form-control-sm" name="email" id="new_draft_email" required placeholder="ä¾‹å¦‚: contact@example.com">
                                <div class="invalid-feedback">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ã€‚</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new_draft_address" class="form-label">å®¢æˆ·åœ°å€</label>
                            <textarea class="form-control form-control-sm" name="address" id="new_draft_address" rows="2" placeholder="è¯·è¾“å…¥å®¢æˆ·è¯¦ç»†é€šè®¯åœ°å€"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" id="backToCustomerSelectModalBtn">
                            <i class="bi bi-arrow-left-short"></i> è¿”å›é€‰æ‹©
                        </button>
                        <button type="submit" class="btn btn-success" id="saveNewCustomerBtn_draft">
                            <i class="bi bi-check-circle-fill me-1"></i>ç¡®è®¤å¹¶ä¿å­˜å®¢æˆ·
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- ç›´æ¥åµŒå…¥æ–‡ä»¶ç±»å‹å¸®åŠ©æ¨¡æ€æ¡† -->
<div class="modal fade" id="fileTypeHelpModal" tabindex="-1" aria-labelledby="fileTypeHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="fileTypeHelpModalLabel">
                    <i class="bi bi-info-circle-fill me-2"></i>æ”¯æŒçš„æ–‡ä»¶ç±»å‹è¯´æ˜
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="hideFileTypeHelp()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary"><i class="bi bi-file-earmark-text"></i> æ–‡æ¡£ç±»å‹</h6>
                        <ul class="list-unstyled mb-4">
                            <li><span class="badge bg-secondary me-2">PDF</span>ä¾¿æºå¼æ–‡æ¡£æ ¼å¼</li>
                            <li><span class="badge bg-secondary me-2">DOC/DOCX</span>Microsoft Word æ–‡æ¡£</li>
                            <li><span class="badge bg-secondary me-2">XLS/XLSX</span>Microsoft Excel è¡¨æ ¼</li>
                            <li><span class="badge bg-secondary me-2">PPT/PPTX</span>Microsoft PowerPoint æ¼”ç¤ºæ–‡ç¨¿</li>
                            <li><span class="badge bg-secondary me-2">TXT</span>çº¯æ–‡æœ¬æ–‡ä»¶</li>
                            <li><span class="badge bg-secondary me-2">RTF</span>å¯Œæ–‡æœ¬æ ¼å¼</li>
                        </ul>

                        <h6 class="text-success"><i class="bi bi-image"></i> å›¾ç‰‡ç±»å‹</h6>
                        <ul class="list-unstyled mb-4">
                            <li><span class="badge bg-success me-2">JPG/JPEG</span>å¸¸ç”¨ç…§ç‰‡æ ¼å¼</li>
                            <li><span class="badge bg-success me-2">PNG</span>é€æ˜èƒŒæ™¯å›¾ç‰‡</li>
                            <li><span class="badge bg-success me-2">GIF</span>åŠ¨ç”»å›¾ç‰‡</li>
                            <li><span class="badge bg-success me-2">BMP</span>ä½å›¾æ ¼å¼</li>
                            <li><span class="badge bg-success me-2">WEBP</span>ç°ä»£Webå›¾ç‰‡æ ¼å¼</li>
                            <li><span class="badge bg-success me-2">SVG</span>çŸ¢é‡å›¾å½¢</li>
                            <li><span class="badge bg-success me-2">TIFF</span>é«˜è´¨é‡å›¾ç‰‡</li>
                        </ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-warning"><i class="bi bi-file-zip"></i> å‹ç¼©æ–‡ä»¶</h6>
                        <ul class="list-unstyled mb-4">
                            <li><span class="badge bg-warning text-dark me-2">ZIP</span>é€šç”¨å‹ç¼©æ ¼å¼</li>
                            <li><span class="badge bg-warning text-dark me-2">RAR</span>WinRARå‹ç¼©æ ¼å¼</li>
                            <li><span class="badge bg-warning text-dark me-2">7Z</span>7-Zipå‹ç¼©æ ¼å¼</li>
                            <li><span class="badge bg-warning text-dark me-2">TAR</span>Unixå½’æ¡£æ ¼å¼</li>
                            <li><span class="badge bg-warning text-dark me-2">GZIP</span>GNUå‹ç¼©æ ¼å¼</li>
                        </ul>

                        <h6 class="text-danger"><i class="bi bi-play-circle"></i> å¤šåª’ä½“æ–‡ä»¶</h6>
                        <ul class="list-unstyled mb-4">
                            <li><span class="badge bg-danger me-2">MP4</span>è§†é¢‘æ–‡ä»¶</li>
                            <li><span class="badge bg-danger me-2">AVI</span>è§†é¢‘æ–‡ä»¶</li>
                            <li><span class="badge bg-danger me-2">MP3</span>éŸ³é¢‘æ–‡ä»¶</li>
                            <li><span class="badge bg-danger me-2">WAV</span>æ— æŸéŸ³é¢‘</li>
                        </ul>

                        <h6 class="text-info"><i class="bi bi-code-square"></i> æ•°æ®æ–‡ä»¶</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-info me-2">JSON</span>æ•°æ®äº¤æ¢æ ¼å¼</li>
                            <li><span class="badge bg-info me-2">XML</span>æ ‡è®°è¯­è¨€</li>
                            <li><span class="badge bg-info me-2">CSV</span>é€—å·åˆ†éš”å€¼æ–‡ä»¶</li>
                        </ul>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <h6 class="alert-heading"><i class="bi bi-info-circle"></i> æ–‡ä»¶å¤§å°é™åˆ¶ï¼š</h6>
                    <ul class="mb-0">
                        <li><strong>æ™®é€šæ–‡ä»¶</strong>ï¼šæœ€å¤§ 10MB</li>
                        <li><strong>å‹ç¼©åŒ…/å¤šåª’ä½“æ–‡ä»¶</strong>ï¼šæœ€å¤§ 100MB (æé«˜é™åˆ¶æ”¯æŒå¤§å‹å‹ç¼©åŒ…)</li>
                    </ul>
                </div>
                
                <div class="alert alert-success mt-3">
                    <h6 class="alert-heading"><i class="bi bi-check-circle"></i> æ”¯æŒåŠŸèƒ½ï¼š</h6>
                    <ul class="mb-0">
                        <li>âœ… æ–­ç‚¹ç»­ä¼ ï¼šç½‘ç»œä¸­æ–­åå¯ç»§ç»­ä¸Šä¼ </li>
                        <li>âœ… è‡ªåŠ¨é‡è¯•ï¼šå¤±è´¥åæ™ºèƒ½é‡è¯•æœºåˆ¶</li>
                        <li>âœ… åœ¨çº¿é¢„è§ˆï¼šPDFã€å›¾ç‰‡ã€æ–‡æœ¬ã€å¤šåª’ä½“æ–‡ä»¶</li>
                        <li>âœ… å®‰å…¨ä¸‹è½½ï¼šæ‰€æœ‰æ–‡ä»¶ç±»å‹å‡å¯ä¸‹è½½</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideFileTypeHelp()">
                    <i class="bi bi-x-circle me-1"></i>å…³é—­
                </button>
            </div>
        </div>
    </div>
</div>


<th:block layout:fragment="scripts">
    <script src="https://cdn.tiny.cloud/1/epd4u3q4czck41xhryufu73clhe4jzhzc0bxvnmw9t0z6ayk/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            // TinyMCE åˆå§‹åŒ–
            let contractEditor;

            tinymce.init({
                selector: '#contractContent',
                // ä¿®æ­£æ’ä»¶åˆ—è¡¨ï¼šç§»é™¤å¯èƒ½ä¸å­˜åœ¨æˆ–æœ‰é—®é¢˜çš„æ’ä»¶ï¼Œä¾‹å¦‚ 'print', 'paste'
                // ç¡®ä¿åªåŒ…å«æ‚¨ç¡®å®éœ€è¦ä¸”å½“å‰ç‰ˆæœ¬æ”¯æŒçš„æ’ä»¶
                plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount autoresize',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                autoresize_bottom_margin: 20,
                menubar: false,
                setup: function (editor) {
                    contractEditor = editor;
                    editor.on('change', function () {
                        editor.save();
                    });
                    // ç¡®ä¿ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆåå†å°è¯•æ“ä½œï¼Œé¿å… 'getRng' é”™è¯¯
                    editor.on('init', function() {
                        // å¦‚æœ templateSelect æœ‰åˆå§‹å€¼ï¼Œè§¦å‘å…¶changeäº‹ä»¶ä»¥åŠ è½½å†…å®¹
                        const templateSelect = document.getElementById('templateSelect');
                        if (templateSelect && templateSelect.value) {
                            templateSelect.dispatchEvent(new Event('change'));
                        }
                    });
                }
            });

            console.log("DEBUG: DOMContentLoaded äº‹ä»¶è§¦å‘ - è„šæœ¬å¼€å§‹æ‰§è¡Œã€‚");

            // å®¢æˆ·é€‰æ‹©åŠŸèƒ½ç”±é€šç”¨æ¨¡æ€æ¡†ç®¡ç†å™¨å¤„ç†

            // æ·»åŠ ç½‘ç»œé”™è¯¯æ£€æŸ¥
            function checkNetworkConnectivity() {
                return fetch('/customers/api/search?keyword=&page=0&size=1', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("DEBUG: ç½‘ç»œè¿æ¥æ­£å¸¸ï¼ŒAPIå“åº”:", data);
                    return true;
                })
                .catch(error => {
                    console.error("ERROR: ç½‘ç»œè¿æ¥æˆ–APIé”™è¯¯:", error);
                    showAlertOnMainPage('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œæ— æ³•åŠ è½½å®¢æˆ·æ•°æ®ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚', 'danger');
                    return false;
                });
            }

            // å®¢æˆ·é€‰æ‹©åŠŸèƒ½ç”±é€šç”¨æ¨¡æ€æ¡†ç®¡ç†å™¨å¤„ç†

            // å®¢æˆ·åŠ è½½åŠŸèƒ½ç”±é€šç”¨æ¨¡æ€æ¡†ç®¡ç†å™¨å¤„ç†

            // æ·»åŠ Chromeç¬¬ä¸‰æ–¹Cookieè­¦å‘Šå¤„ç†
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                // å¿½ç•¥Chromeæ‰©å±•ç›¸å…³çš„é”™è¯¯
                window.addEventListener('error', function(event) {
                    if (event.message && event.message.includes('chrome')) {
                        console.warn('Chromeæ‰©å±•ç›¸å…³é”™è¯¯å·²å¿½ç•¥:', event.message);
                        event.preventDefault();
                        return false;
                    }
                });
            }

            // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('unhandledrejection', function(event) {
                console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                if (event.reason && event.reason.message && event.reason.message.includes('å®¢æˆ·')) {
                    showAlertOnMainPage('å®¢æˆ·æ•°æ®åŠ è½½å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'warning');
                }
            });

            console.log("DEBUG: draft-contract.html çš„å†…è”è„šæœ¬ä¸»è¦é€»è¾‘æ‰§è¡Œå®Œæ¯•ã€‚");
            
            // æ£€æŸ¥Bootstrapæ˜¯å¦æ­£ç¡®åŠ è½½
            if (typeof bootstrap !== 'undefined') {
                console.log("Bootstrap 5 JS æˆåŠŸåŠ è½½å¹¶å¯ç”¨ã€‚");
                
                // æ‰‹åŠ¨åˆå§‹åŒ–ä¸‹æ‹‰èœå•
                const adminMenuDropdown = document.getElementById('adminMenuDropdown');
                const userDropdown = document.getElementById('userDropdown');
                
                if (adminMenuDropdown) {
                    console.log("æ‰‹åŠ¨åˆå§‹åŒ– Bootstrap Dropdown: adminMenuDropdown");
                    new bootstrap.Dropdown(adminMenuDropdown);
                }
                
                if (userDropdown) {
                    console.log("æ‰‹åŠ¨åˆå§‹åŒ– Bootstrap Dropdown: userDropdown");
                    new bootstrap.Dropdown(userDropdown);
                }
            } else {
                console.error("Bootstrap 5 JS æœªæ­£ç¡®åŠ è½½ï¼");
                showAlertOnMainPage('é¡µé¢è„šæœ¬åŠ è½½å¼‚å¸¸ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨', 'warning');
            }

            // --- å¼€å§‹ï¼šç°æœ‰å®¢æˆ·é€‰æ‹©å’Œ Bootstrap éªŒè¯é€»è¾‘ ---
            (function () {
                'use strict'
                var forms = document.querySelectorAll('.needs-validation');
                var customerIdField = document.getElementById('selectedCustomerId');
                var customerIdClientFeedback = document.getElementById('selectedCustomerIdClientFeedback');
                var customerInfoPlaceholder = document.getElementById('selectedCustomerInfoPlaceholder');

                // è·å–æ—¥æœŸè¾“å…¥å­—æ®µ
                const startDateField = document.getElementById('startDate');
                const endDateField = document.getElementById('endDate');
                const endDateValidationFeedback = document.getElementById('endDateValidationFeedback');

                Array.prototype.slice.call(forms)
                    .forEach(function (form) {
                        form.addEventListener('submit', function (event) {
                            // åœ¨è¿™é‡Œæ·»åŠ æ–°çš„è¡¨å•æäº¤é¢„å¤„ç†é€»è¾‘
                            if (form.id === 'draftContractForm') {
                                // 1. ä» TinyMCE å†…å®¹ä¸­æå–å ä½ç¬¦å€¼å¹¶å¡«å……åˆ° placeholderValuesJson
                                extractAndPreparePlaceholderValues();
                                // 2. ä»ç­¾åç”»å¸ƒä¸­è·å–ç­¾åæ•°æ®
                                prepareSignatureForSubmission('PartyA');
                                prepareSignatureForSubmission('PartyB');
                                // 3. å‡†å¤‡é™„ä»¶æ•°æ®
                                prepareAttachmentsForSubmission();
                            }

                            let isFormValid = form.checkValidity();

                            if (form.id === 'draftContractForm') {
                                // å®¢æˆ·IDéªŒè¯
                                if (customerIdField && customerIdField.required && customerIdField.value === '') {
                                    if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'block';
                                    if (customerInfoPlaceholder) customerInfoPlaceholder.classList.add('is-invalid-placeholder');
                                    isFormValid = false;
                                } else if (customerIdField) {
                                    if (customerIdClientFeedback) customerIdClientFeedback.style.display = 'none';
                                    if (customerInfoPlaceholder) customerInfoPlaceholder.classList.remove('is-invalid-placeholder');
                                }

                                // ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºè¿‡å»æ—¶é—´çš„æ–°éªŒè¯
                                if (endDateField && endDateField.value) {
                                    const selectedEndDate = new Date(endDateField.value);
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);

                                    if (selectedEndDate < today) {
                                        endDateField.classList.add('is-invalid');
                                        if (endDateValidationFeedback) {
                                            endDateValidationFeedback.textContent = 'ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©ã€‚';
                                            endDateValidationFeedback.style.display = 'block';
                                        }
                                        isFormValid = false;
                                    } else {
                                        endDateField.classList.remove('is-invalid');
                                        if (endDateValidationFeedback) {
                                            endDateValidationFeedback.textContent = 'ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºç©ºã€‚';
                                            if (!endDateField.dataset.thymeleafErrors) {
                                                endDateValidationFeedback.style.display = 'none';
                                            }
                                        }
                                    }
                                }
                            }

                            if (!isFormValid) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            form.classList.add('was-validated');
                        }, false);
                    });

                // å®æ—¶éªŒè¯ç»“æŸæ—¥æœŸä½•æ—¶æ›´æ”¹
                if (endDateField) {
                    endDateField.addEventListener('change', function() {
                        const selectedEndDate = new Date(this.value);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        if (selectedEndDate < today) {
                            this.classList.add('is-invalid');
                            if (endDateValidationFeedback) {
                                endDateValidationFeedback.textContent = 'ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©ã€‚';
                                endDateValidationFeedback.style.display = 'block';
                            }
                        } else {
                            this.classList.remove('is-invalid');
                            if (endDateValidationFeedback) {
                                endDateValidationFeedback.textContent = 'ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºç©ºã€‚';
                                if (!this.dataset.thymeleafErrors) {
                                    endDateValidationFeedback.style.display = 'none';
                                }
                            }
                        }
                    });

                    if (endDateField.classList.contains('is-invalid') && endDateValidationFeedback && endDateValidationFeedback.textContent !== 'ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºç©ºã€‚') {
                        endDateField.dataset.thymeleafErrors = 'true';
                        endDateValidationFeedback.style.display = 'block';
                    }
                }

            })();
            // --- å®¢æˆ·é€‰æ‹©å’ŒéªŒè¯é€»è¾‘ç»“æŸ ---

            // å®¢æˆ·æ¨¡æ€æ¡†åŠŸèƒ½ç”±é€šç”¨æ¨¡æ€æ¡†ç®¡ç†å™¨å¤„ç†

            // æ‰€æœ‰å®¢æˆ·æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°å·²è¿ç§»åˆ°é€šç”¨æ¨¡æ€æ¡†ç®¡ç†å™¨

            const attachmentFilesInput = document.getElementById('attachmentFilesInput');
            const fileListContainer = document.getElementById('fileListContainer');
            const hiddenAttachmentInputsContainer = document.getElementById('hiddenAttachmentInputsContainer');
            const mainDraftForm = document.getElementById('draftContractForm');

            let uploadedFilesData = [];
            let fileUploadQueue = [];
            let isUploading = false;
            
            // æŒä¹…åŒ–å­˜å‚¨é”®å
            const STORAGE_KEY = 'contract_draft_uploads';
            const STORAGE_EXPIRY_HOURS = 24; // 24å°æ—¶åè¿‡æœŸ

            if (attachmentFilesInput) {
                attachmentFilesInput.addEventListener('change', handleFileSelection);
            }

            function handleFileSelection(event) {
                const files = event.target.files;
                console.log(`ç”¨æˆ·é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`);
                if (files.length === 0) return;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`å¤„ç†æ–‡ä»¶ ${i+1}: ${file.name}, ç±»å‹: ${file.type}, å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB`);
                    const allowedTypes = [
                        // ğŸ“„ æ–‡æ¡£ç±»å‹
                        'application/pdf',                    // PDFæ–‡ä»¶
                        'application/msword',                // Word 97-2003æ–‡æ¡£(.doc)
                        'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // Word 2007+æ–‡æ¡£(.docx)
                        'application/vnd.ms-excel',          // Excel 97-2003(.xls)
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // Excel 2007+(.xlsx)
                        'application/vnd.ms-powerpoint',     // PowerPoint 97-2003(.ppt)
                        'application/vnd.openxmlformats-officedocument.presentationml.presentation', // PowerPoint 2007+(.pptx)
                        'text/plain',                        // æ–‡æœ¬æ–‡ä»¶(.txt)
                        'application/rtf',                   // RTFå¯Œæ–‡æœ¬æ ¼å¼
                        
                        // ğŸ–¼ï¸ å›¾ç‰‡ç±»å‹
                        'image/jpeg',                        // JPEGå›¾ç‰‡
                        'image/png',                         // PNGå›¾ç‰‡
                        'image/gif',                         // GIFå›¾ç‰‡
                        'image/bmp',                         // BMPå›¾ç‰‡
                        'image/webp',                        // WebPå›¾ç‰‡
                        'image/tiff',                        // TIFFå›¾ç‰‡
                        'image/svg+xml',                     // SVGçŸ¢é‡å›¾
                        
                        // ğŸ“¦ å‹ç¼©æ–‡ä»¶ç±»å‹
                        'application/zip',                   // ZIPå‹ç¼©æ–‡ä»¶
                        'application/x-zip-compressed',      // ZIPå‹ç¼©æ–‡ä»¶(å¤‡ç”¨MIME)
                        'application/x-rar-compressed',      // RARå‹ç¼©æ–‡ä»¶
                        'application/vnd.rar',               // RARå‹ç¼©æ–‡ä»¶(æ–°æ ‡å‡†MIME)
                        'application/x-rar',                 // RARå‹ç¼©æ–‡ä»¶(å¤‡ç”¨MIME)
                        'application/x-7z-compressed',       // 7Zå‹ç¼©æ–‡ä»¶
                        'application/x-tar',                 // TARå½’æ¡£æ–‡ä»¶
                        'application/gzip',                  // GZIPå‹ç¼©æ–‡ä»¶
                        'application/x-gzip',                // GZIPå‹ç¼©æ–‡ä»¶(å¤‡ç”¨MIME)
                        
                        // ğŸµ å¤šåª’ä½“ç±»å‹
                        'audio/mpeg',                        // MP3éŸ³é¢‘
                        'audio/wav',                         // WAVéŸ³é¢‘
                        'video/mp4',                         // MP4è§†é¢‘
                        'video/avi',                         // AVIè§†é¢‘
                        
                        // ğŸ’» å…¶ä»–å¸¸ç”¨æ ¼å¼
                        'application/json',                  // JSONæ•°æ®æ–‡ä»¶
                        'text/csv',                          // CSVè¡¨æ ¼æ–‡ä»¶
                        'application/xml',                   // XMLæ–‡ä»¶
                        'text/xml'                           // XMLæ–‡ä»¶(å¤‡ç”¨MIME)
                    ];
                    // æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®ä¸åŒçš„å¤§å°é™åˆ¶
                    const getMaxSizeForFile = (fileType, fileName) => {
                        // é€šè¿‡æ–‡ä»¶æ‰©å±•ååˆ¤æ–­æ˜¯å¦ä¸ºå‹ç¼©åŒ…æˆ–å¤šåª’ä½“æ–‡ä»¶
                        const ext = fileName.toLowerCase();
                        const isCompressedFile = ext.endsWith('.zip') || ext.endsWith('.rar') || ext.endsWith('.7z') || 
                                                ext.endsWith('.tar') || ext.endsWith('.gz');
                        const isMultimediaFile = ext.endsWith('.mp4') || ext.endsWith('.avi') || ext.endsWith('.mp3') || ext.endsWith('.wav');
                        
                        // å¤šåª’ä½“æ–‡ä»¶å’Œå‹ç¼©åŒ…å…è®¸æ›´å¤§çš„æ–‡ä»¶
                        if (fileType.startsWith('video/') || 
                            fileType.startsWith('audio/') ||
                            fileType.includes('zip') || 
                            fileType.includes('rar') || 
                            fileType.includes('7z') ||
                            fileType.includes('tar') ||
                            fileType.includes('gzip') ||
                            fileType.includes('compressed') || // æ·»åŠ å¯¹compressedç±»å‹çš„æ”¯æŒ
                            isCompressedFile || 
                            isMultimediaFile) {
                            return 100 * 1024 * 1024; // æé«˜åˆ°100MBä»¥æ”¯æŒå¤§å‹å‹ç¼©åŒ…
                        }
                        // å…¶ä»–æ–‡ä»¶ç±»å‹ä¿æŒåŸé™åˆ¶
                        return 10 * 1024 * 1024; // 10MB
                    };
                    
                    const maxSize = getMaxSizeForFile(file.type, file.name);

                    // æ£€æŸ¥MIMEç±»å‹æˆ–æ–‡ä»¶æ‰©å±•å
                    const fileName = file.name.toLowerCase();
                    const isAllowedByMimeType = allowedTypes.includes(file.type);
                    const isAllowedByExtension = 
                        fileName.endsWith('.pdf') || fileName.endsWith('.doc') || fileName.endsWith('.docx') ||
                        fileName.endsWith('.xls') || fileName.endsWith('.xlsx') || fileName.endsWith('.ppt') || fileName.endsWith('.pptx') ||
                        fileName.endsWith('.txt') || fileName.endsWith('.rtf') ||
                        fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png') || 
                        fileName.endsWith('.gif') || fileName.endsWith('.bmp') || fileName.endsWith('.webp') || 
                        fileName.endsWith('.tiff') || fileName.endsWith('.svg') ||
                        fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.7z') || 
                        fileName.endsWith('.tar') || fileName.endsWith('.gz') ||
                        fileName.endsWith('.mp4') || fileName.endsWith('.avi') || fileName.endsWith('.mp3') || fileName.endsWith('.wav') ||
                        fileName.endsWith('.json') || fileName.endsWith('.xml') || fileName.endsWith('.csv');

                    if (!isAllowedByMimeType && !isAllowedByExtension) {
                        console.warn(`æ–‡ä»¶ "${file.name}" ä¸è¢«æ”¯æŒ - MIMEç±»å‹: ${file.type}, æ‰©å±•å: ${fileName.split('.').pop()}`);
                        showAlertOnMainPage(`æ–‡ä»¶ "${file.name}" ç±»å‹ä¸è¢«æ”¯æŒã€‚å½“å‰æ”¯æŒï¼šOfficeæ–‡æ¡£ã€PDFã€å›¾ç‰‡ã€å‹ç¼©åŒ…ã€å¤šåª’ä½“æ–‡ä»¶ç­‰ã€‚<br><small>æ£€æµ‹åˆ°çš„ç±»å‹: ${file.type}</small>`, 'danger');
                        continue;
                    } else if (!isAllowedByMimeType && isAllowedByExtension) {
                        console.info(`æ–‡ä»¶ "${file.name}" é€šè¿‡æ‰©å±•åéªŒè¯ - MIMEç±»å‹æœªè¯†åˆ«: ${file.type}`);
                    }
                    if (file.size > maxSize) {
                        const sizeLimitMB = Math.round(maxSize / 1024 / 1024);
                        const fileName = file.name.toLowerCase();
                        const isLargeFile = maxSize > 10 * 1024 * 1024; // åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†å¤§æ–‡ä»¶é™åˆ¶
                        const fileTypeName = isLargeFile ? 'å‹ç¼©åŒ…/å¤šåª’ä½“æ–‡ä»¶' : 'æ™®é€šæ–‡ä»¶';
                        showAlertOnMainPage(`æ–‡ä»¶ "${file.name}" å¤§å°è¶…è¿‡${fileTypeName}çš„${sizeLimitMB}MBé™åˆ¶ã€‚<br><small>å½“å‰æ–‡ä»¶å¤§å°: ${(file.size/1024/1024).toFixed(2)}MB</small>`, 'danger');
                        continue;
                    }

                    const fileEntry = {
                        id: Date.now() + '-' + i,
                        file: file,
                        status: 'pending',
                        progress: 0,
                        serverFileName: null
                    };
                    uploadedFilesData.push(fileEntry);
                    addFileToUI(fileEntry);
                    fileUploadQueue.push(fileEntry);
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                }
                attachmentFilesInput.value = '';

                processFileUploadQueue();
            }

            function addFileToUI(fileEntry) {
                if (!fileListContainer) return;

                const listItem = document.createElement('div');
                listItem.id = `file-item-${fileEntry.id}`;
                listItem.classList.add('file-list-item');

                const fileInfo = document.createElement('div');
                fileInfo.classList.add('file-info');
                fileInfo.innerHTML = `
                    <span class="file-name" title="${fileEntry.file.name}">${fileEntry.file.name}</span>
                    <span class="file-size">${(fileEntry.file.size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                listItem.appendChild(fileInfo);

                const fileActions = document.createElement('div');
                fileActions.classList.add('file-actions');

                // é¢„è§ˆæŒ‰é’®ï¼ˆä»…å¯¹å·²å®Œæˆä¸Šä¼ çš„æ–‡ä»¶æ˜¾ç¤ºï¼‰
                const previewBtn = document.createElement('button');
                previewBtn.classList.add('btn', 'btn-sm', 'btn-outline-info', 'me-2');
                previewBtn.innerHTML = '<i class="bi bi-eye"></i> é¢„è§ˆ';
                previewBtn.style.display = 'none'; // åˆå§‹éšè—ï¼Œä¸Šä¼ å®Œæˆåæ˜¾ç¤º
                previewBtn.addEventListener('click', () => {
                    if (fileEntry.serverFileName) {
                        handlePreviewFile(fileEntry.serverFileName);
                    }
                });
                fileActions.appendChild(previewBtn);

                const removeBtn = document.createElement('button');
                removeBtn.classList.add('btn', 'btn-sm', 'btn-danger');
                removeBtn.innerHTML = '<i class="bi bi-x-circle"></i> ç§»é™¤';
                removeBtn.addEventListener('click', () => removeFile(fileEntry.id));
                fileActions.appendChild(removeBtn);

                // é‡è¯•æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰
                const retryBtn = document.createElement('button');
                retryBtn.classList.add('btn', 'btn-sm', 'btn-warning', 'me-2');
                retryBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> é‡è¯•';
                retryBtn.style.display = 'none';
                retryBtn.addEventListener('click', () => retryUpload(fileEntry.id));
                fileActions.insertBefore(retryBtn, removeBtn);

                listItem.appendChild(fileActions);

                const progressBarContainer = document.createElement('div');
                progressBarContainer.classList.add('file-progress');
                const progressBar = document.createElement('div');
                progressBar.classList.add('file-progress-bar');
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                progressBarContainer.appendChild(progressBar);
                
                // æ·»åŠ åˆ†å—è¿›åº¦ä¿¡æ¯
                const chunkInfo = document.createElement('small');
                chunkInfo.classList.add('chunk-info', 'text-muted', 'd-block');
                chunkInfo.style.display = 'none';
                progressBarContainer.appendChild(chunkInfo);
                
                listItem.appendChild(progressBarContainer);

                fileListContainer.appendChild(listItem);
            }

            function updateFileProgress(fileId, progress, chunkInfo = '') {
                const progressBar = document.querySelector(`#file-item-${fileId} .file-progress-bar`);
                const chunkInfoElement = document.querySelector(`#file-item-${fileId} .chunk-info`);
                
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                    
                    // æ ¹æ®è¿›åº¦æ”¹å˜è¿›åº¦æ¡é¢œè‰²
                    if (progress >= 100) {
                        progressBar.style.backgroundColor = '#198754'; // æˆåŠŸç»¿è‰²
                    } else if (progress >= 50) {
                        progressBar.style.backgroundColor = '#0d6efd'; // è“è‰²
                    } else {
                        progressBar.style.backgroundColor = '#6c757d'; // ç°è‰²
                    }
                }
                
                if (chunkInfoElement && chunkInfo) {
                    chunkInfoElement.textContent = chunkInfo;
                    chunkInfoElement.style.display = 'block';
                } else if (chunkInfoElement) {
                    chunkInfoElement.style.display = 'none';
                }
            }

            function updateFileStatusUI(fileId, status, message = '') {
                const listItem = document.getElementById(`file-item-${fileId}`);
                if (listItem) {
                    // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
                    listItem.classList.remove('upload-pending', 'upload-uploading', 'upload-completed', 'upload-error', 'upload-need_file');
                    listItem.classList.add(`upload-${status}`);
                    
                    const fileInfo = listItem.querySelector('.file-info');
                    const retryBtn = listItem.querySelector('.btn-warning');
                    const previewBtn = listItem.querySelector('.btn-outline-info');
                    
                    if (fileInfo) {
                        // å…ˆç§»é™¤å·²å­˜åœ¨çš„çŠ¶æ€span
                        const existingStatusSpan = fileInfo.querySelector('.file-status');
                        if (existingStatusSpan) {
                            existingStatusSpan.remove();
                        }
                        
                        // åˆ›å»ºæ–°çš„çŠ¶æ€span
                        const statusSpan = document.createElement('span');
                        statusSpan.classList.add('file-status', 'd-block');
                        
                        if (status === 'completed') {
                            statusSpan.classList.add('text-success');
                            statusSpan.textContent = '(ä¸Šä¼ æˆåŠŸ)';
                            if (retryBtn) retryBtn.style.display = 'none';
                            if (previewBtn) previewBtn.style.display = 'inline-block'; // æ˜¾ç¤ºé¢„è§ˆæŒ‰é’®
                        } else if (status === 'error') {
                            statusSpan.classList.add('text-danger');
                            statusSpan.textContent = `(ä¸Šä¼ å¤±è´¥: ${message})`;
                            if (retryBtn) retryBtn.style.display = 'inline-block'; // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
                        } else if (status === 'uploading') {
                            statusSpan.classList.add('text-info');
                            statusSpan.textContent = message || '(ä¸Šä¼ ä¸­...)';
                            if (retryBtn) retryBtn.style.display = 'none';
                        } else if (status === 'paused') {
                            statusSpan.classList.add('text-warning');
                            statusSpan.textContent = `(å·²æš‚åœ: ${message})`;
                            if (retryBtn) retryBtn.style.display = 'inline-block'; // æ˜¾ç¤ºé‡è¯•æŒ‰é’®
                        } else if (status === 'need_file') {
                            statusSpan.classList.add('text-warning');
                            statusSpan.innerHTML = `âš ï¸ ${message}`;
                            
                            // ä¸ºéœ€è¦é€‰æ‹©æ–‡ä»¶çš„çŠ¶æ€åˆ›å»ºç‰¹æ®Šçš„é€‰æ‹©æ–‡ä»¶æŒ‰é’®
                            if (retryBtn) {
                                retryBtn.style.display = 'inline-block';
                                retryBtn.textContent = 'ğŸ”„ é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ ';
                                retryBtn.classList.remove('btn-warning');
                                retryBtn.classList.add('btn-primary');
                                retryBtn.style.fontWeight = 'bold';
                            }
                        } else {
                            statusSpan.classList.add('text-muted');
                            statusSpan.textContent = '(ç­‰å¾…ä¸Šä¼ )';
                            if (retryBtn) {
                                retryBtn.style.display = 'none';
                                // é‡ç½®æŒ‰é’®æ ·å¼ï¼ˆé¿å…need_fileçŠ¶æ€çš„æ ·å¼æ®‹ç•™ï¼‰
                                retryBtn.textContent = 'é‡è¯•';
                                retryBtn.classList.remove('btn-primary');
                                retryBtn.classList.add('btn-warning');
                                retryBtn.style.fontWeight = 'normal';
                            }
                        }
                        
                        // æ·»åŠ åˆ°æ–‡ä»¶ä¿¡æ¯åŒºåŸŸ
                        fileInfo.appendChild(statusSpan);
                    }
                    
                    // éšè—è¿›åº¦æ¡ï¼ˆå¦‚æœä¸Šä¼ å®Œæˆï¼‰
                    if (status === 'completed') {
                        const progressBarContainer = listItem.querySelector('.file-progress');
                        if (progressBarContainer) progressBarContainer.style.display = 'none';
                    }
                }
            }

            function removeFile(fileId) {
                uploadedFilesData = uploadedFilesData.filter(file => file.id !== fileId);
                const listItem = document.getElementById(`file-item-${fileId}`);
                if (listItem) {
                    listItem.remove();
                }
                prepareAttachmentsForSubmission();
                saveUploadState(); // ä¿å­˜çŠ¶æ€
            }

            // é‡è¯•ä¸Šä¼ åŠŸèƒ½
            async function retryUpload(fileId) {
                const fileEntry = uploadedFilesData.find(file => file.id === fileId);
                if (!fileEntry) {
                    console.error(`æœªæ‰¾åˆ°æ–‡ä»¶ID: ${fileId}`);
                    return;
                }

                // å¦‚æœæ˜¯è™šæ‹Ÿæ–‡ä»¶ï¼ˆä»localStorageæ¢å¤çš„ï¼‰ï¼Œç›´æ¥å¼¹å‡ºæ–‡ä»¶é€‰æ‹©
                if (fileEntry.file.size === 0 || (fileEntry.file.size > 0 && typeof fileEntry.file.stream === 'undefined')) {
                    console.log(`æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶ "${fileEntry.file.name}"ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹`);
                    showFileSelectionDialog(fileEntry, true); // ä½¿ç”¨è‡ªåŠ¨ç»­ä¼ æ¨¡å¼
                    return;
                }

                // é‡ç½®çŠ¶æ€
                fileEntry.status = 'pending';
                fileEntry.progress = 0;
                updateFileProgress(fileId, 0);
                updateFileStatusUI(fileId, 'uploading', 'é‡æ–°å¼€å§‹ä¸Šä¼ ...');

                // æ˜¾ç¤ºè¿›åº¦æ¡
                const listItem = document.getElementById(`file-item-${fileId}`);
                if (listItem) {
                    const progressBarContainer = listItem.querySelector('.file-progress');
                    if (progressBarContainer) progressBarContainer.style.display = 'block';
                }

                try {
                    if (fileEntry.uploadId) {
                        // å¦‚æœæœ‰ä¸Šä¼ IDï¼Œå°è¯•æ–­ç‚¹ç»­ä¼ 
                        try {
                            await uploadFileWithResume(fileEntry, fileEntry.uploadId);
                        } catch (error) {
                            if (error.message === 'RESTART_UPLOAD') {
                                // éœ€è¦é‡æ–°å¼€å§‹ä¸Šä¼ 
                                console.log('é‡æ–°å¼€å§‹ä¸Šä¼ æµç¨‹...');
                                await uploadFile(fileEntry);
                                return;
                            } else if (error.message === 'NEED_REAL_FILE') {
                                // éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹
                                console.log('æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œç›´æ¥å¼€å§‹æ–‡ä»¶é€‰æ‹©æµç¨‹');
                                showFileSelectionDialog(fileEntry, true); // ä½¿ç”¨è‡ªåŠ¨ç»­ä¼ æ¨¡å¼
                                return;
                            } else {
                                throw error; // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                            }
                        }
                    } else {
                        // å¦åˆ™é‡æ–°å¼€å§‹ä¸Šä¼ 
                        await uploadFile(fileEntry);
                        return; // uploadFile ä¼šå¤„ç†å®Œæ•´æµç¨‹
                    }

                    // 3. å®Œæˆä¸Šä¼ 
                    const finalizeResponse = await fetch(`/api/attachments/finalize/${fileEntry.uploadId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                    });

                    if (!finalizeResponse.ok) {
                        throw new Error('å®Œæˆä¸Šä¼ å¤±è´¥');
                    }

                    const finalizeResult = await finalizeResponse.json();
                    
                    fileEntry.status = 'completed';
                    fileEntry.progress = 100;
                    fileEntry.serverFileName = finalizeResult.fileName;
                    updateFileProgress(fileEntry.id, 100);
                    updateFileStatusUI(fileEntry.id, 'completed');
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlertOnMainPage(`æ–‡ä»¶ "${fileEntry.file.name}" é‡è¯•ä¸Šä¼ æˆåŠŸã€‚`, 'success', 3000);
                    
                } catch (error) {
                    console.error('é‡è¯•ä¸Šä¼ å¤±è´¥:', error);
                    fileEntry.status = 'error';
                    updateFileStatusUI(fileEntry.id, 'error', `é‡è¯•å¤±è´¥: ${error.message}`);
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlertOnMainPage(`æ–‡ä»¶ "${fileEntry.file.name}" é‡è¯•ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            // ç½‘ç»œçŠ¶æ€ç›‘æµ‹
            function setupNetworkStatusMonitoring() {
                window.addEventListener('online', () => {
                    console.log('ç½‘ç»œå·²æ¢å¤');
                    showAlertOnMainPage('ç½‘ç»œè¿æ¥å·²æ¢å¤ï¼Œæ‚¨å¯ä»¥ç»§ç»­ä¸Šä¼ æ–‡ä»¶ã€‚', 'info', 5000);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ä¸Šä¼ ï¼Œæç¤ºç”¨æˆ·é‡è¯•
                    const failedUploads = uploadedFilesData.filter(file => file.status === 'error');
                    if (failedUploads.length > 0) {
                        showAlertOnMainPage(`å‘ç° ${failedUploads.length} ä¸ªå¤±è´¥çš„ä¸Šä¼ ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»"é‡è¯•"æŒ‰é’®ç»§ç»­ä¸Šä¼ ã€‚`, 'warning', 8000);
                    }
                });

                window.addEventListener('offline', () => {
                    console.log('ç½‘ç»œå·²æ–­å¼€');
                    showAlertOnMainPage('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œä¸Šä¼ å¯èƒ½ä¼šå¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'warning', 8000);
                });
            }

            // å¯åŠ¨ç½‘ç»œçŠ¶æ€ç›‘æµ‹
            setupNetworkStatusMonitoring();
            
            // é¡µé¢åŠ è½½æ—¶æ¢å¤æœªå®Œæˆçš„ä¸Šä¼ 
            restoreUploadState();
            
            // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿‡æœŸçŠ¶æ€
            window.addEventListener('beforeunload', clearExpiredUploads);
            
            // è¡¨å•æäº¤æˆåŠŸåæ¸…é™¤ä¸Šä¼ çŠ¶æ€
            window.clearUploadStateOnSuccess = function() {
                localStorage.removeItem(STORAGE_KEY);
                console.log('è¡¨å•æäº¤æˆåŠŸï¼Œå·²æ¸…é™¤ä¸Šä¼ çŠ¶æ€');
            };

            // å·²ç§»é™¤è‡ªåŠ¨æ‰¹é‡ç»­ä¼ ç›¸å…³ä»£ç ï¼Œæ”¹ä¸ºæ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶

            // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            function showFileSelectionDialog(fileEntry, isAutoResume = false) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';
                
                if (isAutoResume) {
                    // è‡ªåŠ¨ç»­ä¼ æ¨¡å¼ä¸‹ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·æç¤º
                    showAlertOnMainPage(`è¯·é€‰æ‹©æ–‡ä»¶ "${fileEntry.file.name}" ä»¥ç»§ç»­æ–­ç‚¹ç»­ä¼ `, 'warning', 8000);
                }
                
                input.onchange = function(e) {
                    const selectedFile = e.target.files[0];
                    if (selectedFile) {
                        // éªŒè¯æ–‡ä»¶åå’Œå¤§å°æ˜¯å¦åŒ¹é…
                        if (selectedFile.name === fileEntry.file.name && selectedFile.size === fileEntry.file.size) {
                            // æ›¿æ¢æ–‡ä»¶å¯¹è±¡
                            console.log(`æ–‡ä»¶é‡æ–°é€‰æ‹©æˆåŠŸ: ${selectedFile.name}, å¤§å°: ${selectedFile.size} bytes`);
                            fileEntry.file = selectedFile;
                            
                            // éªŒè¯æ–°æ–‡ä»¶å¯¹è±¡çš„åˆ‡ç‰‡åŠŸèƒ½
                            try {
                                const testChunk = selectedFile.slice(0, Math.min(1024, selectedFile.size));
                                console.log(`æ–°æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•æˆåŠŸï¼Œæµ‹è¯•åˆ†å—å¤§å°: ${testChunk.size} bytes`);
                            } catch (sliceError) {
                                console.error('æ–°æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å¤±è´¥:', sliceError);
                                alert('é€‰æ‹©çš„æ–‡ä»¶æ— æ³•æ­£å¸¸è¯»å–ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚');
                                return;
                            }
                            
                            updateFileStatusUI(fileEntry.id, 'uploading', 'æ–‡ä»¶å·²é€‰æ‹©ï¼Œå¼€å§‹æ–­ç‚¹ç»­ä¼ ...');
                            
                            // ç«‹å³å¼€å§‹ä¸Šä¼ 
                            setTimeout(() => {
                                retryUpload(fileEntry.id);
                            }, 300);
                        } else {
                            const proceed = confirm(`é€‰æ‹©çš„æ–‡ä»¶ä¸åŸæ–‡ä»¶ä¸åŒ¹é…ï¼š\nåŸæ–‡ä»¶: ${fileEntry.file.name} (${(fileEntry.file.size/1024/1024).toFixed(2)}MB)\næ–°æ–‡ä»¶: ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(2)}MB)\n\næ˜¯å¦ä»è¦ä½¿ç”¨æ–°æ–‡ä»¶ï¼Ÿ`);
                            if (proceed) {
                                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                                fileEntry.file = selectedFile;
                                fileEntry.uploadId = null; // æ¸…é™¤æ—§çš„uploadId
                                fileEntry.progress = 0;
                                
                                // æ›´æ–°UIæ˜¾ç¤º
                                const fileInfo = document.querySelector(`#file-item-${fileEntry.id} .file-info`);
                                if (fileInfo) {
                                    fileInfo.innerHTML = `
                                        <span class="file-name" title="${selectedFile.name}">${selectedFile.name}</span>
                                        <span class="file-size">${(selectedFile.size / 1024 / 1024).toFixed(2)} MB</span>
                                    `;
                                }
                                
                                updateFileStatusUI(fileEntry.id, 'pending', 'æ–°æ–‡ä»¶å·²é€‰æ‹©ï¼Œå‡†å¤‡ä¸Šä¼ ');
                                
                                // ç«‹å³å¼€å§‹ä¸Šä¼ 
                                setTimeout(() => {
                                    retryUpload(fileEntry.id);
                                }, 500);
                            }
                        }
                    }
                };
                input.click();
            }

            // ç®€å•çš„æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
            window.showFileTypeHelp = function() {
                console.log('æ˜¾ç¤ºæ–‡ä»¶ç±»å‹å¸®åŠ©');
                const modal = document.getElementById('fileTypeHelpModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    modal.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('modal-open');
                    
                    // æ·»åŠ é®ç½©å±‚
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.id = 'simple-backdrop';
                    backdrop.onclick = function() { hideFileTypeHelp(); };
                    document.body.appendChild(backdrop);
                }
            };
            
            window.hideFileTypeHelp = function() {
                console.log('éšè—æ–‡ä»¶ç±»å‹å¸®åŠ©');
                const modal = document.getElementById('fileTypeHelpModal');
                const backdrop = document.getElementById('simple-backdrop');
                
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('modal-open');
                }
                
                if (backdrop) {
                    backdrop.remove();
                }
            };

            // æŒä¹…åŒ–ä¸Šä¼ çŠ¶æ€åˆ°localStorage
            function saveUploadState() {
                try {
                    const uploadState = {
                        timestamp: Date.now(),
                        files: uploadedFilesData.map(file => ({
                            id: file.id,
                            name: file.file.name,
                            size: file.file.size,
                            type: file.file.type,
                            status: file.status,
                            progress: file.progress,
                            uploadId: file.uploadId,
                            serverFileName: file.serverFileName,
                            lastModified: file.file.lastModified // ç”¨äºéªŒè¯æ–‡ä»¶ä¸€è‡´æ€§
                        }))
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(uploadState));
                    console.log('ä¸Šä¼ çŠ¶æ€å·²ä¿å­˜');
                } catch (error) {
                    console.warn('ä¿å­˜ä¸Šä¼ çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // ä»localStorageæ¢å¤ä¸Šä¼ çŠ¶æ€
            function restoreUploadState() {
                try {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (!savedState) return;

                    const uploadState = JSON.parse(savedState);
                    const now = Date.now();
                    const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;

                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    if (now - uploadState.timestamp > expiryTime) {
                        console.log('ä¿å­˜çš„ä¸Šä¼ çŠ¶æ€å·²è¿‡æœŸï¼Œæ¸…é™¤');
                        localStorage.removeItem(STORAGE_KEY);
                        return;
                    }

                    if (uploadState.files && uploadState.files.length > 0) {
                        console.log(`å‘ç° ${uploadState.files.length} ä¸ªæœªå®Œæˆçš„ä¸Šä¼ `);
                        showUploadRestorationDialog(uploadState.files);
                    }
                } catch (error) {
                    console.warn('æ¢å¤ä¸Šä¼ çŠ¶æ€å¤±è´¥:', error);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }

            // æ˜¾ç¤ºä¸Šä¼ æ¢å¤å¯¹è¯æ¡†ï¼ˆç®€åŒ–ç‰ˆï¼‰
            function showUploadRestorationDialog(savedFiles) {
                const uncompletedFiles = savedFiles.filter(file => file.status !== 'completed');
                if (uncompletedFiles.length === 0) {
                    localStorage.removeItem(STORAGE_KEY);
                    return;
                }

                console.log(`è‡ªåŠ¨æ¢å¤ ${uncompletedFiles.length} ä¸ªæœªå®Œæˆçš„ä¸Šä¼ `);
                
                // è‡ªåŠ¨æ¢å¤ï¼Œä¸å†è¯¢é—®ç”¨æˆ·
                restoreUncompletedUploads(savedFiles);
                
                // æ˜¾ç¤ºæ›´æ¸…æ™°çš„æç¤ºä¿¡æ¯
                const fileList = uncompletedFiles.map(f => `â€¢ ${f.name} (${(f.size/1024/1024).toFixed(2)}MB)`).join('\n');
                showAlertOnMainPage(
                    `ğŸ”„ æ£€æµ‹åˆ° ${uncompletedFiles.length} ä¸ªæœªå®Œæˆçš„ä¸Šä¼ ï¼š\n${fileList}\n\nğŸ‘† è¯·ç‚¹å‡»æ–‡ä»¶æ—çš„ "é€‰æ‹©æ–‡ä»¶ç»§ç»­ä¸Šä¼ " æŒ‰é’®æ¥æ¢å¤æ–­ç‚¹ç»­ä¼ `, 
                    'warning', 
                    15000
                );
            }

            // æ¢å¤æœªå®Œæˆçš„ä¸Šä¼ 
            async function restoreUncompletedUploads(savedFiles) {
                for (const savedFile of savedFiles) {
                    if (savedFile.status === 'completed') {
                        // ç›´æ¥æ¢å¤å·²å®Œæˆçš„æ–‡ä»¶
                        const fileEntry = {
                            id: savedFile.id,
                            file: {
                                name: savedFile.name,
                                size: savedFile.size,
                                type: savedFile.type,
                                lastModified: savedFile.lastModified
                            },
                            status: savedFile.status,
                            progress: savedFile.progress,
                            uploadId: savedFile.uploadId,
                            serverFileName: savedFile.serverFileName
                        };
                        uploadedFilesData.push(fileEntry);
                        addFileToUI(fileEntry);
                        updateFileStatusUI(fileEntry.id, 'completed');
                    } else {
                        // ä¸ºæœªå®Œæˆçš„æ–‡ä»¶åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¯¹è±¡
                        const virtualFile = createVirtualFile(savedFile);
                        if (virtualFile) {
                            const fileEntry = {
                                id: savedFile.id,
                                file: virtualFile,
                                status: 'paused', // è®¾ç½®ä¸ºæš‚åœçŠ¶æ€
                                progress: savedFile.progress,
                                uploadId: savedFile.uploadId,
                                serverFileName: savedFile.serverFileName
                            };
                            uploadedFilesData.push(fileEntry);
                            addFileToUI(fileEntry);
                            updateFileStatusUI(fileEntry.id, 'need_file', 'éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶ç»§ç»­æ–­ç‚¹ç»­ä¼ ');
                        }
                    }
                }
                
                const uncompletedCount = savedFiles.filter(f => f.status !== 'completed').length;
                if (uncompletedCount > 0) {
                    showAlertOnMainPage(`å·²æ¢å¤ ${savedFiles.length} ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­ ${uncompletedCount} ä¸ªéœ€è¦ç»§ç»­ä¸Šä¼ ã€‚ç‚¹å‡»"é‡è¯•"æŒ‰é’®ç»§ç»­ã€‚`, 'info', 8000);
                }
                
                saveUploadState(); // æ›´æ–°çŠ¶æ€
            }

            // åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼ˆç”¨äºæ¢å¤ï¼‰
            function createVirtualFile(savedFile) {
                try {
                    // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„Fileå¯¹è±¡ç”¨äºæ˜¾ç¤º
                    const blob = new Blob([''], { type: savedFile.type });
                    const file = new File([blob], savedFile.name, {
                        type: savedFile.type,
                        lastModified: savedFile.lastModified
                    });
                    
                    // ç”±äºæ— æ³•æ¢å¤å®é™…æ–‡ä»¶å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é‡è¯•æ—¶æç¤ºç”¨æˆ·é‡æ–°é€‰æ‹©æ–‡ä»¶
                    Object.defineProperty(file, 'size', {
                        value: savedFile.size,
                        writable: false
                    });
                    
                    return file;
                } catch (error) {
                    console.error('åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¤±è´¥:', error);
                    return null;
                }
            }

            // æ¸…é™¤è¿‡æœŸçš„ä¸Šä¼ çŠ¶æ€
            function clearExpiredUploads() {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    try {
                        const uploadState = JSON.parse(savedState);
                        const now = Date.now();
                        const expiryTime = STORAGE_EXPIRY_HOURS * 60 * 60 * 1000;
                        
                        if (now - uploadState.timestamp > expiryTime) {
                            localStorage.removeItem(STORAGE_KEY);
                            console.log('å·²æ¸…é™¤è¿‡æœŸçš„ä¸Šä¼ çŠ¶æ€');
                        }
                    } catch (error) {
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            }

            async function processFileUploadQueue() {
                if (isUploading) return;
                isUploading = true;

                while (fileUploadQueue.length > 0) {
                    const fileEntry = fileUploadQueue.shift();
                    if (fileEntry.status === 'pending') {
                        await uploadFile(fileEntry);
                    }
                }
                isUploading = false;
            }

            // æ–­ç‚¹ç»­ä¼ æ ¸å¿ƒå‡½æ•°
            async function uploadFileWithResume(fileEntry, uploadId) {
                const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
                const totalChunks = Math.ceil(fileEntry.file.size / CHUNK_SIZE);
                
                console.log(`DEBUG: å¼€å§‹æ–­ç‚¹ç»­ä¼  - æ–‡ä»¶: ${fileEntry.file.name}, æ€»å¤§å°: ${fileEntry.file.size} bytes, æ€»åˆ†å—: ${totalChunks}`);
                
                // æ£€æŸ¥æ–‡ä»¶å¯¹è±¡æ˜¯å¦ä¸ºè™šæ‹Ÿæ–‡ä»¶ï¼ˆä»localStorageæ¢å¤çš„ï¼‰
                if (typeof fileEntry.file.stream === 'undefined' || typeof fileEntry.file.slice !== 'function') {
                    console.warn('æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œæ— æ³•è¿›è¡Œåˆ‡ç‰‡æ“ä½œ');
                    throw new Error('NEED_REAL_FILE'); // ç‰¹æ®Šé”™è¯¯ç ï¼Œè¡¨ç¤ºéœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶
                }
                
                // æµ‹è¯•æ–‡ä»¶åˆ‡ç‰‡åŠŸèƒ½
                try {
                    const testChunk = fileEntry.file.slice(0, Math.min(1024, fileEntry.file.size));
                    if (testChunk.size === 0 && fileEntry.file.size > 0) {
                        console.warn('æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å¤±è´¥ï¼Œæ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                        throw new Error('NEED_REAL_FILE');
                    }
                    console.log(`æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•æˆåŠŸï¼Œæµ‹è¯•åˆ†å—å¤§å°: ${testChunk.size} bytes`);
                } catch (sliceError) {
                    console.warn('æ–‡ä»¶åˆ‡ç‰‡æµ‹è¯•å‡ºé”™:', sliceError);
                    throw new Error('NEED_REAL_FILE');
                }
                
                // 1. æŸ¥è¯¢æœåŠ¡å™¨å·²ä¸Šä¼ çŠ¶æ€
                let uploadedChunks = new Set();
                let serverTotalChunks = 0;
                let serverFileSize = 0;
                
                try {
                    const statusResponse = await fetch(`/api/attachments/status/${uploadId}`);
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        uploadedChunks = new Set(status.uploadedChunks || []);
                        serverTotalChunks = status.totalChunks || 0;
                        serverFileSize = status.totalSize || 0;
                        
                        console.log(`æœåŠ¡å™¨çŠ¶æ€: æ–‡ä»¶å¤§å°=${serverFileSize}, æ€»åˆ†å—=${serverTotalChunks}, å·²ä¸Šä¼ =${uploadedChunks.size}ä¸ªåˆ†å—`);
                        console.log(`å½“å‰æ–‡ä»¶: æ–‡ä»¶å¤§å°=${fileEntry.file.size}, è®¡ç®—åˆ†å—=${totalChunks}`);
                        
                        // éªŒè¯æ–‡ä»¶ä¸€è‡´æ€§
                        if (serverFileSize !== fileEntry.file.size) {
                            console.error(`æ–‡ä»¶å¤§å°ä¸ä¸€è‡´! æœåŠ¡å™¨: ${serverFileSize}, å½“å‰: ${fileEntry.file.size}`);
                            throw new Error(`æ–‡ä»¶ä¸ä¸€è‡´ï¼šæœåŠ¡å™¨è®°å½•å¤§å° ${serverFileSize} bytesï¼Œå½“å‰æ–‡ä»¶å¤§å° ${fileEntry.file.size} bytes`);
                        }
                        
                        // éªŒè¯åˆ†å—æ•°ä¸€è‡´æ€§ï¼ˆ0è¡¨ç¤ºæ–°ä¸Šä¼ ä¼šè¯ï¼Œæ˜¯æ­£å¸¸çš„ï¼‰
                        if (serverTotalChunks > 0 && serverTotalChunks !== totalChunks) {
                            console.error(`åˆ†å—æ•°ä¸ä¸€è‡´! æœåŠ¡å™¨: ${serverTotalChunks}, å½“å‰: ${totalChunks}`);
                            throw new Error(`åˆ†å—æ•°ä¸ä¸€è‡´ï¼šæœåŠ¡å™¨è®°å½• ${serverTotalChunks} å—ï¼Œå½“å‰è®¡ç®— ${totalChunks} å—`);
                        } else if (serverTotalChunks === 0) {
                            console.log(`æ–°ä¸Šä¼ ä¼šè¯ï¼ŒæœåŠ¡å™¨totalChunksä¸º0æ˜¯æ­£å¸¸çš„`);
                        }
                        
                        console.log(`æ–‡ä»¶ "${fileEntry.file.name}" æ–­ç‚¹ç»­ä¼ : å·²ä¸Šä¼  ${uploadedChunks.size}/${totalChunks} åˆ†å—`);
                        
                        // æ›´æ–°UIæ˜¾ç¤ºå·²æœ‰è¿›åº¦
                        if (uploadedChunks.size > 0) {
                            const existingProgress = Math.round((uploadedChunks.size / totalChunks) * 90);
                            fileEntry.progress = existingProgress;
                            updateFileProgress(fileEntry.id, existingProgress);
                            updateFileStatusUI(fileEntry.id, 'uploading', `ç»§ç»­ä¸Šä¼  (${uploadedChunks.size}/${totalChunks} å·²å®Œæˆ)`);
                        }
                    }
                } catch (error) {
                    console.warn(`æŸ¥è¯¢ä¸Šä¼ çŠ¶æ€å¤±è´¥ï¼Œå°†ä»å¤´å¼€å§‹: ${error.message}`);
                    if (error.message.includes('ä¸ä¸€è‡´')) {
                        // æ–‡ä»¶ä¸ä¸€è‡´ï¼Œæä¾›é‡æ–°å¼€å§‹é€‰é¡¹
                        const restart = confirm(`æ£€æµ‹åˆ°æ–‡ä»¶ä¸æœåŠ¡å™¨è®°å½•ä¸ä¸€è‡´ï¼š\n${error.message}\n\næ˜¯å¦æ¸…ç†æœåŠ¡å™¨çŠ¶æ€å¹¶é‡æ–°å¼€å§‹ä¸Šä¼ ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"é‡æ–°å¼€å§‹ï¼Œç‚¹å‡»"å–æ¶ˆ"åœæ­¢ä¸Šä¼ ã€‚`);
                        if (restart) {
                            console.log('ç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹ä¸Šä¼ ï¼Œæ¸…ç†æœåŠ¡å™¨çŠ¶æ€...');
                            try {
                                // å°è¯•æ¸…ç†æœåŠ¡å™¨çŠ¶æ€ï¼ˆåˆ é™¤uploadIdè®°å½•ï¼‰
                                const cleanupResponse = await fetch(`/api/attachments/cleanup/${uploadId}`, { method: 'DELETE' });
                                if (cleanupResponse.ok) {
                                    console.log('æœåŠ¡å™¨çŠ¶æ€å·²æˆåŠŸæ¸…ç†');
                                } else {
                                    console.warn('æ¸…ç†æœåŠ¡å™¨çŠ¶æ€å¤±è´¥ï¼Œä½†å°†ç»§ç»­é‡æ–°å¼€å§‹ä¸Šä¼ ');
                                }
                            } catch (cleanupError) {
                                console.warn('æ¸…ç†æœåŠ¡å™¨çŠ¶æ€æ—¶å‡ºé”™ï¼Œä½†å°†ç»§ç»­é‡æ–°å¼€å§‹ä¸Šä¼ :', cleanupError);
                            }
                            
                            // æ— è®ºæ¸…ç†æ˜¯å¦æˆåŠŸï¼Œéƒ½æ¸…ç†æœ¬åœ°çŠ¶æ€å¹¶é‡æ–°å¼€å§‹
                            console.log('æ¸…ç†æœ¬åœ°çŠ¶æ€ï¼Œå‡†å¤‡é‡æ–°å¼€å§‹ä¸Šä¼ ');
                            fileEntry.uploadId = null;
                            saveUploadState();
                            throw new Error('RESTART_UPLOAD'); // ç‰¹æ®Šé”™è¯¯ç ï¼Œè¡¨ç¤ºéœ€è¦é‡æ–°å¼€å§‹
                        } else {
                            throw new Error('ç”¨æˆ·å–æ¶ˆä¸Šä¼ ');
                        }
                    }
                }
                
                // 2. åªä¸Šä¼ ç¼ºå¤±çš„åˆ†å—
                for (let chunkNumber = 0; chunkNumber < totalChunks; chunkNumber++) {
                    if (uploadedChunks.has(chunkNumber)) {
                        console.log(`è·³è¿‡å·²ä¸Šä¼ çš„åˆ†å—: ${chunkNumber + 1}/${totalChunks}`);
                        continue; // è·³è¿‡å·²ä¸Šä¼ çš„åˆ†å—
                    }
                    
                    // è®¡ç®—å½“å‰åˆ†å—çš„å¤§å°è¿›è¡ŒéªŒè¯
                    const start = chunkNumber * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, fileEntry.file.size);
                    const expectedChunkSize = end - start;
                    
                    console.log(`DEBUG: å‡†å¤‡ä¸Šä¼ åˆ†å— ${chunkNumber + 1}/${totalChunks}, é¢„æœŸå¤§å°: ${expectedChunkSize} bytes (${start}-${end})`);
                    
                    if (expectedChunkSize <= 0) {
                        console.error(`åˆ†å— ${chunkNumber + 1} è®¡ç®—å‡ºé”™è¯¯çš„å¤§å°: ${expectedChunkSize}`);
                        throw new Error(`åˆ†å— ${chunkNumber + 1} å¤§å°è®¡ç®—é”™è¯¯: ${expectedChunkSize} bytes`);
                    }
                    
                    const success = await uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, CHUNK_SIZE);
                    if (!success) {
                        throw new Error(`åˆ†å— ${chunkNumber + 1} å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥`);
                    }
                    
                    // æ›´æ–°è¿›åº¦å’Œåˆ†å—ä¿¡æ¯
                    const uploadedCount = chunkNumber + 1;
                    const progress = Math.round((uploadedCount / totalChunks) * 90);
                    fileEntry.progress = progress;
                    const chunkInfo = `åˆ†å— ${uploadedCount}/${totalChunks} å·²ä¸Šä¼ `;
                    updateFileProgress(fileEntry.id, progress, chunkInfo);
                    
                    // æ¯5ä¸ªåˆ†å—ä¿å­˜ä¸€æ¬¡çŠ¶æ€ï¼ˆå‡å°‘å­˜å‚¨é¢‘ç‡ï¼‰
                    if (uploadedCount % 5 === 0 || uploadedCount === totalChunks) {
                        saveUploadState();
                    }
                }
            }

            // æ”¯æŒé‡è¯•çš„åˆ†å—ä¸Šä¼ å‡½æ•°
            async function uploadChunkWithRetry(fileEntry, uploadId, chunkNumber, totalChunks, chunkSize, maxRetries = 3) {
                const start = chunkNumber * chunkSize;
                const end = Math.min(start + chunkSize, fileEntry.file.size);
                const chunk = fileEntry.file.slice(start, end);

                // éªŒè¯åˆ†å—å¤§å°
                if (chunk.size === 0) {
                    console.error(`åˆ†å— ${chunkNumber + 1} åˆ‡ç‰‡ç»“æœä¸ºç©º! start=${start}, end=${end}, fileSize=${fileEntry.file.size}`);
                    throw new Error(`åˆ†å— ${chunkNumber + 1} åˆ‡ç‰‡å¤±è´¥ï¼šç»“æœä¸ºç©º`);
                }

                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    try {
                        const chunkFormData = new FormData();
                        chunkFormData.append('file', chunk);
                        chunkFormData.append('chunkNumber', chunkNumber);
                        chunkFormData.append('totalChunks', totalChunks);

                        console.log(`DEBUG: å®é™…ä¸Šä¼ åˆ†å— ${chunkNumber + 1}/${totalChunks}, å¤§å°: ${chunk.size} bytes, èŒƒå›´: ${start}-${end}, uploadId: ${uploadId}`);

                        const chunkResponse = await fetch('/api/attachments/upload-chunk', {
                            method: 'POST',
                            headers: {
                                'X-Upload-Id': uploadId
                            },
                            body: chunkFormData
                        });

                        if (chunkResponse.ok) {
                            console.log(`åˆ†å— ${chunkNumber + 1}/${totalChunks} ä¸Šä¼ æˆåŠŸ ${attempt > 0 ? `(é‡è¯• ${attempt} æ¬¡å)` : ''}`);
                            return true; // æˆåŠŸ
                        } else {
                            // è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                            let errorDetails = `HTTP ${chunkResponse.status}: ${chunkResponse.statusText}`;
                            try {
                                const errorText = await chunkResponse.text();
                                if (errorText) {
                                    errorDetails += ` - ${errorText}`;
                                }
                            } catch (e) {
                                console.warn('æ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯:', e);
                            }
                            throw new Error(errorDetails);
                        }
                    } catch (error) {
                        console.warn(`åˆ†å— ${chunkNumber + 1} ä¸Šä¼ å¤±è´¥ (å°è¯• ${attempt + 1}/${maxRetries}): ${error.message}`);
                        
                        if (attempt === maxRetries - 1) {
                            // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
                            updateFileStatusUI(fileEntry.id, 'error', `åˆ†å— ${chunkNumber + 1} é‡è¯• ${maxRetries} æ¬¡åå¤±è´¥`);
                            return false;
                        }
                        
                        // æŒ‡æ•°é€€é¿ç­–ç•¥
                        const delay = Math.min(1000 * Math.pow(2, attempt), 10000); // æœ€å¤§10ç§’
                        console.log(`${delay}ms åé‡è¯•åˆ†å— ${chunkNumber + 1}...`);
                        updateFileStatusUI(fileEntry.id, 'uploading', `åˆ†å— ${chunkNumber + 1} é‡è¯•ä¸­... (${attempt + 1}/${maxRetries})`);
                        await sleep(delay);
                    }
                }
                return false;
            }

            // å·¥å…·å‡½æ•°ï¼šå»¶æ—¶
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async function uploadFile(fileEntry) {
                fileEntry.status = 'uploading';
                updateFileStatusUI(fileEntry.id, 'uploading');

                try {
                    // 1. åˆå§‹åŒ–ä¸Šä¼ 
                    const initResponse = await fetch('/api/attachments/initiate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fileName: fileEntry.file.name,
                            totalSize: fileEntry.file.size
                        })
                    });

                    if (!initResponse.ok) {
                        throw new Error('åˆå§‹åŒ–ä¸Šä¼ å¤±è´¥');
                    }

                    const initResult = await initResponse.json();
                    const uploadId = initResult.uploadId;
                    const serverFileName = initResult.serverFileName;
                    
                    // ä¿å­˜ä¸Šä¼ IDä¾›æ–­ç‚¹ç»­ä¼ ä½¿ç”¨
                    fileEntry.uploadId = uploadId;
                    fileEntry.serverFileName = serverFileName;
                    saveUploadState(); // ä¿å­˜çŠ¶æ€

                    // 2. æ™ºèƒ½åˆ†å—ä¸Šä¼  (æ”¯æŒæ–­ç‚¹ç»­ä¼ )
                    await uploadFileWithResume(fileEntry, uploadId);

                    // 3. å®Œæˆä¸Šä¼ 
                    const finalizeResponse = await fetch(`/api/attachments/finalize/${uploadId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `originalFileName=${encodeURIComponent(fileEntry.file.name)}`
                    });

                    if (!finalizeResponse.ok) {
                        throw new Error('å®Œæˆä¸Šä¼ å¤±è´¥');
                    }

                    const finalizeResult = await finalizeResponse.json();
                    
                    fileEntry.status = 'completed';
                    fileEntry.progress = 100;
                    fileEntry.serverFileName = finalizeResult.fileName;
                    updateFileProgress(fileEntry.id, 100);
                    updateFileStatusUI(fileEntry.id, 'completed');
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlertOnMainPage(`æ–‡ä»¶ "${fileEntry.file.name}" ä¸Šä¼ æˆåŠŸã€‚`, 'success', 3000);
                } catch (error) {
                    if (error.message === 'NEED_REAL_FILE') {
                        // éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶
                        console.log('ä¸Šä¼ è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°è™šæ‹Ÿæ–‡ä»¶å¯¹è±¡ï¼Œéœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶');
                        fileEntry.status = 'pending';
                        updateFileStatusUI(fileEntry.id, 'pending', 'éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶');
                        saveUploadState();
                        
                        const confirmed = confirm(`æ–‡ä»¶ "${fileEntry.file.name}" éœ€è¦é‡æ–°é€‰æ‹©æ‰èƒ½ç»§ç»­ä¸Šä¼ ã€‚\n\nç‚¹å‡»ç¡®å®šæ¥é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–å–æ¶ˆåˆ é™¤æ­¤é¡¹ã€‚`);
                        if (confirmed) {
                            showFileSelectionDialog(fileEntry);
                        } else {
                            removeFile(fileEntry.id);
                        }
                        return;
                    }
                    
                    console.error('æ–‡ä»¶ä¸Šä¼ é”™è¯¯:', error);
                    fileEntry.status = 'error';
                    fileEntry.progress = 0;
                    updateFileProgress(fileEntry.id, 0);
                    updateFileStatusUI(fileEntry.id, 'error', error.message);
                    saveUploadState(); // ä¿å­˜çŠ¶æ€
                    showAlertOnMainPage(`æ–‡ä»¶ "${fileEntry.file.name}" ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
                }
            }

            function prepareAttachmentsForSubmission() {
                if (hiddenAttachmentInputsContainer) {
                    hiddenAttachmentInputsContainer.innerHTML = '';
                    const completedFiles = uploadedFilesData.filter(fileEntry => 
                        fileEntry.status === 'completed' && fileEntry.serverFileName
                    );
                    
                    console.log(`å‡†å¤‡é™„ä»¶æäº¤: å‘ç° ${completedFiles.length} ä¸ªå·²å®Œæˆçš„æ–‡ä»¶`, completedFiles);
                    
                    completedFiles.forEach(fileEntry => {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'attachmentServerFileNames';
                        hiddenInput.value = fileEntry.serverFileName;
                        hiddenAttachmentInputsContainer.appendChild(hiddenInput);
                        console.log(`æ·»åŠ é™„ä»¶åˆ°è¡¨å•: ${fileEntry.serverFileName}`);
                    });
                    
                    console.log(`é™„ä»¶å®¹å™¨å†…å®¹:`, hiddenAttachmentInputsContainer.innerHTML);
                } else {
                    console.error('æœªæ‰¾åˆ°éšè—é™„ä»¶è¾“å…¥å®¹å™¨');
                }
            }

            // --- å¼€å§‹ï¼šç”µå­ç­¾åé€»è¾‘ ---
            // ç”²æ–¹
            const signatureCanvasPartyA = document.getElementById('signatureCanvasPartyA');
            const signatureCtxPartyA = signatureCanvasPartyA.getContext('2d');
            const clearSignatureBtnPartyA = document.getElementById('clearSignatureBtnPartyA');
            const uploadSignatureInputPartyA = document.getElementById('uploadSignatureInputPartyA');
            const signaturePreviewPartyA = document.getElementById('signaturePreviewPartyA');
            const signatureDataInputPartyA = document.getElementById('signatureDataPartyA');

            // ä¹™æ–¹
            const signatureCanvasPartyB = document.getElementById('signatureCanvasPartyB');
            const signatureCtxPartyB = signatureCanvasPartyB.getContext('2d');
            const clearSignatureBtnPartyB = document.getElementById('clearSignatureBtnPartyB');
            const uploadSignatureInputPartyB = document.getElementById('uploadSignatureInputPartyB');
            const signaturePreviewPartyB = document.getElementById('signaturePreviewPartyB');
            const signatureDataInputPartyB = document.getElementById('signatureDataPartyB');


            // ç»Ÿä¸€åˆå§‹åŒ–ç”»å¸ƒ
            function initSignatureCanvas(canvas, ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
            }
            initSignatureCanvas(signatureCanvasPartyA, signatureCtxPartyA);
            initSignatureCanvas(signatureCanvasPartyB, signatureCtxPartyB);

            // ç»˜åˆ¶å‡½æ•°å·¥å‚
            function createDrawHandler(canvas, ctx, previewImg) {
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                canvas.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                    if (previewImg) previewImg.style.display = 'none';
                });

                canvas.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                });

                canvas.addEventListener('mouseup', () => isDrawing = false);
                canvas.addEventListener('mouseout', () => isDrawing = false);
            }

            // ä¸ºç”²æ–¹å’Œä¹™æ–¹ç­¾åæ¿åˆ›å»ºç»˜åˆ¶å¤„ç†å‡½æ•°
            createDrawHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA);
            createDrawHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB);


            // æ¸…ç©ºç­¾åå‡½æ•°å·¥å‚
            function createClearSignatureHandler(canvas, ctx, previewImg, dataInput) {
                return () => {
                    initSignatureCanvas(canvas, ctx);
                    if (previewImg) {
                        previewImg.src = '';
                        previewImg.style.display = 'none';
                    }
                    dataInput.value = '';
                };
            }
            if (clearSignatureBtnPartyA) clearSignatureBtnPartyA.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
            if (clearSignatureBtnPartyB) clearSignatureBtnPartyB.addEventListener('click', createClearSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));

            // ä¸Šä¼ ç­¾åå›¾ç‰‡å‡½æ•°å·¥å‚
            function createUploadSignatureHandler(canvas, ctx, previewImg, dataInput) {
                return (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                initSignatureCanvas(canvas, ctx);
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                if (previewImg) {
                                    previewImg.src = e.target.result;
                                    previewImg.style.display = 'block';
                                }
                                dataInput.value = canvas.toDataURL('image/png');
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }
            if (uploadSignatureInputPartyA) uploadSignatureInputPartyA.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyA, signatureCtxPartyA, signaturePreviewPartyA, signatureDataInputPartyA));
            if (uploadSignatureInputPartyB) uploadSignatureInputPartyB.addEventListener('change', createUploadSignatureHandler(signatureCanvasPartyB, signatureCtxPartyB, signaturePreviewPartyB, signatureDataInputPartyB));


            // å‡†å¤‡ç­¾åæ•°æ®ä»¥ä¾›æäº¤ (é€šç”¨åŒ–)
            function prepareSignatureForSubmission(party) {
                const canvas = document.getElementById(`signatureCanvas${party}`);
                const ctx = canvas.getContext('2d');
                const preview = document.getElementById(`signaturePreview${party}`);
                const dataInput = document.getElementById(`signatureData${party}`);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                let hasDrawn = false;
                for (let i = 0; i < imageData.length; i += 4) {
                    if (imageData[i + 3] !== 0 && (imageData[i] !== 255 || imageData[i+1] !== 255 || imageData[i+2] !== 255)) {
                        hasDrawn = true;
                        break;
                    }
                }

                if (hasDrawn) {
                    dataInput.value = canvas.toDataURL('image/png');
                } else if (preview.src && preview.style.display !== 'none') {
                    dataInput.value = preview.src;
                } else {
                    dataInput.value = '';
                }
            }
            // --- ç”µå­ç­¾åé€»è¾‘ç»“æŸ ---


            // --- å¼€å§‹ï¼šæ¨¡æ¿é€‰æ‹©å’Œç›´æ¥ç¼–è¾‘å ä½ç¬¦é€»è¾‘ ---
            // originalTemplateContent å˜é‡ç”¨äºå­˜å‚¨ä»åç«¯è·å–çš„åŸå§‹æ¨¡æ¿å†…å®¹
            let originalTemplateContent = '';

            // extractAndPreparePlaceholderValues å‡½æ•°ç”¨äºä» TinyMCE å†…å®¹ä¸­æå–å ä½ç¬¦å€¼
            function extractAndPreparePlaceholderValues() {
                if (!contractEditor) return;

                const editorContent = contractEditor.getContent(); // è·å– TinyMCE å½“å‰çš„ HTML å†…å®¹
                const placeholderValues = {};

                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ DOM å…ƒç´ æ¥è§£æç¼–è¾‘å™¨å†…å®¹ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ span
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = editorContent;

                // æŸ¥æ‰¾æ‰€æœ‰å…·æœ‰ .contract-placeholder ç±»å’Œ data-placeholder-key å±æ€§çš„å¯ç¼–è¾‘ span
                const placeholderSpans = tempDiv.querySelectorAll('.contract-placeholder[data-placeholder-key][contenteditable="true"]');

                placeholderSpans.forEach(span => {
                    const key = span.dataset.placeholderKey;
                    const value = span.textContent || ''; // è·å–ç”¨æˆ·å®é™…å¡«å†™çš„å€¼

                    if (key) {
                        placeholderValues[key] = value;
                    }
                });

                // å°†å ä½ç¬¦å€¼æ‰“åŒ…åˆ°éšè—å­—æ®µä¸­
                document.getElementById('placeholderValuesJson').value = JSON.stringify(placeholderValues);
            }

            // escapeRegExp å‡½æ•°ç”¨äºè½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // templateSelect çš„ change äº‹ä»¶ç›‘å¬å™¨
            const templateSelect = document.getElementById('templateSelect');
            // æ³¨æ„ï¼štemplateSelect.dispatchEvent(new Event('change')); å·²è¢«ç§»è‡³ tinymce.init çš„ 'init' äº‹ä»¶ä¸­

            if (templateSelect) {
                templateSelect.addEventListener('change', async function() {
                    const templateId = this.value;

                    // æ¸…é™¤ç¼–è¾‘å™¨å†…å®¹å’ŒåŸå§‹æ¨¡æ¿å†…å®¹
                    if (contractEditor) {
                        contractEditor.setContent('');
                    }
                    originalTemplateContent = '';

                    if (!templateId) {
                        return; // é€‰æ‹©äº† "-- ä¸ä½¿ç”¨æ¨¡æ¿ --"
                    }

                    try {
                        const response = await fetch(`/contract-manager/api/templates/${templateId}`);
                        if (!response.ok) {
                            throw new Error(`æ— æ³•è·å–æ¨¡æ¿è¯¦æƒ… (çŠ¶æ€: ${response.status})`);
                        }
                        const template = await response.json();

                        originalTemplateContent = template.templateContent || '';
                        if (!originalTemplateContent) {
                            console.warn("DEBUG: è·å–åˆ°çš„æ¨¡æ¿å†…å®¹ä¸ºç©ºã€‚");
                            showAlertOnMainPage('é€‰æ‹©çš„æ¨¡æ¿å†…å®¹ä¸ºç©ºï¼Œè¯·æ£€æŸ¥æ¨¡æ¿é…ç½®ã€‚', 'warning');
                            return;
                        }

                        const placeholderRegex = /\{\{([a-zA-Z0-9_\u4e00-\u9fa5]+?)\}\}/g;

                        let contentToDisplayInEditor = originalTemplateContent.replace(placeholderRegex, (match, placeholderName) => {
                            // åœ¨ span å†…éƒ¨ç›´æ¥æ”¾ç½®å ä½ç¬¦åç§°ï¼Œä½œä¸ºé»˜è®¤å†…å®¹
                            return `<span class="contract-placeholder" data-placeholder-key="${placeholderName}" contenteditable="true">___________</span>`; // 11ä¸ªä¸‹åˆ’çº¿ä½œä¸ºç¤ºä¾‹
                        });

                        if (contractEditor) {
                            contractEditor.setContent(contentToDisplayInEditor);
                            contractEditor.save();
                            // ç§»é™¤ mceRepaintï¼Œå› ä¸ºå…¶å¯èƒ½å¯¼è‡´ getRng é”™è¯¯
                        }

                    } catch (error) {
                        console.error("è·å–æ¨¡æ¿è¯¦æƒ…å¤±è´¥:", error);
                        showAlertOnMainPage('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message, 'danger');
                    }
                });
            }
            // --- æ¨¡æ¿é€‰æ‹©å’Œç›´æ¥ç¼–è¾‘å ä½ç¬¦é€»è¾‘ç»“æŸ ---

            // --- å®Œæ•´é¢„è§ˆåŠŸèƒ½å®ç° ---
            function handlePreviewFile(serverFileName) {
                if (!serverFileName) return;
                
                const downloadUrl = `/api/attachments/download/${encodeURIComponent(serverFileName)}`;
                const fileExtension = serverFileName.toLowerCase().split('.').pop();
                
                // å®šä¹‰å„ç§æ–‡ä»¶ç±»å‹çš„é¢„è§ˆæ”¯æŒ
                const previewableInBrowser = {
                    images: ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'],
                    pdf: ['pdf'],
                    text: ['txt', 'csv', 'log', 'md', 'json', 'xml', 'html', 'css', 'js'],
                    audio: ['mp3', 'wav', 'ogg', 'aac', 'm4a'],
                    video: ['mp4', 'webm', 'ogg', 'mov']
                };
                
                const downloadOnly = {
                    office: ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'],
                    archives: ['zip', 'rar', '7z', 'tar', 'gz'],
                    others: ['exe', 'msi', 'dmg', 'deb', 'rpm']
                };
                
                let canPreview = false;
                let fileCategory = '';
                
                for (const [category, extensions] of Object.entries(previewableInBrowser)) {
                    if (extensions.includes(fileExtension)) {
                        canPreview = true;
                        fileCategory = category;
                        break;
                    }
                }
                
                if (canPreview) {
                    if (fileCategory === 'images') {
                        openImagePreview(downloadUrl, serverFileName);
                    } else if (fileCategory === 'pdf') {
                        const userChoice = confirm(
                            `PDFæ–‡ä»¶ "${serverFileName}" é¢„è§ˆé€‰é¡¹ï¼š\n\n` +
                            `ç‚¹å‡»"ç¡®å®š"åœ¨æ–°çª—å£é¢„è§ˆPDF\n` +
                            `ç‚¹å‡»"å–æ¶ˆ"ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹`
                        );
                        if (userChoice) {
                            window.open(downloadUrl, '_blank');
                        } else {
                            downloadFileUtil(downloadUrl, serverFileName);
                        }
                    } else if (fileCategory === 'text') {
                        window.open(downloadUrl, '_blank');
                    } else if (fileCategory === 'audio' || fileCategory === 'video') {
                        openMediaPreview(downloadUrl, serverFileName, fileCategory);
                    }
                } else {
                    let downloadReason = '';
                    if (downloadOnly.office.includes(fileExtension)) {
                        downloadReason = 'Officeæ–‡æ¡£éœ€è¦ä½¿ç”¨ç›¸åº”çš„åŠå…¬è½¯ä»¶æ‰“å¼€';
                    } else if (downloadOnly.archives.includes(fileExtension)) {
                        downloadReason = 'å‹ç¼©åŒ…æ–‡ä»¶éœ€è¦è§£å‹ç¼©è½¯ä»¶æ‰“å¼€';
                    } else {
                        downloadReason = 'æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒåœ¨æµè§ˆå™¨ä¸­ç›´æ¥é¢„è§ˆ';
                    }
                    
                    const userConfirmed = confirm(
                        `æ–‡ä»¶ "${serverFileName}" ${downloadReason}ã€‚\n\nç‚¹å‡»"ç¡®å®š"ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°æŸ¥çœ‹ï¼Œç‚¹å‡»"å–æ¶ˆ"å…³é—­æ­¤å¯¹è¯æ¡†ã€‚`
                    );
                    if (userConfirmed) {
                        downloadFileUtil(downloadUrl, serverFileName);
                    }
                }
            }
            
            function openImagePreview(imageUrl, fileName) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">å›¾ç‰‡é¢„è§ˆ: ${fileName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="preview-loading" id="imageLoading">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    æ­£åœ¨åŠ è½½å›¾ç‰‡...
                                </div>
                                <img src="${imageUrl}" class="img-fluid" style="max-height: 70vh; display: none;" alt="${fileName}" 
                                     onload="this.style.display='block'; document.getElementById('imageLoading').style.display='none';"
                                     onerror="this.onerror=null; this.style.display='none'; document.getElementById('imageLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="alert alert-warning mt-3" style="display: none;">
                                    <i class="bi bi-exclamation-triangle"></i> å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½åæŸ¥çœ‹
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">å¿«æ·é”®: ESC-å…³é—­, D-ä¸‹è½½</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFileUtil('${imageUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFileUtil(imageUrl, fileName);
                    }
                });
            }
            
            function openMediaPreview(mediaUrl, fileName, mediaType) {
                const isVideo = mediaType === 'video';
                const mediaTag = isVideo ? 'video' : 'audio';
                const mediaControls = isVideo ? 'controls width="100%" height="400"' : 'controls width="100%"';
                
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-${isVideo ? 'camera-video' : 'music-note'}"></i> 
                                    ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}é¢„è§ˆ: ${fileName}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="preview-loading" id="mediaLoading">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    æ­£åœ¨åŠ è½½${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}...
                                </div>
                                <${mediaTag} ${mediaControls} preload="metadata" style="display: none;"
                                        onloadedmetadata="this.style.display='block'; document.getElementById('mediaLoading').style.display='none';"
                                        onerror="this.onerror=null; this.style.display='none'; document.getElementById('mediaLoading').style.display='none'; this.nextElementSibling.style.display='block';">
                                    <source src="${mediaUrl}" type="${mediaType}/${fileName.split('.').pop()}">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}æ’­æ”¾ã€‚
                                </${mediaTag}>
                                <div class="alert alert-warning mt-3" style="display: none;">
                                    <i class="bi bi-exclamation-triangle"></i> ${isVideo ? 'è§†é¢‘' : 'éŸ³é¢‘'}åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½åæŸ¥çœ‹
                                </div>
                            </div>
                            <div class="modal-footer">
                                <small class="text-muted me-auto">å¿«æ·é”®: ESC-å…³é—­, D-ä¸‹è½½, ç©ºæ ¼-æ’­æ”¾/æš‚åœ</small>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-primary" onclick="downloadFileUtil('${mediaUrl}', '${fileName}')">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                modal.addEventListener('hidden.bs.modal', () => {
                    document.body.removeChild(modal);
                });
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        bootstrapModal.hide();
                    } else if (e.key === 'd' || e.key === 'D') {
                        downloadFileUtil(mediaUrl, fileName);
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        const mediaElement = modal.querySelector('video, audio');
                        if (mediaElement) {
                            if (mediaElement.paused) {
                                mediaElement.play();
                            } else {
                                mediaElement.pause();
                            }
                        }
                    }
                });
            }
            
            function downloadFileUtil(fileUrl, fileName) {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            console.log("DEBUG: draft-contract.html çš„å†…è”è„šæœ¬ä¸»è¦é€»è¾‘æ‰§è¡Œå®Œæ¯•ã€‚");
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>